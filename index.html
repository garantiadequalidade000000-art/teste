<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Sequ√™ncia de NF-e/NFC-e</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Paleta de Cores: Baseado na Logo (Laranja Escuro) */
        :root {
            --cor-principal: #D9531E; /* Laranja Escuro (Mais profissional) */
            --cor-secundaria: #333; /* Cinza escuro para texto e detalhes (quase preto) */
            --cor-fundo: #f4f4f9;
            --cor-borda: #ddd;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            background-color: var(--cor-fundo);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho e Logo */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--cor-principal);
            padding-bottom: 10px;
        }

        header img {
            width: 50px; /* Ajuste o tamanho da logo conforme necess√°rio */
            height: auto;
        }
        
        header h1 {
            color: var(--cor-secundaria);
            font-size: 24pt;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        #drop-area { 
            border: 3px dashed var(--cor-borda); 
            background-color: #fff;
            padding: 30px; 
            text-align: center; 
            margin-bottom: 20px; 
            cursor: pointer; 
            transition: border-color 0.3s, background-color 0.3s;
            border-radius: 8px;
            font-size: 1.1em;
        }

        #drop-area.highlight {
            border-color: var(--cor-principal);
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        
        /* Bot√µes e Filtros */
        .controls-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            margin-bottom: 20px;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            background-color: var(--cor-principal);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        
        button:hover:not(:disabled) {
            background-color: #A34017; /* Tom mais escuro do laranja */
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Select de Filtros */
        #filterMod, #filterStatus, #filterCNPJ { /* Adicionado #filterCNPJ */
            padding: 10px;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
            background-color: #fff;
            color: var(--cor-secundaria);
        }
        
        /* Tabela */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid var(--cor-borda); 
            padding: 10px; 
            text-align: left; 
            font-size: 10pt; 
        }
        th { 
            background-color: var(--cor-principal); 
            color: white; 
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        /* Estilos de Status/Sequ√™ncia */
        .quebra-indicada { 
            color: var(--cor-principal); 
            font-weight: bold; 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .sem-quebra { 
            color: #1a8a25; /* Verde escuro para OK */
            font-weight: bold;
        }
        
        /* Estilo para notas canceladas/rejeitadas */
        .status-cancelada, .status-sem-autorizacao { 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .status-autorizada { 
            background-color: #effceb; 
        }
        
        /* Relat√≥rio para Exporta√ß√£o (PDF) */
        #relatorio-export { 
            padding: 10px; /* Reduz padding para mais espa√ßo */
            background-color: #fff; 
            font-family: Arial, sans-serif; /* Padr√£o para PDF */
            font-size: 10pt; /* Define um tamanho base menor para o PDF */
        }

        /* Tabela no PDF: Otimiza√ß√£o para evitar cortes */
        #relatorio-export table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 5px; 
            table-layout: fixed; /* For√ßa o layout da tabela a ser fixo */
        }
        
        /* *** AJUSTE PARA PDF: Fonte e Padding menor para caber mais informa√ß√£o *** */
        #relatorio-export th, #relatorio-export td { 
            padding: 5px; /* Reduz o padding das c√©lulas */
            font-size: 8pt; /* Tamanho da fonte menor nas c√©lulas */
            word-wrap: break-word; /* Permite quebrar palavras longas, √∫til para chaves */
        }
        
        /* Estilo para a coluna de Valor Total no PDF para garantir que caiba */
        #relatorio-export table tbody tr td:nth-child(5) { 
            /* Se as colunas no PDF forem: S√©rie, N√∫mero, Emiss√£o, CFOP, Valor Total, Status SEFAZ */
            /* A 5a coluna √© Valor Total */
            width: 15%; 
        }
        
        /* T√≠tulo do Relat√≥rio no PDF */
        .pdf-report-title {
            font-size: 18pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px double var(--cor-principal);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho do Grupo no PDF */
        .pdf-header { 
            font-size: 11pt; 
            font-weight: bold; 
            margin-top: 25px; 
            margin-bottom: 5px; 
            border-bottom: 2px solid var(--cor-principal); 
            padding-bottom: 5px; 
            color: var(--cor-secundaria);
        }
        
        /* Destaque para o valor total (PRETO E MENOR) */
        .total-geral {
            font-size: 16pt; 
            font-weight: bold;
            padding: 10px; 
            margin-top: 30px; 
            border: 2px solid var(--cor-secundaria); /* Borda preta */
            background-color: #f9f9f9; 
            border-radius: 5px; 
            text-align: right; 
            color: var(--cor-secundaria); /* Texto preto */
        }
        
        .total-geral span {
            font-size: 1.1em;
            color: #000;
        }

        /* Estilos do T√≠tulo do Grupo */
        #relatorio-completo h2 {
            font-size: 18pt;
            color: var(--cor-secundaria);
            margin-top: 40px;
            border-bottom: 1px solid var(--cor-borda);
            padding-bottom: 5px;
        }
        
        #relatorio-completo h3 {
            font-size: 14pt;
            color: var(--cor-principal);
            background-color: #f9f9f9;
            padding: 10px;
            border-left: 5px solid var(--cor-principal);
            margin-top: 30px;
            margin-bottom: 0;
        }
        
        /* Estilos para o Resumo */
        .resumo-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .resumo-table-container {
            flex: 1;
            min-width: 300px;
        }

        .resumo-table-container h4 {
            font-size: 12pt;
            color: var(--cor-secundaria);
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--cor-borda);
        }

        .resumo-table-container table {
            width: 100%;
            margin-top: 0;
            box-shadow: none;
        }
        
        .resumo-table-container th {
            background-color: #555; /* Cinza mais escuro */
        }
        
        /* Campo de Busca */
        #search-container {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #searchInput {
            padding: 10px;
            flex-grow: 1;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
        }
        
        /* Estilos para a nova se√ß√£o de downloads/filtros */
        .download-group, .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .download-group {
            margin-left: auto; /* Empurra para a direita */
        }
        
        /* --- Estilos para o Visualizador DANFE Simplificado (Modal) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none; /* Inicia oculto */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px 0;
        }

        .danfe-viewer-container {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .danfe-viewer-container h2 {
            color: var(--cor-principal);
            border-bottom: 2px solid var(--cor-principal);
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.5em;
            text-align: center;
        }

        .danfe-section-header {
            background-color: var(--cor-fundo);
            color: var(--cor-secundaria);
            padding: 5px 10px;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            border-left: 5px solid var(--cor-secundaria);
        }

        .danfe-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            padding: 5px 0;
        }

        .danfe-info-item {
            font-size: 0.9em;
            padding: 5px;
            border: 1px solid var(--cor-borda);
            border-radius: 4px;
        }

        .danfe-info-item strong {
            display: block;
            color: var(--cor-secundaria);
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 2px;
        }

        .danfe-produtos table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .danfe-produtos th, .danfe-produtos td {
            border: 1px solid var(--cor-borda);
            padding: 8px;
            font-size: 0.8em;
            text-align: left;
        }

        .danfe-produtos th {
            background-color: var(--cor-secundaria);
            color: white;
            text-transform: uppercase;
        }

        #close-danfe-viewer {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--cor-principal);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
        }

        #close-danfe-viewer:hover {
            background: #A34017;
        }

        .danfe-totais {
            text-align: right;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 20px;
            padding: 10px;
            border-top: 2px dashed var(--cor-borda);
        }

        .danfe-totais span {
            display: block;
            margin-top: 5px;
        }

    </style>
</head>
<body>

    <header>
        <img src="https://res.cloudinary.com/drsyomd2a/image/upload/v1762261454/Design-sem-nome_uxeex5.png" alt="Logo">
        <h1>Verificador de Quebra de Sequ√™ncia NF-e / NFC-e</h1>
        <div style="width: 50px;"></div> 
    </header>

    <div id="drop-area">
        Arraste e solte arquivos **XML** (ou clique para selecionar)<br>
        *Voc√™ pode adicionar arquivos de diferentes pastas consecutivamente.*
        <input type="file" id="fileElem" multiple accept=".xml" style="display: none;">
    </div>

    <div class="controls-container">
        <div class="action-group">
            <button onclick="processarNotas()" id="processButton" disabled>‚öôÔ∏è Processar e Verificar Sequ√™ncia</button>
            <button onclick="gerarRelatorioPDF()" id="pdfButton" disabled>üíæ Gerar PDF do Relat√≥rio</button>
            <button onclick="limparArquivos()" id="clearButton">üóëÔ∏è Limpar Arquivos</button>
        </div>

        <div class="download-group" id="downloadGroup" style="display: none;">
            <button onclick="compactarEBaixarXML('NFE')" id="downloadNFEButton">üì¶ Baixar XMLs NF-e</button>
            <button onclick="compactarEBaixarXML('NFCE')" id="downloadNFCEButton">üì¶ Baixar XMLs NFC-e</button>
        </div>
    </div>
    
    <h2>Relat√≥rio de Notas Fiscais (Visualiza√ß√£o Completa)</h2>
    
    <div id="filter-container" style="display: none;" class="controls-container">
        
        <div class="filter-group">
            <label for="filterCNPJ">CNPJ:</label>
            <select id="filterCNPJ" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todos os CNPJs</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filterMod">Tipo de Nota:</label>
            <select id="filterMod" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (NF-e e NFC-e)</option>
                <option value="55">Somente NF-e (Mod. 55)</option>
                <option value="65">Somente NFC-e (Mod. 65)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="filterStatus">Status SEFAZ:</label>
            <select id="filterStatus" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (Autorizadas/Canceladas/Rejeitadas)</option>
                <option value="AUTORIZADA">Somente AUTORIZADAS (100)</option>
                <option value="AUTORIZADA_FORA_PRAZO">Somente AUTORIZADAS FORA DO PRAZO (150)</option>
                <option value="NAO_AUTORIZADA">Somente CANCELADAS/REJEITADAS</option>
            </select>
        </div>
        <div id="search-container" style="display: none;">
            <input type="text" id="searchInput" placeholder="Buscar por Chave, Data, N√∫mero, CNPJ ou Valor..." onkeyup="filtrarTabela()">
            <button onclick="limparBusca()">Limpar Busca</button>
        </div>
    </div>
    
    <div id="resumo-container" style="display: none;" class="resumo-section">
        </div>
    
    <div id="relatorio-completo"> 
        <div id="relatorio-container">
            <p>Carregue os arquivos XML e clique em "Processar" para gerar o relat√≥rio.</p>
        </div>
    </div>

    <div id="danfe-viewer-modal" class="modal-overlay" onclick="fecharDetalhes(event)">
        <div class="danfe-viewer-container" onclick="event.stopPropagation()">
            <button id="close-danfe-viewer" onclick="fecharDetalhes(event)">‚úñ</button>
            <h2 id="danfe-titulo">DANFE Simplificado - Detalhes da Nota Fiscal</h2>
            <div id="danfe-conteudo">
                </div>
        </div>
    </div>

    <script>
        // Refer√™ncias aos elementos HTML
        const fileElem = document.getElementById('fileElem');
        const dropArea = document.getElementById('drop-area');
        const relatorioContainer = document.getElementById('relatorio-container');
        const resumoContainer = document.getElementById('resumo-container');
        const searchInput = document.getElementById('searchInput');
        // const searchContainer = document.getElementById('search-container'); // Agora est√° dentro de #filter-container
        const processButton = document.getElementById('processButton');
        const pdfButton = document.getElementById('pdfButton');
        const clearButton = document.getElementById('clearButton'); 
        
        // NOVO: Refer√™ncias aos novos elementos de filtro e download
        const filterContainer = document.getElementById('filter-container');
        const filterMod = document.getElementById('filterMod');
        const filterStatus = document.getElementById('filterStatus');
        const filterCNPJ = document.getElementById('filterCNPJ'); // NOVO: Refer√™ncia ao filtro CNPJ
        const downloadGroup = document.getElementById('downloadGroup');
        
        let notasFiscais = []; // Array que agora acumula as notas de todas as cargas
        let gruposGlobais = {}; 
        let arquivosXML = []; // NOVO: Armazena o conte√∫do e nome dos arquivos XML para compacta√ß√£o

        // Mapeamento de Forma de Pagamento (tPag)
        const formasPagamento = {
            '01': 'Dinheiro', '02': 'Cheque', '03': 'Cart√£o de Cr√©dito',
            '04': 'Cart√£o de D√©bito', '05': 'Cr√©dito Loja', '10': 'Vale Alimenta√ß√£o',
            '11': 'Vale Refei√ß√£o', '12': 'Vale Presente', '13': 'Vale Combust√≠vel',
            '14': 'Duplicata Mercantil', '15': 'Boleto Banc√°rio', '17': 'Pagamento Instant√¢neo (PIX)',
            '20': 'Pagamento Instant√¢neo (PIX)', '90': 'Sem Pagamento', '99': 'Outros'
        };

        // --- Configura√ß√£o de Arrastar e Soltar (Drag and Drop) ---

        ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileElem.click(), false);
        fileElem.addEventListener('change', (e) => handleFiles(e.target.files), false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        // --- Leitura e Parse dos Arquivos (AGORA ACUMULATIVO) ---

        function handleFiles(files) {
            
            pdfButton.disabled = true;
            filterContainer.style.display = 'none'; // Usa o novo container de filtros
            downloadGroup.style.display = 'none'; // Oculta o download de XMLs
            resumoContainer.style.display = 'none';
            processButton.disabled = true; // Desabilita o processar enquanto carrega os novos

            if (files.length === 0 && notasFiscais.length === 0) {
                processButton.disabled = true;
                return;
            }

            let arquivosCarregados = 0;
            const totalArquivos = files.length;
            
            // Exibe a mensagem de processamento
            relatorioContainer.innerHTML = `<p>Carregando ${totalArquivos} arquivos XML... 0%</p>`;
            
            const readerPromises = [];

            for (let i = 0; i < totalArquivos; i++) {
                const file = files[i];
                if (file.name.toLowerCase().endsWith('.xml')) {
                    const reader = new FileReader();

                    readerPromises.push(new Promise((resolve) => {
                        reader.onload = (e) => {
                            const xmlContent = e.target.result;
                            const nomeArquivo = file.name;
                            
                            // NOVO: Captura o conte√∫do do XML
                            try {
                                const parser = new DOMParser();
                                const xmlDoc = parser.parseFromString(xmlContent, "application/xml");
                                
                                // Campos obrigat√≥rios para Agrupamento/Sequ√™ncia
                                const nNF = safeInt(xmlDoc, 'nNF');
                                const mod = safeText(xmlDoc, 'mod');
                                const serie = safeText(xmlDoc, 'serie');
                                const CNPJ = safeText(xmlDoc, 'CNPJ');
                                const chaveAcesso = safeText(xmlDoc, 'chNFe') || safeText(xmlDoc, 'chNFCE'); // Chave de acesso √© crucial para duplicidade

                                if (nNF && mod && serie && CNPJ !== 'N/A' && chaveAcesso) {
                                    // 1. VERIFICA√á√ÉO DE DUPLICIDADE (CHAVE DE ACESSO)
                                    const isDuplicate = notasFiscais.some(n => n.chave === chaveAcesso);

                                    if (!isDuplicate) {
                                        // 2. ADI√á√ÉO DA NOVA NOTA E ARQUIVO
                                        const dhEmi = safeText(xmlDoc, 'dhEmi');
                                        const vNF = safeText(xmlDoc, 'vNF');
                                        const xFant = safeText(xmlDoc, 'xFant');
                                        const CFOP = safeText(xmlDoc, 'CFOP');
                                        const tPag = safeText(xmlDoc, 'tPag');
                                        const cStat = safeText(xmlDoc, 'cStat');
                                        const xMotivo = safeText(xmlDoc, 'xMotivo');
                                        
                                        const notaFiscal = {
                                            nNF: nNF,
                                            mod: mod,
                                            serie: serie,
                                            cnpj: CNPJ,
                                            chave: chaveAcesso,
                                            dhEmi: dhEmi,
                                            vNF: vNF,
                                            nomeFantasia: xFant,
                                            cfop: CFOP,
                                            tPag: tPag,
                                            cStat: cStat,
                                            xMotivo: xMotivo,
                                            xmlContent: xmlContent, // Armazena o conte√∫do do XML
                                            valorNumerico: safeFloat(vNF),
                                            statusAutorizacao: formatarStatus(cStat, xMotivo, xmlDoc)
                                        };

                                        notasFiscais.push(notaFiscal);
                                        
                                        // Armazena o XML para compacta√ß√£o futura
                                        arquivosXML.push({ 
                                            name: nomeArquivo, 
                                            content: xmlContent, 
                                            mod: mod, 
                                            cnpj: CNPJ,
                                            chave: chaveAcesso
                                        }); 
                                    }
                                }
                            } catch (e) {
                                console.error(`Erro ao processar o arquivo ${file.name}:`, e);
                            }

                            arquivosCarregados++;
                            const progresso = Math.round((arquivosCarregados / totalArquivos) * 100);
                            relatorioContainer.innerHTML = `<p>Carregando ${totalArquivos} arquivos XML... ${progresso}% (${arquivosCarregados}/${totalArquivos})</p>`;
                            
                            resolve();
                        };

                        reader.onerror = () => {
                            console.error(`Erro ao ler o arquivo: ${file.name}`);
                            arquivosCarregados++;
                            resolve();
                        };
                        
                        reader.readAsText(file);
                    }));
                }
            }

            Promise.all(readerPromises).then(() => {
                // Habilita o bot√£o Processar somente se houver notas v√°lidas carregadas
                processButton.disabled = notasFiscais.length === 0;
                
                if (notasFiscais.length > 0) {
                    relatorioContainer.innerHTML = `<p>‚úÖ ${notasFiscais.length} notas fiscais (XMLs) prontas para processamento. Clique em "Processar e Verificar Sequ√™ncia".</p>`;
                } else {
                    relatorioContainer.innerHTML = `<p>‚ö†Ô∏è Nenhum arquivo XML v√°lido ou n√£o foram encontrados novos arquivos (pode ser duplicidade). Por favor, verifique os arquivos e tente novamente.</p>`;
                }
            });
        }


        // --- FUN√á√ÉO PRINCIPAL DE PROCESSAMENTO (N√ÉO MUDOU) ---

        function processarNotas() {
            if (notasFiscais.length === 0) {
                alert("Nenhum arquivo XML v√°lido carregado.");
                return;
            }
            
            // 1. Agrupar as notas por CNPJ, Modelo (mod) e S√©rie
            const grupos = notasFiscais.reduce((acc, nota) => {
                // NOVO: Adiciona o tipo de nota no agrupamento
                const chaveGrupo = `${nota.cnpj}-${nota.mod}-${nota.serie}`;
                if (!acc[chaveGrupo]) {
                    acc[chaveGrupo] = { 
                        info: { 
                            cnpj: nota.cnpj, 
                            mod: nota.mod, 
                            serie: nota.serie, 
                            emitente: nota.nomeFantasia 
                        }, 
                        notas: [] 
                    };
                }
                acc[chaveGrupo].notas.push(nota);
                return acc;
            }, {});
            gruposGlobais = grupos; // Armazena grupos para uso na busca

            // 2. Verificar a sequ√™ncia dentro de cada grupo
            Object.values(grupos).forEach(grupo => {
                // √â crucial reordenar antes de verificar a sequ√™ncia, j√° que as notas s√£o acumuladas
                grupo.notas.sort((a, b) => a.nNF - b.nNF);

                let ultimaNfAutorizada = null;
                
                grupo.notas.forEach((nota, index) => {
                    // A l√≥gica de sequ√™ncia deve ser aplicada apenas a notas AUTORIZADAS (incluindo 150)
                    const isAutorizada = nota.statusAutorizacao.isAutorizada; // Usa a nova flag

                    if (!isAutorizada) {
                        // Adiciona a quebra/classe para o HTML, mas ignora na contagem da sequ√™ncia
                        nota.quebra = 'Ignorada (N√£o Autorizada/Cancelada)';
                        nota.quebraClass = '';
                        return;
                    }
                    
                    // Encontra a √∫ltima nota *autorizada* para compara√ß√£o
                    if (ultimaNfAutorizada === null) {
                        // √â a primeira nota autorizada do grupo
                        nota.quebra = 'In√≠cio da S√©rie';
                        nota.quebraClass = 'sem-quebra';
                        ultimaNfAutorizada = nota.nNF;
                    } else if (nota.nNF === ultimaNfAutorizada + 1) {
                        // Sequ√™ncia correta
                        nota.quebra = 'Sequ√™ncia OK';
                        nota.quebraClass = 'sem-quebra';
                        ultimaNfAutorizada = nota.nNF;
                    } else {
                        // Quebra na sequ√™ncia
                        const numEsperado = ultimaNfAutorizada + 1;
                        nota.quebra = `QUEBRA! N√∫mero esperado: ${numEsperado}`;
                        nota.quebraClass = 'quebra-indicada';
                        ultimaNfAutorizada = nota.nNF; // Atualiza para o n√∫mero atual para verificar o pr√≥ximo
                    }
                });
            });

            // 3. Gerar o Relat√≥rio HTML com os dados agrupados e verificados
            gerarRelatorioHTML(grupos);
            
            // 4. Recalcular e exibir os resumos
            gerarResumos(notasFiscais);

            // 5. Atualiza o filtro de CNPJ e busca
            popularFiltroCNPJ();

            // 6. Exibir bot√µes de filtro/exporta√ß√£o
            pdfButton.disabled = false;
            filterContainer.style.display = 'flex'; // Exibe o container de filtros
            document.getElementById('search-container').style.display = 'flex'; // Exibe a busca
            downloadGroup.style.display = 'flex'; // Exibe o download de XMLs
            resumoContainer.style.display = 'flex';
        }

        // --- Gera√ß√£o do Relat√≥rio HTML (ATUALIZADA com bot√£o Detalhes) ---

        function gerarRelatorioHTML(grupos) {
            let htmlCompleto = '';
            let totalGeral = 0;
            let temGrupoVisivel = false;
            
            // NOVO: Filtro de CNPJ √© aplicado aqui para otimizar o HTML gerado
            const cnpjFilter = filterCNPJ.value;
            
            Object.keys(grupos).sort().forEach(chaveGrupo => {
                const { info, notas } = grupos[chaveGrupo];
                const tipoNota = info.mod === '55' ? 'NF-e' : (info.mod === '65' ? 'NFC-e' : `Mod. ${info.mod}`); // NOVO: Tipo de nota

                // NOVO: Aplica o filtro de CNPJ no agrupamento
                if (cnpjFilter !== 'ALL' && info.cnpj !== cnpjFilter) {
                    return; // Ignora o grupo se n√£o corresponder ao filtro de CNPJ
                }

                temGrupoVisivel = true;
                
                // Adiciona o ID da chave do grupo na div de tabelas para facilitar a busca
                let htmlGrupo = `
                    <div id="table-group-${chaveGrupo}" data-mod="${info.mod}" data-cnpj="${info.cnpj}">
                        ${cnpjFilter === 'ALL' ? '' : `<h3>üßæ ${info.emitente} (CNPJ: ${info.cnpj}) - ${tipoNota} - S√©rie: ${info.serie}</h3>`}
                        <table id="table-${chaveGrupo}">
                            <thead>
                                <tr>
                                    <th>S√©rie</th>
                                    <th>N√∫mero</th>
                                    <th>Emiss√£o</th>
                                    <th>CFOP</th>
                                    <th>Forma Pag.</th>
                                    <th>Valor Total</th>
                                    <th>Chave de Acesso</th>
                                    <th>Status SEFAZ</th>
                                    <th>Status Sequ√™ncia</th>
                                    <th>Detalhes</th> </tr>
                            </thead>
                            <tbody>
                `;

                notas.forEach(nota => {
                    // Soma apenas as notas autorizadas (incluindo 150) para o total
                    if (nota.statusAutorizacao.isAutorizada) {
                        totalGeral += nota.valorNumerico;
                    }
                    
                    const quebraClass = nota.quebraClass || (nota.quebra.includes('QUEBRA') || nota.quebra.includes('Erro')) ? 'quebra-indicada' : 'sem-quebra';
                    const statusClasse = nota.statusAutorizacao.class;
                    
                    htmlGrupo += `
                        <tr 
                            class="${statusClasse}" 
                            data-mod="${nota.mod}" 
                            data-status="${nota.statusAutorizacao.text.split(' ')[0]}"
                            data-cnpj="${nota.cnpj}">
                            <td>${nota.serie}</td>
                            <td>${nota.nNF}</td>
                            <td>${nota.dhEmi.substring(0, 10)}</td>
                            <td>${nota.cfop || 'N/A'}</td>
                            <td>${formasPagamento[nota.tPag] || nota.tPag || 'N/A'}</td>
                            <td>${formatarValor(nota.valorNumerico)}</td>
                            <td title="${nota.chave}">${nota.chave.substring(0, 20)}...</td>
                            <td class="${statusClasse}">${nota.statusAutorizacao.text}</td>
                            <td class="${quebraClass}" title="${nota.quebra}">${nota.quebra.includes('QUEBRA') ? '‚ö†Ô∏è Quebra' : '‚úÖ OK'}</td>
                            <td><button onclick="mostrarDetalhes('${nota.chave}')" title="Visualizar DANFE Simplificado" style="padding: 5px 10px; font-size: 0.8em;">üîé</button></td> </tr>
                    `;
                });

                htmlGrupo += `
                            </tbody>
                        </table>
                    </div>
                `;
                htmlCompleto += htmlGrupo;
            });

            if (!temGrupoVisivel) {
                relatorioContainer.innerHTML = '<p>Nenhum grupo de notas encontrado com os filtros de CNPJ aplicados.</p>';
                return;
            }

            // Adiciona o total geral ao HTML
            htmlCompleto += `
                <div class="total-geral">
                    <span>VALOR TOTAL GERAL DAS NOTAS AUTORIZADAS: ${formatarValor(totalGeral)}</span>
                </div>
            `;

            relatorioContainer.innerHTML = htmlCompleto;
        }

        // --- Gera√ß√£o de Resumos (CFOP e Pagamento) --- 

        function gerarResumos(notas) {
            const resumoCFOP = {};
            const resumoPagamento = {};

            // NOVO: Filtrar as notas pelo CNPJ selecionado (se n√£o for 'ALL')
            const notasParaResumo = notas.filter(n => filterCNPJ.value === 'ALL' || n.cnpj === filterCNPJ.value);

            if (notasParaResumo.length === 0 && filterCNPJ.value !== 'ALL') {
                resumoContainer.innerHTML = `<p>Nenhuma nota fiscal encontrada para o CNPJ ${filterCNPJ.value} para gerar os resumos.</p>`;
                resumoContainer.style.display = 'flex';
                return;
            }

            notasParaResumo.forEach(nota => {
                // Apenas notas AUTORIZADAS (incluindo 150) para os resumos
                if (nota.statusAutorizacao.isAutorizada) {
                    // Resumo por CFOP
                    const cfopKey = nota.cfop;
                    resumoCFOP[cfopKey] = resumoCFOP[cfopKey] || { count: 0, total: 0 };
                    resumoCFOP[cfopKey].count++;
                    resumoCFOP[cfopKey].total += Math.round(nota.valorNumerico * 100); 

                    // Resumo por Forma de Pagamento (tPag)
                    const pagKey = nota.tPag;
                    resumoPagamento[pagKey] = resumoPagamento[pagKey] || { count: 0, total: 0, descricao: formasPagamento[pagKey] || pagKey };
                    resumoPagamento[pagKey].count++;
                    resumoPagamento[pagKey].total += Math.round(nota.valorNumerico * 100);
                }
            });

            // Converte os objetos para arrays e ordena por total (decrescente)
            const arrayCFOP = Object.entries(resumoCFOP)
                .map(([cfop, data]) => ({ cfop, ...data, total: data.total / 100 }))
                .sort((a, b) => b.total - a.total);
                
            const arrayPagamento = Object.entries(resumoPagamento)
                .map(([tPag, data]) => ({ tPag, ...data, total: data.total / 100 }))
                .sort((a, b) => b.total - a.total);

            // Monta o HTML do resumo
            let htmlResumoCFOP = '<h4>Resumo por CFOP (Notas Autorizadas)</h4><table><thead><tr><th>CFOP</th><th>Quantidade</th><th>Valor Total</th></tr></thead><tbody>';
            arrayCFOP.forEach(item => {
                htmlResumoCFOP += `<tr><td>${item.cfop}</td><td>${item.count}</td><td>${formatarValor(item.total)}</td></tr>`;
            });
            htmlResumoCFOP += '</tbody></table>';

            let htmlResumoPagamento = '<h4>Resumo por Forma de Pagamento (Notas Autorizadas)</h4><table><thead><tr><th>Pagamento</th><th>Quantidade</th><th>Valor Total</th></tr></thead><tbody>';
            arrayPagamento.forEach(item => {
                htmlResumoPagamento += `<tr><td>${item.descricao}</td><td>${item.count}</td><td>${formatarValor(item.total)}</td></tr>`;
            });
            htmlResumoPagamento += '</tbody></table>';

            resumoContainer.innerHTML = `
                <div class="resumo-table-container">${htmlResumoCFOP}</div>
                <div class="resumo-table-container">${htmlResumoPagamento}</div>
            `;
            resumoContainer.style.display = 'flex';
        }

        // --- Fun√ß√µes de Filtro e Busca (N√ÉO MUDOU) ---

        function aplicarFiltrosRelatorio() {
            // 1. Re-gera o Relat√≥rio HTML para garantir que o agrupamento de CNPJ seja filtrado
            // Re-gera a parte visual (tabelas e total) com o novo CNPJ
            gerarRelatorioHTML(gruposGlobais); // Vai ignorar grupos que n√£o batem com o filterCNPJ.value

            // 2. Recalcula e exibe os resumos se o CNPJ mudar (ou outros filtros, mas o CNPJ √© o mais relevante aqui).
            gerarResumos(notasFiscais); 

            // 3. Re-executa a busca para garantir que a combina√ß√£o de filtros funcione
            filtrarTabela(searchInput.value.toUpperCase()); // Aplica a busca e os filtros de Mod/Status/CNPJ nas TRs vis√≠veis
        }

        function filtrarTabela(filtroBusca = searchInput.value.toUpperCase()) {
            const filtroMod = filterMod.value;
            const filtroStatus = filterStatus.value;
            
            // Re-agrupa todas as tabelas vis√≠veis (j√° filtradas por CNPJ pelo gerarRelatorioHTML)
            const todasAsLinhas = document.querySelectorAll('#relatorio-completo table tbody tr');
            
            let totalFiltrado = 0;
            
            todasAsLinhas.forEach(row => {
                const modRow = row.getAttribute('data-mod');
                const statusRow = row.getAttribute('data-status');
                const cnpjGrupo = row.getAttribute('data-cnpj');
                
                let showRow = true;

                // 1. Aplica o filtro de Modelo (Mod)
                if (filtroMod !== 'ALL' && modRow !== filtroMod) {
                    showRow = false;
                }
                
                // 2. Aplica o filtro de Status SEFAZ
                if (showRow && filtroStatus !== 'ALL') {
                    if (filtroStatus === 'AUTORIZADA' && statusRow !== 'AUTORIZADA') {
                        showRow = false;
                    } else if (filtroStatus === 'AUTORIZADA_FORA_PRAZO' && statusRow !== 'AUTORIZADA_FORA_PRAZO') {
                        showRow = false;
                    } else if (filtroStatus === 'NAO_AUTORIZADA' && (statusRow === 'AUTORIZADA' || statusRow === 'AUTORIZADA_FORA_PRAZO')) {
                        showRow = false;
                    }
                }
                
                // 3. Aplica o filtro de busca textual/CNPJ
                if (showRow && filtroBusca !== '') {
                    let matchesSearch = false;
                    // Verifica se o CNPJ do grupo corresponde ao filtro de busca
                    if (cnpjGrupo && cnpjGrupo.toUpperCase().indexOf(filtroBusca) > -1) {
                        matchesSearch = true;
                    } else {
                        // Percorre todas as c√©lulas (td) da linha
                        for (let j = 0; j < row.cells.length; j++) {
                            const td = row.cells[j];
                            if (td) {
                                const text = td.textContent || td.innerText;
                                if (text.toUpperCase().indexOf(filtroBusca) > -1) {
                                    matchesSearch = true;
                                    break;
                                }
                            }
                        }
                    }
                    // A linha s√≥ deve ser mostrada se passar pelos filtros E pela busca
                    showRow = showRow && matchesSearch;
                }

                row.style.display = showRow ? "" : "none";
                
                // Soma o total das notas vis√≠veis (e autorizadas)
                if (showRow) {
                    // Verifica se a nota √© autorizada antes de somar ao total filtrado
                    const isAutorizada = row.querySelector('.status-autorizada');
                    if (isAutorizada) {
                         // A 6¬™ c√©lula (√≠ndice 5) √© o Valor Total
                        const valorText = row.cells[5].textContent; 
                        const valorNumerico = parseFloat(valorText.replace('R$', '').replace('.', '').replace(',', '.'));
                        if (!isNaN(valorNumerico)) {
                            totalFiltrado += valorNumerico;
                        }
                    }
                }
            });

            // NOVO: Adiciona o total novamente (que agora calcula baseado no filtro de CNPJ)
            const totalGeralElement = document.querySelector('.total-geral');
            if (totalGeralElement) {
                totalGeralElement.innerHTML = `<span>VALOR TOTAL GERAL VIS√çVEL (Autorizadas): ${formatarValor(totalFiltrado)}</span>`;
            }
        }

        // --- Fun√ß√µes Auxiliares (ATUALIZADAS/NOVAS) ---
        
        // ... [formatarDataParaTitulo, obterNomeFantasiaPrincipal, obterPeriodoEmissaoPrincipal, popularFiltroCNPJ, limparBusca, formatarValor e safeText/safeInt/safeFloat sem altera√ß√£o] ...
        
        /**
         * Formata um valor num√©rico para o padr√£o de moeda brasileira (R$ X.XXX,XX).
         */
        function formatarValor(valor) {
            if (valor === undefined || valor === null || isNaN(parseFloat(valor))) {
                return 'R$ 0,00';
            }
            const numero = parseFloat(valor);
            return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        /**
         * Formata um valor num√©rico (quantidade) para o padr√£o brasileiro (X.XXX,XX).
         * √â usado para Qtd. (qCom) e Vl. Unit√°rio (vUnCom) no DANFE.
         * @param {string} valor O valor string a ser formatado.
         * @returns {string} O valor formatado.
         */
        function formatarValorQtd(valor) {
            if (valor === undefined || valor === null || isNaN(parseFloat(valor))) {
                return '0';
            }
            const numero = parseFloat(valor);
            // Formata com m√≠nimo de 2 e m√°ximo de 4 casas decimais para Qtd e Vl. Unit√°rio
            return numero.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 4 });
        }
        
        /**
         * Extrai os detalhes completos do XML para a visualiza√ß√£o simplificada.
         * @param {string} xmlContent O conte√∫do XML bruto.
         * @returns {object|null} Objeto com os detalhes extra√≠dos ou null em caso de erro.
         */
        function extrairDetalhesDanfe(xmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "application/xml");

                // Fun√ß√µes auxiliares para buscar dados espec√≠ficos
                const safeTextDanfe = (path) => {
                    // Busca tanto na NFe (v4.00) quanto na NFCe (v4.00)
                    const element = xmlDoc.querySelector(path);
                    return element && element.textContent ? element.textContent.trim() : 'N/A';
                };
                const safeFloatDanfe = (path) => {
                    const text = safeTextDanfe(path);
                    return text !== 'N/A' ? parseFloat(text) : 0;
                };

                const detalhes = {};

                // 1. Dados da NF-e/NFC-e
                detalhes.modelo = safeTextDanfe('ide mod');
                detalhes.tipoNota = detalhes.modelo === '55' ? 'Nota Fiscal Eletr√¥nica (NF-e)' : (detalhes.modelo === '65' ? 'Nota Fiscal de Consumidor Eletr√¥nica (NFC-e)' : `Modelo ${detalhes.modelo}`);
                detalhes.chaveAcesso = safeTextDanfe('chNFe, chNFCE');
                detalhes.nNF = safeTextDanfe('ide nNF');
                detalhes.serie = safeTextDanfe('ide serie');
                detalhes.dhEmi = safeTextDanfe('ide dhEmi');
                detalhes.cStat = safeTextDanfe('cStat');
                detalhes.xMotivo = safeTextDanfe('xMotivo');
                detalhes.statusSefaz = detalhes.cStat + ' - ' + detalhes.xMotivo;
                detalhes.tPag = safeTextDanfe('detPag tPag');
                detalhes.formaPagamento = formasPagamento[detalhes.tPag] || detalhes.tPag || 'N/A';
                
                // 2. Emitente (Emit)
                detalhes.emitente = {
                    razaoSocial: safeTextDanfe('emit xNome'),
                    cnpj: safeTextDanfe('emit CNPJ'),
                    endereco: safeTextDanfe('emit enderEmit xLgr') + ', ' + safeTextDanfe('emit enderEmit nro'),
                    municipio: safeTextDanfe('emit enderEmit xMun') + '/' + safeTextDanfe('emit enderEmit UF')
                };
                // Limpeza b√°sica se o endere√ßo n√£o for encontrado
                if (detalhes.emitente.endereco.trim() === ',') detalhes.emitente.endereco = 'N/A';
                if (detalhes.emitente.municipio.trim() === '/') detalhes.emitente.municipio = 'N/A';
                
                // 3. Destinat√°rio (Dest)
                detalhes.destinatario = {
                    razaoSocial: safeTextDanfe('dest xNome') || 'CONSUMIDOR FINAL (Sem Identifica√ß√£o)',
                    cpfCnpj: safeTextDanfe('dest CPF') || safeTextDanfe('dest CNPJ') || 'N/A',
                    endereco: safeTextDanfe('dest enderDest xLgr') + ', ' + safeTextDanfe('dest enderDest nro'),
                    municipio: safeTextDanfe('dest enderDest xMun') + '/' + safeTextDanfe('dest enderDest UF')
                };
                if (detalhes.destinatario.endereco.trim() === ',') detalhes.destinatario.endereco = 'N/A';
                if (detalhes.destinatario.municipio.trim() === '/') detalhes.destinatario.municipio = 'N/A';
                
                // 4. Totais
                detalhes.totais = {
                    vProd: safeFloatDanfe('ICMSTot vProd'),
                    vFrete: safeFloatDanfe('ICMSTot vFrete'),
                    vOutros: safeFloatDanfe('ICMSTot vOutro'),
                    vDesc: safeFloatDanfe('ICMSTot vDesc'),
                    vNF: safeFloatDanfe('ICMSTot vNF'),
                    vICMS: safeFloatDanfe('ICMSTot vICMS'),
                    vICMSST: safeFloatDanfe('ICMSTot vICMSST')
                };
                
                // 5. Produtos
                detalhes.produtos = [];
                const itens = xmlDoc.querySelectorAll('det');
                itens.forEach(item => {
                    const prod = item.querySelector('prod');
                    const imposto = item.querySelector('imposto');
                    
                    const produto = {
                        cProd: prod.querySelector('cProd')?.textContent || 'N/A',
                        xProd: prod.querySelector('xProd')?.textContent || 'N/A',
                        qCom: prod.querySelector('qCom')?.textContent || '0',
                        vUnCom: prod.querySelector('vUnCom')?.textContent || '0',
                        vProd: prod.querySelector('vProd')?.textContent || '0',
                        CFOP: prod.querySelector('CFOP')?.textContent || 'N/A',
                    };
                    detalhes.produtos.push(produto);
                });

                return detalhes;

            } catch (error) {
                console.error("Erro ao extrair detalhes do DANFE:", error);
                return null;
            }
        }


        /**
         * Encontra a nota e exibe o modal do DANFE Simplificado.
         * @param {string} chaveAcesso A chave de 44 d√≠gitos da nota.
         */
        function mostrarDetalhes(chaveAcesso) {
            const nota = notasFiscais.find(n => n.chave === chaveAcesso);
            const modal = document.getElementById('danfe-viewer-modal');
            const danfeConteudo = document.getElementById('danfe-conteudo');
            const danfeTitulo = document.getElementById('danfe-titulo');

            if (!nota) {
                alert("Nota fiscal n√£o encontrada nos arquivos carregados.");
                return;
            }

            const detalhes = extrairDetalhesDanfe(nota.xmlContent);

            if (!detalhes) {
                danfeConteudo.innerHTML = `<p style="color: ${getComputedStyle(document.documentElement).getPropertyValue('--cor-principal')}">N√£o foi poss√≠vel processar o XML para extrair os detalhes.</p>`;
                modal.style.display = 'flex';
                return;
            }

            danfeTitulo.textContent = `${detalhes.tipoNota} (Mod. ${detalhes.modelo}) - N¬∞ ${detalhes.nNF}/${detalhes.serie}`;

            // 1. Informa√ß√µes B√°sicas
            let htmlContent = `
                <div class="danfe-section-header">INFORMA√á√ïES GERAIS</div>
                <div class="danfe-info-grid">
                    <div class="danfe-info-item"><strong>CHAVE DE ACESSO</strong> ${detalhes.chaveAcesso}</div>
                    <div class="danfe-info-item"><strong>DATA DE EMISS√ÉO</strong> ${detalhes.dhEmi.substring(0, 10)}</div>
                    <div class="danfe-info-item"><strong>STATUS SEFAZ</strong> <span style="font-weight: bold; color: ${detalhes.cStat === '100' ? '#1a8a25' : (detalhes.cStat === '150' ? '#D9531E' : '#333')}">${detalhes.statusSefaz}</span></div>
                    <div class="danfe-info-item"><strong>FORMA DE PAGAMENTO</strong> ${detalhes.formaPagamento}</div>
                </div>
            `;
            
            // 2. Emitente
            htmlContent += `
                <div class="danfe-section-header">EMITENTE</div>
                <div class="danfe-info-grid">
                    <div class="danfe-info-item"><strong>RAZ√ÉO SOCIAL</strong> ${detalhes.emitente.razaoSocial}</div>
                    <div class="danfe-info-item"><strong>CNPJ</strong> ${detalhes.emitente.cnpj}</div>
                    <div class="danfe-info-item" style="grid-column: span 2;"><strong>ENDERE√áO</strong> ${detalhes.emitente.endereco} - ${detalhes.emitente.municipio}</div>
                </div>
            `;

            // 3. Destinat√°rio (Apenas se CPF/CNPJ ou Raz√£o Social for diferente de 'CONSUMIDOR FINAL')
            if (detalhes.destinatario.cpfCnpj !== 'N/A' || detalhes.destinatario.razaoSocial !== 'CONSUMIDOR FINAL (Sem Identifica√ß√£o)') {
                htmlContent += `
                    <div class="danfe-section-header">DESTINAT√ÅRIO</div>
                    <div class="danfe-info-grid">
                        <div class="danfe-info-item"><strong>NOME/RAZ√ÉO SOCIAL</strong> ${detalhes.destinatario.razaoSocial}</div>
                        <div class="danfe-info-item"><strong>CPF/CNPJ</strong> ${detalhes.destinatario.cpfCnpj}</div>
                        <div class="danfe-info-item" style="grid-column: span 2;"><strong>ENDERE√áO</strong> ${detalhes.destinatario.endereco} - ${detalhes.destinatario.municipio}</div>
                    </div>
                `;
            }

            // 4. Produtos
            htmlContent += `
                <div class="danfe-section-header">PRODUTOS E SERVI√áOS (${detalhes.produtos.length} itens)</div>
                <div class="danfe-produtos">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥d.</th>
                                <th>Descri√ß√£o do Produto/Servi√ßo</th>
                                <th>CFOP</th>
                                <th style="text-align: right;">Qtd.</th>
                                <th style="text-align: right;">Vl. Unit√°rio</th>
                                <th style="text-align: right;">Vl. Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            detalhes.produtos.forEach(p => {
                htmlContent += `
                    <tr>
                        <td>${p.cProd}</td>
                        <td>${p.xProd}</td>
                        <td>${p.CFOP}</td>
                        <td style="text-align: right;">${formatarValorQtd(p.qCom)}</td>
                        <td style="text-align: right;">${formatarValor(p.vUnCom)}</td>
                        <td style="text-align: right;">${formatarValor(p.vProd)}</td>
                    </tr>
                `;
            });

            htmlContent += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // 5. Totais
            htmlContent += `
                <div class="danfe-section-header">TOTAIS DA NOTA</div>
                <div class="danfe-info-grid">
                    <div class="danfe-info-item"><strong>VALOR DOS PRODUTOS</strong> ${formatarValor(detalhes.totais.vProd)}</div>
                    <div class="danfe-info-item"><strong>VALOR DO FRETE</strong> ${formatarValor(detalhes.totais.vFrete)}</div>
                    <div class="danfe-info-item"><strong>OUTRAS DESPESAS</strong> ${formatarValor(detalhes.totais.vOutros)}</div>
                    <div class="danfe-info-item"><strong>VALOR DO DESCONTO</strong> ${formatarValor(detalhes.totais.vDesc)}</div>
                    <div class="danfe-info-item"><strong>VALOR ICMS</strong> ${formatarValor(detalhes.totais.vICMS)}</div>
                    <div class="danfe-info-item"><strong>VALOR ICMS ST</strong> ${formatarValor(detalhes.totais.vICMSST)}</div>
                </div>

                <div class="danfe-totais">
                    <span>VALOR TOTAL DA NOTA (R$): ${formatarValor(detalhes.totais.vNF)}</span>
                </div>
            `;

            danfeConteudo.innerHTML = htmlContent;
            modal.style.display = 'flex';
        }

        /**
         * Fecha o modal de visualiza√ß√£o do DANFE.
         * @param {Event} event O evento de clique.
         */
        function fecharDetalhes(event) {
            // Verifica se o clique foi no overlay (fundo escuro) ou no bot√£o de fechar (X)
            if (event.target === document.getElementById('danfe-viewer-modal') || event.target.id === 'close-danfe-viewer') {
                document.getElementById('danfe-viewer-modal').style.display = 'none';
            }
        }
        
        // --- FUN√á√ïES AUXILIARES DE LEITURA E FORMATA√á√ÉO (SEM ALTERA√á√ïES SIGNIFICATIVAS NESTA PARTE) ---
        
        function limparArquivos() {
            // Reinicia o estado da aplica√ß√£o
            notasFiscais = [];
            gruposGlobais = {};
            arquivosXML = []; // NOVO: Limpa o array de arquivos XML

            // Reseta o estado dos bot√µes e containers
            processButton.disabled = true;
            pdfButton.disabled = true;
            filterContainer.style.display = 'none'; // Oculta o container de filtros
            downloadGroup.style.display = 'none'; // Oculta o download de XMLs
            searchInput.value = '';
            filterMod.value = 'ALL'; // Reseta filtros
            filterStatus.value = 'ALL'; // Reseta filtros
            filterCNPJ.value = 'ALL'; // NOVO: Reseta filtro CNPJ
            filterCNPJ.innerHTML = '<option value="ALL">Todos os CNPJs</option>'; // Limpa op√ß√µes de CNPJ
            relatorioContainer.innerHTML = '<p>Todos os arquivos foram removidos. Arraste e solte ou clique para carregar novos arquivos XML.</p>';
        }

        function safeText(xmlDoc, tagName) {
            let element;
            // Tratamento especial para CFOP (dentro de det/prod)
            if (tagName === 'CFOP') {
                // Procura por <det><prod><CFOP> ou <det><CFOP>
                element = xmlDoc.querySelector('det prod CFOP, det CFOP');
                if (element) return element.textContent;
                // Busca em cada item de produto, retorna o primeiro encontrado
            }
            // Procura a tag dentro da NFe/NFCE (padr√£o)
            element = xmlDoc.querySelector('infNFe ' + tagName + ', infNFCE ' + tagName + ', procNFe ' + tagName + ', procNFCE ' + tagName);

            // Procura a tag dentro de grupos espec√≠ficos para CNPJ/chave
            if (!element) {
                element = xmlDoc.querySelector('emit CNPJ');
                if (tagName === 'CNPJ' && element) return element.textContent;
                element = xmlDoc.querySelector('chNFe, chNFCE');
                if (tagName === 'chNFe' && element) return element.textContent;
            }
            
            // Tratamento especial para Valor Total (vNF)
            if (tagName === 'vNF') {
                element = xmlDoc.querySelector('ICMSTot vNF');
            }
            
            // Tratamento especial para Forma de Pagamento (tPag)
            if (tagName === 'tPag') {
                 element = xmlDoc.querySelector('detPag tPag');
            }
            
            // Tratamento especial para Nome Fantasia (xFant)
            if (tagName === 'xFant') {
                element = xmlDoc.querySelector('emit xFant');
            }

            if (element) return element.textContent;
            return 'N/A';
        }

        function safeInt(xmlDoc, tagName) {
            const text = safeText(xmlDoc, tagName);
            const num = parseInt(text);
            return isNaN(num) ? null : num;
        }

        function safeFloat(tagName) {
            const text = tagName;
            const num = parseFloat(text);
            return isNaN(num) ? 0 : num;
        }

        function formatarStatus(cStat, xMotivo, xmlDoc) {
            const eventType = xmlDoc.querySelector('tpEvento');
            const cStatEvento = xmlDoc.querySelector('retEvento cStat');
            // const xMotivoEvento = xmlDoc.querySelector('retEvento xMotivo');

            // Verifica se √© um evento de Cancelamento (cStat 135)
            if (eventType && eventType.textContent === '110111') {
                if (cStatEvento && cStatEvento.textContent === '135') {
                    return { text: 'CANCELADA (Evento 135)', class: 'status-cancelada', isAutorizada: false, isAutorizadaForaPrazo: false }; 
                }
            }

            if (cStat) {
                switch(cStat) {
                    case '100':
                        return { text: 'AUTORIZADA', class: 'status-autorizada', isAutorizada: true, isAutorizadaForaPrazo: false };
                    case '150':
                         return { text: 'AUTORIZADA FORA DO PRAZO', class: 'status-autorizada', isAutorizada: true, isAutorizadaForaPrazo: true };
                    case '101':
                    case '151':
                        return { text: 'CANCELADA', class: 'status-cancelada', isAutorizada: false, isAutorizadaForaPrazo: false };
                    case '110':
                        return { text: 'Uso Denegado', class: 'status-sem-autorizacao', isAutorizada: false, isAutorizadaForaPrazo: false };
                    case '204': // Rejei√ß√£o: Duplicidade
                        return { text: 'Rejei√ß√£o (Duplicidade)', class: 'status-sem-autorizacao', isAutorizada: false, isAutorizadaForaPrazo: false };
                    default:
                        if (cStat >= '200' && cStat <= '999') {
                             return { text: `Rejei√ß√£o: ${cStat} - ${xMotivo}`, class: 'status-sem-autorizacao', isAutorizada: false, isAutorizadaForaPrazo: false };
                        }
                        return { text: `Status Desconhecido: ${cStat}`, class: 'status-sem-autorizacao', isAutorizada: false, isAutorizadaForaPrazo: false };
                }
            }
            // Se cStat n√£o for encontrado (ex: XML sem retorno da SEFAZ)
             return { text: 'Sem Autoriza√ß√£o (XML Bruto)', class: 'status-sem-autorizacao', isAutorizada: false, isAutorizadaForaPrazo: false };
        }
        
        function formatarDataParaTitulo(data) {
            const y = data.getFullYear();
            const m = String(data.getMonth() + 1).padStart(2, '0');
            const d = String(data.getDate()).padStart(2, '0');
            return `${y}${m}${d}`;
        }

        function obterNomeFantasiaPrincipal() {
            // ATUALIZA√á√ÉO: Retorna 'Empresa' se o filtro for ALL
            if (filterCNPJ.value === 'ALL') {
                return 'Empresa';
            }
            // Considera apenas notas do CNPJ filtrado.
            const notasFiltradas = notasFiscais.filter(n => n.cnpj === filterCNPJ.value);
            if (notasFiltradas.length === 0) return 'Empresa';

            const contagem = notasFiltradas.reduce((acc, nota) => {
                const nome = nota.nomeFantasia;
                acc[nome] = (acc[nome] || 0) + 1;
                return acc;
            }, {});

            let nomePrincipal = 'Empresa';
            let maxCount = 0;
            for (const nome in contagem) {
                if (contagem[nome] > maxCount) {
                    maxCount = contagem[nome];
                    nomePrincipal = nome;
                }
            }
            // Remove espa√ßos e substitui por underscore para o nome do arquivo
            return nomePrincipal.replace(/\s/g, '_');
        }

        function obterPeriodoEmissaoPrincipal() {
            // NOVO: Considera apenas notas do CNPJ filtrado.
            const notasParaPeriodo = notasFiscais.filter(n => filterCNPJ.value === 'ALL' || n.cnpj === filterCNPJ.value);

            if (notasParaPeriodo.length === 0) return formatarDataParaTitulo(new Date());

            const datas = notasParaPeriodo.map(n => new Date(n.dhEmi.substring(0, 10)));
            const dataMin = new Date(Math.min(...datas));
            const dataMax = new Date(Math.max(...datas));
            
            const anoMin = dataMin.getFullYear();
            const mesMin = String(dataMin.getMonth() + 1).padStart(2, '0');
            const anoMax = dataMax.getFullYear();
            const mesMax = String(dataMax.getMonth() + 1).padStart(2, '0');

            if (anoMin === anoMax && mesMin === mesMax) {
                return `${anoMin}${mesMin}`;
            } else {
                return `${anoMin}${mesMin}-a-${anoMax}${mesMax}`;
            }
        }
        
        function popularFiltroCNPJ() {
            const cnpjs = [...new Set(notasFiscais.map(n => n.cnpj))].sort();
            const select = document.getElementById('filterCNPJ');
            select.innerHTML = '<option value="ALL">Todos os CNPJs</option>';
            cnpjs.forEach(cnpj => {
                const nomeFantasia = notasFiscais.find(n => n.cnpj === cnpj)?.nomeFantasia || cnpj;
                const option = document.createElement('option');
                option.value = cnpj;
                option.textContent = `${cnpj} - ${nomeFantasia}`;
                select.appendChild(option);
            });
        }
        
        // --- FUN√á√ïES DE DOWNLOAD (N√ÉO MUDOU) ---
        
        function limparBusca() {
            searchInput.value = '';
            filtrarTabela('');
        }
        
        function gerarRelatorioPDF() {
            // ... [L√≥gica para gerar PDF] ...
        }

        function compactarEBaixarXML(tipo) {
            // ... [L√≥gica para compactar e baixar XMLs] ...
        }
        
    </script>
</body>
</html>
