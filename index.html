<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Sequ√™ncia de NF-e/NFC-e</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Paleta de Cores: Baseado na Logo (Laranja Escuro) */
        :root {
            --cor-principal: #D9531E; /* Laranja Escuro (Mais profissional) */
            --cor-secundaria: #333; /* Cinza escuro para texto e detalhes (quase preto) */
            --cor-fundo: #f4f4f9;
            --cor-borda: #ddd;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            background-color: var(--cor-fundo);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho e Logo */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--cor-principal);
            padding-bottom: 10px;
        }

        header img {
            width: 50px; /* Ajuste o tamanho da logo conforme necess√°rio */
            height: auto;
        }
        
        header h1 {
            color: var(--cor-secundaria);
            font-size: 24pt;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        #drop-area { 
            border: 3px dashed var(--cor-borda); 
            background-color: #fff;
            padding: 30px; 
            text-align: center; 
            margin-bottom: 20px; 
            cursor: pointer; 
            transition: border-color 0.3s, background-color 0.3s;
            border-radius: 8px;
            font-size: 1.1em;
        }

        #drop-area.highlight {
            border-color: var(--cor-principal);
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        
        /* Bot√µes e Filtros */
        .controls-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            margin-bottom: 20px;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            background-color: var(--cor-principal);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        
        button:hover:not(:disabled) {
            background-color: #A34017; /* Tom mais escuro do laranja */
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Select de Filtros */
        #filterMod, #filterStatus, #filterCNPJ { /* Adicionado #filterCNPJ */
            padding: 10px;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
            background-color: #fff;
            color: var(--cor-secundaria);
        }
        
        /* Tabela */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid var(--cor-borda); 
            padding: 10px; 
            text-align: left; 
            font-size: 10pt; 
        }
        th { 
            background-color: var(--cor-principal); 
            color: white; 
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        /* Estilos de Status/Sequ√™ncia */
        .quebra-indicada { 
            color: var(--cor-principal); 
            font-weight: bold; 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .sem-quebra { 
            color: #1a8a25; /* Verde escuro para OK */
            font-weight: bold;
        }
        
        /* Estilo para notas canceladas/rejeitadas */
        .status-cancelada, .status-sem-autorizacao { 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .status-autorizada { 
            background-color: #effceb; 
        }
        
        /* Relat√≥rio para Exporta√ß√£o (PDF) */
        #relatorio-export { 
            padding: 10px; /* Reduz padding para mais espa√ßo */
            background-color: #fff; 
            font-family: Arial, sans-serif; /* Padr√£o para PDF */
            font-size: 10pt; /* Define um tamanho base menor para o PDF */
        }

        /* Tabela no PDF: Otimiza√ß√£o para evitar cortes */
        #relatorio-export table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 5px; 
            table-layout: fixed; /* For√ßa o layout da tabela a ser fixo */
        }
        
        /* *** AJUSTE PARA PDF: Fonte e Padding menor para caber mais informa√ß√£o *** */
        #relatorio-export th, #relatorio-export td { 
            padding: 5px; /* Reduz o padding das c√©lulas */
            font-size: 8pt; /* Tamanho da fonte menor nas c√©lulas */
            word-wrap: break-word; /* Permite quebrar palavras longas, √∫til para chaves */
        }
        
        /* Estilo para a coluna de Valor Total no PDF para garantir que caiba */
        #relatorio-export table tbody tr td:nth-child(5) { 
            /* Se as colunas no PDF forem: S√©rie, N√∫mero, Emiss√£o, CFOP, Valor Total, Status SEFAZ */
            /* A 5a coluna √© Valor Total */
            width: 15%; 
        }
        
        /* T√≠tulo do Relat√≥rio no PDF */
        .pdf-report-title {
            font-size: 18pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px double var(--cor-principal);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho do Grupo no PDF */
        .pdf-header { 
            font-size: 11pt; 
            font-weight: bold; 
            margin-top: 25px; 
            margin-bottom: 5px; 
            border-bottom: 2px solid var(--cor-principal); 
            padding-bottom: 5px; 
            color: var(--cor-secundaria);
        }
        
        /* Destaque para o valor total (PRETO E MENOR) */
        .total-geral {
            font-size: 16pt; 
            font-weight: bold;
            padding: 10px; 
            margin-top: 30px; 
            border: 2px solid var(--cor-secundaria); /* Borda preta */
            background-color: #f9f9f9; 
            border-radius: 5px; 
            text-align: right; 
            color: var(--cor-secundaria); /* Texto preto */
        }
        
        .total-geral span {
            font-size: 1.1em;
            color: #000;
        }

        /* Estilos do T√≠tulo do Grupo */
        #relatorio-completo h2 {
            font-size: 18pt;
            color: var(--cor-secundaria);
            margin-top: 40px;
            border-bottom: 1px solid var(--cor-borda);
            padding-bottom: 5px;
        }
        
        #relatorio-completo h3 {
            font-size: 14pt;
            color: var(--cor-principal);
            background-color: #f9f9f9;
            padding: 10px;
            border-left: 5px solid var(--cor-principal);
            margin-top: 30px;
            margin-bottom: 0;
        }
        
        /* Estilos para o Resumo */
        .resumo-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .resumo-table-container {
            flex: 1;
            min-width: 300px;
        }

        .resumo-table-container h4 {
            font-size: 12pt;
            color: var(--cor-secundaria);
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--cor-borda);
        }

        .resumo-table-container table {
            width: 100%;
            margin-top: 0;
            box-shadow: none;
        }
        
        .resumo-table-container th {
            background-color: #555; /* Cinza mais escuro */
        }
        
        /* Campo de Busca */
        #search-container {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #searchInput {
            padding: 10px;
            flex-grow: 1;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
        }
        
        /* Estilos para a nova se√ß√£o de downloads/filtros */
        .download-group, .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .download-group {
            margin-left: auto; /* Empurra para a direita */
        }

        /* --- NOVO: Estilos para o Modal de Detalhes do XML (DANFE Simplificado) --- */
        .modal-detalhes {
            display: none; /* Hidden by default */
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); /* Fundo escurecido */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 5% do topo e centralizado */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 1200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.3s;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--cor-principal);
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Estilos do Conte√∫do do DANFE Simplificado */
        .danfe-simples {
            padding: 10px;
            font-size: 9pt;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
        }
        
        .danfe-header, .danfe-section-title {
            background-color: var(--cor-principal);
            color: white;
            padding: 5px 10px;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 10pt;
        }
        
        .danfe-data {
            display: flex;
            flex-wrap: wrap;
            border: 1px solid var(--cor-borda);
            margin-bottom: 10px;
        }
        
        .danfe-field {
            flex: 1 1 200px; /* Campo flex√≠vel, m√≠nimo de 200px de largura */
            padding: 5px 10px;
            border-right: 1px solid var(--cor-borda);
            border-bottom: 1px solid var(--cor-borda);
        }

        .danfe-field:last-child {
            border-right: none;
        }
        
        .danfe-field span {
            display: block;
            font-weight: bold;
            color: var(--cor-secundaria);
        }
        
        /* Tabela de Produtos */
        .danfe-products table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8pt;
            margin-bottom: 10px;
            box-shadow: none;
        }
        
        .danfe-products th, .danfe-products td {
            border: 1px solid var(--cor-borda);
            padding: 4px;
            text-align: left;
        }

        .danfe-products th {
            background-color: #555;
            color: white;
            font-size: 8pt;
        }
    </style>
</head>
<body>

    <header>
        <img src="https://res.cloudinary.com/drsyomd2a/image/upload/v1762261454/Design-sem-nome_uxeex5.png" alt="Logo">
        <h1>Verificador de Quebra de Sequ√™ncia NF-e / NFC-e</h1>
        <div style="width: 50px;"></div> 
    </header>

    <div id="drop-area">
        Arraste e solte arquivos **XML** (ou clique para selecionar)<br>
        *Voc√™ pode adicionar arquivos de diferentes pastas consecutivamente.*
        <input type="file" id="fileElem" multiple accept=".xml" style="display: none;">
    </div>

    <div class="controls-container">
        <div class="action-group">
            <button onclick="processarNotas()" id="processButton" disabled>‚öôÔ∏è Processar e Verificar Sequ√™ncia</button>
            <button onclick="gerarRelatorioPDF()" id="pdfButton" disabled>üíæ Gerar PDF do Relat√≥rio</button>
            <button onclick="limparArquivos()" id="clearButton">üóëÔ∏è Limpar Arquivos</button>
        </div>

        <div class="download-group" id="downloadGroup" style="display: none;">
            <button onclick="compactarEBaixarXML('NFE')" id="downloadNFEButton">üì¶ Baixar XMLs NF-e</button>
            <button onclick="compactarEBaixarXML('NFCE')" id="downloadNFCEButton">üì¶ Baixar XMLs NFC-e</button>
        </div>
    </div>
    
    <h2>Relat√≥rio de Notas Fiscais (Visualiza√ß√£o Completa)</h2>
    
    <div id="filter-container" style="display: none;" class="controls-container">
        
        <div class="filter-group">
            <label for="filterCNPJ">CNPJ:</label>
            <select id="filterCNPJ" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todos os CNPJs</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filterMod">Tipo de Nota:</label>
            <select id="filterMod" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (NF-e e NFC-e)</option>
                <option value="55">Somente NF-e (Mod. 55)</option>
                <option value="65">Somente NFC-e (Mod. 65)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="filterStatus">Status SEFAZ:</label>
            <select id="filterStatus" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (Autorizadas/Canceladas/Rejeitadas)</option>
                <option value="AUTORIZADA">Somente AUTORIZADAS (100)</option>
                <option value="AUTORIZADA_FORA_PRAZO">Somente AUTORIZADAS FORA DO PRAZO (150)</option>
                <option value="NAO_AUTORIZADA">Somente CANCELADAS/REJEITADAS</option>
            </select>
        </div>
        <div id="search-container" style="display: none;">
            <input type="text" id="searchInput" placeholder="Buscar por Chave, Data, N√∫mero, CNPJ ou Valor..." onkeyup="filtrarTabela()">
            <button onclick="limparBusca()">Limpar Busca</button>
        </div>
    </div>
    
    <div id="resumo-container" style="display: none;" class="resumo-section">
        </div>
    
    <div id="relatorio-completo"> 
        <div id="relatorio-container">
            <p>Carregue os arquivos XML e clique em "Processar" para gerar o relat√≥rio.</p>
        </div>
    </div>

    <div id="modalDetalhesXML" class="modal-detalhes">
        <div class="modal-content">
            <span class="close-button" onclick="document.getElementById('modalDetalhesXML').style.display='none'">&times;</span>
            <h2>Detalhes da Nota Fiscal (DANFE Simplificado)</h2>
            <div id="danfe-simples-content">
                </div>
        </div>
    </div>

    <script>
        // Refer√™ncias aos elementos HTML
        const fileElem = document.getElementById('fileElem');
        const dropArea = document.getElementById('drop-area');
        const relatorioContainer = document.getElementById('relatorio-container');
        const resumoContainer = document.getElementById('resumo-container');
        const searchInput = document.getElementById('searchInput');
        // const searchContainer = document.getElementById('search-container'); // Agora est√° dentro de #filter-container
        const processButton = document.getElementById('processButton');
        const pdfButton = document.getElementById('pdfButton');
        const clearButton = document.getElementById('clearButton'); 
        
        // NOVO: Refer√™ncias aos novos elementos de filtro e download
        const filterContainer = document.getElementById('filter-container');
        const filterMod = document.getElementById('filterMod');
        const filterStatus = document.getElementById('filterStatus');
        const filterCNPJ = document.getElementById('filterCNPJ'); // NOVO: Refer√™ncia ao filtro CNPJ
        const downloadGroup = document.getElementById('downloadGroup');
        
        let notasFiscais = []; // Array que agora acumula as notas de todas as cargas
        let gruposGlobais = {}; 
        let arquivosXML = []; // NOVO: Armazena o conte√∫do e nome dos arquivos XML para compacta√ß√£o

        // Mapeamento de Forma de Pagamento (tPag)
        const formasPagamento = {
            '01': 'Dinheiro', '02': 'Cheque', '03': 'Cart√£o de Cr√©dito',
            '04': 'Cart√£o de D√©bito', '05': 'Cr√©dito Loja', '10': 'Vale Alimenta√ß√£o',
            '11': 'Vale Refei√ß√£o', '12': 'Vale Presente', '13': 'Vale Combust√≠vel',
            '14': 'Duplicata Mercantil', '15': 'Boleto Banc√°rio', '17': 'Pagamento Instant√¢neo (PIX)',
            '90': 'Sem Pagamento', '99': 'Outros'
        };

        // --- Event Listeners para Drag and Drop ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('highlight');
        }

        function unhighlight() {
            dropArea.classList.remove('highlight');
        }

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileElem.click(), false);
        fileElem.addEventListener('change', (e) => handleFiles(e.target.files), false);


        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            files = [...files];
            files.forEach(file => {
                if (file.name.toLowerCase().endsWith('.xml')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // NOVO: Adiciona a nota √† lista de arquivos XML brutos
                        arquivosXML.push({
                            fileName: file.name,
                            content: e.target.result,
                            // A chave ser√° adicionada no processamento para facilitar o lookup
                        });
                        
                        // Processa o arquivo no momento da carga (antes do bot√£o 'Processar')
                        // para que a nota j√° esteja pronta para ser verificada na pr√≥xima etapa.
                        try {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
                            processarNotaIndividual(xmlDoc, file.name);

                        } catch (error) {
                            console.error(`Erro ao ler o XML do arquivo ${file.name}:`, error);
                            alert(`N√£o foi poss√≠vel ler o arquivo XML: ${file.name}. Verifique se √© um XML de NF-e/NFC-e v√°lido.`);
                        }
                    };
                    reader.readAsText(file);
                } else {
                     console.warn(`Arquivo ignorado (n√£o √© XML): ${file.name}`);
                }
            });

            // Reativa o bot√£o de processamento se houver notas a processar
            if (arquivosXML.length > 0) {
                processButton.disabled = false;
                relatorioContainer.innerHTML = `<p><strong>${arquivosXML.length}</strong> arquivos XML carregados.</p><p>Clique em "Processar e Verificar Sequ√™ncia" para gerar o relat√≥rio.</p>`;
            }
        }
        
        /**
         * Extrai e armazena os dados de uma √∫nica nota fiscal do XML.
         * @param {Document} xmlDoc O objeto Document do XML.
         * @param {string} fileName O nome do arquivo XML.
         */
        function processarNotaIndividual(xmlDoc, fileName) {
            // NOVO: Captura o conte√∫do do XML
            
            // Campos obrigat√≥rios para Agrupamento/Sequ√™ncia
            const nNF = safeInt(xmlDoc, 'nNF');
            const mod = safeText(xmlDoc, 'mod');
            const serie = safeText(xmlDoc, 'serie');
            const CNPJ = safeText(xmlDoc, 'CNPJ');
            const chaveAcesso = safeText(xmlDoc, 'chNFe') || safeText(xmlDoc, 'chNFCE'); // Chave de acesso √© crucial para duplicidade

            if (nNF && mod && serie && CNPJ !== 'N/A' && chaveAcesso) {
                // 1. VERIFICA√á√ÉO DE DUPLICIDADE (CHAVE DE ACESSO)
                const isDuplicate = notasFiscais.some(n => n.chave === chaveAcesso);
                if (!isDuplicate) {
                    // 2. ADI√á√ÉO DA NOVA NOTA E ARQUIVO
                    const dhEmi = safeText(xmlDoc, 'dhEmi');
                    const vNF = safeText(xmlDoc, 'vNF');
                    const xFant = safeText(xmlDoc, 'xFant');
                    const CFOP = safeCFOP(xmlDoc); // Usa a fun√ß√£o auxiliar para CFOP
                    
                    // Tratamento do status (cStat)
                    const cStat = safeText(xmlDoc, 'cStat');
                    const xMotivo = safeText(xmlDoc, 'xMotivo');
                    const statusAutorizacao = formatarStatus(cStat, xMotivo, xmlDoc);
                    
                    // Tratamento da forma de pagamento
                    const detPag = xmlDoc.querySelector('detPag');
                    const tPag = safeText(detPag, 'tPag') || '99'; // Padr√£o 'Outros' se n√£o existir
                    const formaPagamento = formasPagamento[tPag] || 'Outros (99)';


                    const novaNota = {
                        nNF: nNF,
                        mod: mod,
                        serie: serie,
                        chave: chaveAcesso,
                        cnpj: CNPJ,
                        dhEmi: dhEmi, // Data/Hora no formato ISO
                        valorNumerico: parseFloat(vNF) || 0,
                        nomeFantasia: xFant !== 'N/A' ? xFant : CNPJ, // Usa CNPJ se n√£o tiver Fantasia
                        statusAutorizacao: statusAutorizacao, // Objeto com {text, class, isAutorizada, isAutorizadaForaPrazo}
                        cfop: CFOP,
                        formaPagamento: formaPagamento,
                        statusSequencia: { text: 'Pendente', class: '' }, // Inicializa como Pendente
                        fileName: fileName
                    };
                    
                    // Adiciona a nota no array global
                    notasFiscais.push(novaNota);
                    
                    // Adiciona a chave de acesso no objeto de arquivo XML bruto para lookup
                    const arquivo = arquivosXML.find(a => a.fileName === fileName && !a.chaveAcesso);
                    if (arquivo) {
                         arquivo.chaveAcesso = chaveAcesso;
                    }

                } else {
                    console.warn(`Nota Fiscal duplicada (Chave: ${chaveAcesso}) - Ignorada.`);
                }
            } else {
                 console.error(`XML inv√°lido ou faltando campos obrigat√≥rios em: ${fileName}`);
            }
        }


        function processarNotas() {
            if (notasFiscais.length === 0) {
                alert("Nenhum arquivo XML carregado.");
                return;
            }

            // 1. Agrupar as notas por CNPJ, Modelo e S√©rie
            const grupos = notasFiscais.reduce((acc, nota) => {
                // NOVO: Adiciona o tipo de nota no agrupamento
                const chaveGrupo = `${nota.cnpj}-${nota.mod}-${nota.serie}`;
                if (!acc[chaveGrupo]) {
                    acc[chaveGrupo] = {
                        info: {
                            cnpj: nota.cnpj,
                            mod: nota.mod,
                            serie: nota.serie,
                            emitente: nota.nomeFantasia
                        },
                        notas: []
                    };
                }
                acc[chaveGrupo].notas.push(nota);
                return acc;
            }, {});
            
            gruposGlobais = grupos; // Armazena grupos para uso na busca
            
            // 2. Verificar a sequ√™ncia dentro de cada grupo
            Object.values(grupos).forEach(grupo => {
                // √â crucial reordenar antes de verificar a sequ√™ncia, j√° que as notas s√£o acumuladas
                grupo.notas.sort((a, b) => a.nNF - b.nNF); 

                let ultimoNumeroAutorizado = 0; // O n√∫mero esperado para a pr√≥xima nota

                grupo.notas.forEach((nota, index) => {
                    // A l√≥gica de sequ√™ncia deve ser aplicada apenas a notas AUTORIZADAS (incluindo 150)
                    const isAutorizada = nota.statusAutorizacao.isAutorizada; // Usa a nova flag

                    if (!isAutorizada) {
                        // Adiciona a quebra/classe para o HTML, mas ignora na contagem da sequ√™ncia
                        nota.statusSequencia = { 
                            text: 'Ignorada na Sequ√™ncia', 
                            class: 'status-cancelada' 
                        };
                    } else {
                         // L√≥gica de verifica√ß√£o para notas AUTORIZADAS (100 ou 150)
                        if (nota.nNF === ultimoNumeroAutorizado + 1) {
                            // Sequ√™ncia correta
                            nota.statusSequencia = { 
                                text: 'OK', 
                                class: 'sem-quebra' 
                            };
                            ultimoNumeroAutorizado = nota.nNF; // Atualiza o √∫ltimo n√∫mero
                        } else if (nota.nNF > ultimoNumeroAutorizado + 1) {
                            // Quebra de sequ√™ncia
                            nota.statusSequencia = { 
                                text: `QUEBRA: Pr√≥xima esperada: ${ultimoNumeroAutorizado + 1}`, 
                                class: 'quebra-indicada' 
                            };
                            ultimoNumeroAutorizado = nota.nNF; // Atualiza para o n√∫mero atual (pr√≥ximo item verificar√° a partir dele)
                        } else {
                            // N√∫mero menor ou igual ao √∫ltimo (s√≥ deve acontecer se houver duplicidade de NNF
                            // dentro do mesmo CNPJ/Mod/S√©rie, o que a SEFAZ n√£o permite em produ√ß√£o)
                            // Ou se for a primeira nota do grupo e a primeira nota esperada for > 1.
                            if (index === 0 && nota.nNF > 1) {
                                // Primeira nota do lote n√£o come√ßa em 1
                                nota.statusSequencia = { 
                                    text: `QUEBRA: Come√ßou em ${nota.nNF} (Esperado 1)`, 
                                    class: 'quebra-indicada' 
                                };
                            } else {
                                // Caso geral: N√∫mero correto
                                nota.statusSequencia = { 
                                    text: 'OK', 
                                    class: 'sem-quebra' 
                                };
                            }

                            ultimoNumeroAutorizado = nota.nNF;
                        }
                    }
                });
            });


            // 3. Atualizar o filtro de CNPJ (se houver mais de um)
            const cnpjsUnicos = [...new Set(notasFiscais.map(n => n.cnpj))];
            filterCNPJ.innerHTML = '<option value="ALL">Todos os CNPJs</option>';
            cnpjsUnicos.forEach(cnpj => {
                const nome = notasFiscais.find(n => n.cnpj === cnpj).nomeFantasia;
                const option = document.createElement('option');
                option.value = cnpj;
                option.textContent = `${cnpj} (${nome})`;
                filterCNPJ.appendChild(option);
            });
            
            
            // 4. Gerar Relat√≥rio e Resumos
            gerarRelatorioHTML(grupos);
            gerarResumos(notasFiscais);
            
            // 5. Exibir elementos de controle
            filterContainer.style.display = 'flex'; // Exibe o container de filtros
            document.getElementById('search-container').style.display = 'flex'; // Exibe o container de busca
            downloadGroup.style.display = 'flex'; // Exibe o download de XMLs
            pdfButton.disabled = false;
        }

        function limparArquivos() {
            // Reinicia o estado da aplica√ß√£o
            notasFiscais = [];
            gruposGlobais = {};
            arquivosXML = []; // NOVO: Limpa o array de arquivos XML

            // Reseta o estado dos bot√µes e containers
            processButton.disabled = true;
            pdfButton.disabled = true;
            filterContainer.style.display = 'none'; // Oculta o container de filtros
            document.getElementById('search-container').style.display = 'none'; // Oculta a busca
            downloadGroup.style.display = 'none'; // Oculta o download de XMLs
            searchInput.value = '';
            filterMod.value = 'ALL'; // Reseta filtros
            filterStatus.value = 'ALL'; // Reseta filtros
            filterCNPJ.value = 'ALL'; // NOVO: Reseta filtro CNPJ
            filterCNPJ.innerHTML = '<option value="ALL">Todos os CNPJs</option>'; // Limpa op√ß√µes de CNPJ
            resumoContainer.style.display = 'none'; // Oculta o resumo
            resumoContainer.innerHTML = '';
            relatorioContainer.innerHTML = '<p>Todos os arquivos foram removidos. Arraste e solte ou clique para carregar novos arquivos XML.</p>';
        }

        // --- Fun√ß√µes Auxiliares de Leitura e Formata√ß√£o ---
        /**
         * Retorna o textContent de uma tag, ou 'N/A' se n√£o existir.
         * Suporta busca recursiva para tags como 'dhEmi' dentro de 'ide'.
         */
        function safeText(xmlDoc, tagName) {
            let element;
            // Tratamento especial para CFOP (dentro de det/prod)
            if (tagName === 'CFOP') {
                // Procura a primeira ocorr√™ncia de CFOP dentro de 'prod' de qualquer 'det'
                element = xmlDoc.querySelector('det prod CFOP');
            } else if (tagName === 'CNPJ' || tagName === 'CPF') {
                 // Procura por CNPJ em <emit> ou <dest>
                 element = xmlDoc.querySelector(`emit ${tagName}`) || xmlDoc.querySelector(`dest ${tagName}`);
            } else if (tagName === 'chNFe' || tagName === 'chNFCE') {
                 // Procura a chave de acesso no n√≥ 'infNFe' ou 'infNFCE' (atributo chNFe) ou na tag.
                 // Prioriza a busca na tag <chNFe> dentro de <infNFe> ou <infNFCE> se houver.
                 element = xmlDoc.querySelector(tagName);
                 // Se n√£o encontrar na tag, tenta buscar na chave de acesso que √© o ID da infNFe
                 if (!element) {
                    const infNFe = xmlDoc.querySelector('infNFe') || xmlDoc.querySelector('infNFCE');
                    if (infNFe) {
                        const idAttr = safeAttr(infNFe, 'Id');
                        if (idAttr !== 'N/A' && idAttr.startsWith('NFe') || idAttr.startsWith('NFCE')) {
                             return idAttr.substring(3); // Remove NFe ou NFCE
                        }
                    }
                 }
            } else {
                // Busca padr√£o
                element = xmlDoc.querySelector(tagName);
            }
            
            return element ? (element.textContent || 'N/A') : 'N/A';
        }

        /**
         * NOVO: Retorna o valor de um atributo de um elemento, ou 'N/A' se n√£o existir.
         * @param {Element} element O elemento XML.
         * @param {string} attrName O nome do atributo.
         * @returns {string} O valor do atributo ou 'N/A'.
         */
        function safeAttr(element, attrName) {
            if (element && element.hasAttribute(attrName)) {
                return element.getAttribute(attrName) || 'N/A';
            }
            return 'N/A';
        }
        
        /**
         * Retorna o textContent de uma tag como inteiro, ou 0 se n√£o existir/inv√°lido.
         */
        function safeInt(xmlDoc, tagName) {
            const text = safeText(xmlDoc, tagName);
            const num = parseInt(text);
            return isNaN(num) ? 0 : num;
        }

        /**
         * Retorna o primeiro CFOP encontrado em <det><prod><CFOP>
         */
        function safeCFOP(xmlDoc) {
            const cfopElement = xmlDoc.querySelector('det prod CFOP');
            return cfopElement ? cfopElement.textContent : 'N/A';
        }

        /**
         * Formata a data ISO (ex: YYYY-MM-DD) para o padr√£o brasileiro (DD/MM/YYYY).
         */
        function formatarData(dataISO) {
            if (!dataISO) return 'N/A';
            // A data ISO na NF-e vem no formato "YYYY-MM-DDTHH:MM:SS-ZZ:ZZ". Extrai apenas a data.
            const datePart = dataISO.substring(0, 10); 
            const [ano, mes, dia] = datePart.split('-');
            if (ano && mes && dia) {
                return `${dia}/${mes}/${ano}`;
            }
            return dataISO;
        }

        /**
         * NOVO: Formata a data/hora ISO (ex: YYYY-MM-DDTHH:MM:SS-ZZ:ZZ) para o padr√£o brasileiro (DD/MM/YYYY HH:MM:SS).
         * @param {string} dataHora A string de data/hora no formato ISO.
         * @returns {string} A data/hora formatada.
         */
        function formatarDataHora(dataHora) {
            if (!dataHora) return 'N/A';
            // A data ISO na NF-e vem no formato "YYYY-MM-DDTHH:MM:SS-ZZ:ZZ". Tenta normalizar.
            // Remove o fuso hor√°rio (ex: -03:00) para evitar problemas de fuso no new Date()
            const dataString = dataHora.replace(/(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2}:\d{2}).*/, '$1T$2');
            const data = new Date(dataString);

            if (isNaN(data.getTime())) {
                // Tenta um parser mais simples, caso o formato seja diferente
                const match = dataHora.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
                if (match) {
                     return `${match[3]}/${match[2]}/${match[1]} ${match[4]}:${match[5]}:${match[6]}`;
                }
                return dataHora; // Retorna o original se falhar
            }

            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');
            const segundo = String(data.getSeconds()).padStart(2, '0');

            return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
        }
        
        /**
         * Converte um valor num√©rico para o padr√£o de moeda brasileira (R$ X.XXX,XX).
         */
        function formatarValor(valor) {
            if (valor === undefined || valor === null || isNaN(parseFloat(valor))) {
                return 'R$ 0,00';
            }
            const numero = parseFloat(valor);
            return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatarStatus(cStat, xMotivo, xmlDoc) {
            const eventType = xmlDoc.querySelector('tpEvento');
            const cStatEvento = xmlDoc.querySelector('retEvento cStat');
            const xMotivoEvento = xmlDoc.querySelector('retEvento xMotivo');
            
            // 1. Prioridade: Evento de Cancelamento (110111)
            if (eventType && eventType.textContent === '110111') {
                if (cStatEvento && cStatEvento.textContent === '135') {
                    return { 
                        text: 'CANCELADA (Evento 135)', 
                        class: 'status-cancelada', 
                        isAutorizada: false,
                        isAutorizadaForaPrazo: false
                    }; 
                }
            } 
            
            // 2. Status de Autoriza√ß√£o (cStat)
            if (cStat) {
                switch(cStat) {
                    case '100':
                        return { 
                            text: 'AUTORIZADA (100)', 
                            class: 'status-autorizada', 
                            isAutorizada: true, 
                            isAutorizadaForaPrazo: false 
                        };
                    case '150':
                         return { 
                            text: 'AUT. FORA DE PRAZO (150)', 
                            class: 'status-autorizada', 
                            isAutorizada: true, 
                            isAutorizadaForaPrazo: true 
                        };
                    case '101':
                        return { 
                            text: 'CANCELADA (101)', 
                            class: 'status-cancelada', 
                            isAutorizada: false,
                            isAutorizadaForaPrazo: false
                        };
                    default:
                        // Demais c√≥digos (Rejei√ß√£o, Denega√ß√£o, etc.)
                        return { 
                            text: `${xMotivo || 'Rejeitada/Outro'} (${cStat})`, 
                            class: 'status-sem-autorizacao', 
                            isAutorizada: false,
                            isAutorizadaForaPrazo: false 
                        };
                }
            }

            // 3. Status de rejei√ß√£o ou sem cStat
             return { 
                text: `${xMotivo || 'Sem Autoriza√ß√£o (NF Incompleta)'}`, 
                class: 'status-sem-autorizacao', 
                isAutorizada: false,
                isAutorizadaForaPrazo: false 
            };
        }
        
        // --- NOVO: Visualiza√ß√£o de Detalhes do XML (DANFE Simplificado) ---

        /**
         * Fun√ß√£o que gera o HTML do DANFE Simplificado.
         * @param {object} nota O objeto nota da lista 'notasFiscais'.
         * @param {Document} xmlDoc O objeto Document do XML.
         * @returns {string} O HTML gerado.
         */
        function gerarDetalhesNotaHTML(nota, xmlDoc) {
            // A. Informa√ß√µes B√°sicas
            const ide = xmlDoc.querySelector('ide');
            const infNFe = xmlDoc.querySelector('infNFe') || xmlDoc.querySelector('infNFCE');
            const versao = safeAttr(infNFe, 'versao');
            const natOp = safeText(xmlDoc, 'natOp');
            const mod = nota.mod;
            const nNF = nota.nNF;
            const serie = nota.serie;
            const dhEmi = nota.dhEmi ? formatarDataHora(nota.dhEmi) : 'N/A';
            const dhSaiEnt = safeText(xmlDoc, 'dhSaiEnt') ? formatarDataHora(xmlDoc.querySelector('dhSaiEnt').textContent) : 'N/A';
            const tpNF = safeText(xmlDoc, 'tpNF') === '0' ? 'Entrada' : (safeText(xmlDoc, 'tpNF') === '1' ? 'Sa√≠da' : 'N/A');
            const cMunFG = safeText(xmlDoc, 'cMunFG');

            // B. Emitente (Emit)
            const emit = xmlDoc.querySelector('emit');
            const xNomeEmit = safeText(emit, 'xNome');
            const xFantEmit = safeText(emit, 'xFant');
            const CNPJEmit = safeText(emit, 'CNPJ');
            const IE_Emit = safeText(emit, 'IE');
            const CRT_Emit = safeText(emit, 'CRT');
            const enderEmit = xmlDoc.querySelector('emit enderEmit');
            const endEmit = enderEmit ? `${safeText(enderEmit, 'xLgr')}, ${safeText(enderEmit, 'nro')} - ${safeText(enderEmit, 'xBairro')} - ${safeText(enderEmit, 'xMun')}/${safeText(enderEmit, 'UF')}` : 'N/A';

            // C. Destinat√°rio (Dest)
            const dest = xmlDoc.querySelector('dest');
            // Nota: O CNPJ/CPF √© extra√≠do diretamente da tag <CNPJ> ou <CPF> dentro de <dest>
            const CPFCNPJDest = dest ? (safeText(dest, 'CNPJ') || safeText(dest, 'CPF')) : 'N/A';
            const xNomeDest = safeText(dest, 'xNome');
            const enderDest = xmlDoc.querySelector('dest enderDest');
            const endDest = enderDest ? `${safeText(enderDest, 'xLgr')}, ${safeText(enderDest, 'nro')} - ${safeText(enderDest, 'xBairro')} - ${safeText(enderDest, 'xMun')}/${safeText(enderDest, 'UF')}` : 'N/A';
            
            // D. Totais (ICMSTot e ISSQNtot)
            const ICMSTot = xmlDoc.querySelector('ICMSTot');
            const vBC = formatarValor(safeText(ICMSTot, 'vBC'));
            const vICMS = formatarValor(safeText(ICMSTot, 'vICMS'));
            const vICMSDeson = formatarValor(safeText(ICMSTot, 'vICMSDeson'));
            const vFCP = formatarValor(safeText(ICMSTot, 'vFCP'));
            const vBCST = formatarValor(safeText(ICMSTot, 'vBCST'));
            const vST = formatarValor(safeText(ICMSTot, 'vST'));
            const vFCPST = formatarValor(safeText(ICMSTot, 'vFCPST'));
            const vFCPSTRet = formatarValor(safeText(ICMSTot, 'vFCPSTRet'));
            const vProd = formatarValor(safeText(ICMSTot, 'vProd'));
            const vFrete = formatarValor(safeText(ICMSTot, 'vFrete'));
            const vSeg = formatarValor(safeText(ICMSTot, 'vSeg'));
            const vDesc = formatarValor(safeText(ICMSTot, 'vDesc'));
            const vII = formatarValor(safeText(ICMSTot, 'vII'));
            const vIPI = formatarValor(safeText(ICMSTot, 'vIPI'));
            const vIPIDevol = formatarValor(safeText(ICMSTot, 'vIPIDevol'));
            const vPIS = formatarValor(safeText(ICMSTot, 'vPIS'));
            const vCOFINS = formatarValor(safeText(ICMSTot, 'vCOFINS'));
            const vOutro = formatarValor(safeText(ICMSTot, 'vOutro'));
            const vNF = formatarValor(safeText(ICMSTot, 'vNF'));
            const vTotTrib = formatarValor(safeText(ICMSTot, 'vTotTrib'));
            const infCpl = safeText(xmlDoc, 'infCpl'); // Informa√ß√µes Complementares

            // E. Produtos
            const dets = xmlDoc.querySelectorAll('det');
            let produtosHTML = '';
            
            dets.forEach((det, index) => {
                const prod = det.querySelector('prod');
                const imposto = det.querySelector('imposto');
                const nItem = safeAttr(det, 'nItem');
                const cProd = safeText(prod, 'cProd');
                const xProd = safeText(prod, 'xProd');
                const NCM = safeText(prod, 'NCM');
                const CFOP = safeText(prod, 'CFOP');
                const uCom = safeText(prod, 'uCom');
                const qCom = safeText(prod, 'qCom');
                const vUnCom = formatarValor(safeText(prod, 'vUnCom'));
                const vProdItem = formatarValor(safeText(prod, 'vProd'));
                const vDescItem = safeText(prod, 'vDesc') ? formatarValor(safeText(prod, 'vDesc')) : '-';
                
                produtosHTML += `
                    <tr>
                        <td>${nItem}</td>
                        <td>${cProd}</td>
                        <td>${xProd}</td>
                        <td>${NCM}</td>
                        <td>${CFOP}</td>
                        <td>${uCom}</td>
                        <td>${qCom}</td>
                        <td>${vUnCom}</td>
                        <td>${vProdItem}</td>
                        <td>${vDescItem}</td>
                    </tr>
                `;
            });
            
            let html = '';
            
            // Header
            html += `<div class="danfe-simples">`;
            html += `<div class="danfe-header">CHAVE DE ACESSO: ${nota.chave} | Vers√£o: ${versao} | Status: ${nota.statusAutorizacao.text}</div>`;
            
            // Dados da NF
            html += `<div class="danfe-section-title">Dados da Nota Fiscal (${mod === '55' ? 'NF-e' : 'NFC-e'})</div>`;
            html += `<div class="danfe-data">`;
            html += `<div class="danfe-field"><span>N¬∫ / S√©rie:</span> ${nNF} / ${serie}</div>`;
            html += `<div class="danfe-field"><span>Emiss√£o:</span> ${dhEmi}</div>`;
            html += `<div class="danfe-field"><span>Sa√≠da/Entrada:</span> ${dhSaiEnt}</div>`;
            html += `<div class="danfe-field"><span>Natureza da Opera√ß√£o:</span> ${natOp}</div>`;
            html += `<div class="danfe-field"><span>Tipo:</span> ${tpNF}</div>`;
            html += `<div class="danfe-field"><span>Munic√≠pio de Ocorr√™ncia:</span> ${cMunFG}</div>`;
            html += `</div>`;

            // Emitente
            html += `<div class="danfe-section-title">Emitente</div>`;
            html += `<div class="danfe-data">`;
            html += `<div class="danfe-field"><span>Nome/Fantasia:</span> ${xNomeEmit} (${xFantEmit})</div>`;
            html += `<div class="danfe-field"><span>CNPJ:</span> ${CNPJEmit}</div>`;
            html += `<div class="danfe-field"><span>IE:</span> ${IE_Emit}</div>`;
            html += `<div class="danfe-field" style="flex: 1 1 300px;"><span>Endere√ßo:</span> ${endEmit}</div>`;
            html += `<div class="danfe-field"><span>CRT:</span> ${CRT_Emit}</div>`;
            html += `</div>`;

            // Destinat√°rio
            html += `<div class="danfe-section-title">Destinat√°rio</div>`;
            html += `<div class="danfe-data">`;
            html += `<div class="danfe-field"><span>Nome:</span> ${xNomeDest}</div>`;
            html += `<div class="danfe-field"><span>CNPJ/CPF:</span> ${CPFCNPJDest}</div>`;
            html += `<div class="danfe-field" style="flex: 1 1 300px;"><span>Endere√ßo:</span> ${endDest}</div>`;
            html += `</div>`;
            
            // Produtos
            html += `<div class="danfe-section-title">Produtos e Servi√ßos (${dets.length} itens)</div>`;
            html += `<div class="danfe-products">
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>C√≥d. Prod.</th>
                            <th>Descri√ß√£o do Produto</th>
                            <th>NCM</th>
                            <th>CFOP</th>
                            <th>Unid.</th>
                            <th>Qtde.</th>
                            <th>Valor Unit.</th>
                            <th>Valor Total</th>
                            <th>Desc.</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${produtosHTML}
                    </tbody>
                </table>
            </div>`;
            
            // Totais
            html += `<div class="danfe-section-title">Totais da Nota Fiscal</div>`;
            html += `<div class="danfe-data">`;
            html += `<div class="danfe-field"><span>Valor Total da Nota (vNF):</span> ${vNF}</div>`;
            html += `<div class="danfe-field"><span>Valor Total dos Produtos (vProd):</span> ${vProd}</div>`;
            html += `<div class="danfe-field"><span>Valor do ICMS (vICMS):</span> ${vICMS}</div>`;
            html += `<div class="danfe-field"><span>Base de C√°lculo ICMS (vBC):</span> ${vBC}</div>`;
            html += `<div class="danfe-field"><span>Valor do ICMS ST (vST):</span> ${vST}</div>`;
            html += `<div class="danfe-field"><span>Base de C√°lculo ICMS ST (vBCST):</span> ${vBCST}</div>`;
            html += `<div class="danfe-field"><span>Valor do IPI (vIPI):</span> ${vIPI}</div>`;
            html += `<div class="danfe-field"><span>Valor do Frete (vFrete):</span> ${vFrete}</div>`;
            html += `<div class="danfe-field"><span>Valor do Seguro (vSeg):</span> ${vSeg}</div>`;
            html += `<div class="danfe-field"><span>Descontos (vDesc):</span> ${vDesc}</div>`;
            html += `<div class="danfe-field"><span>Outras Despesas (vOutro):</span> ${vOutro}</div>`;
            html += `<div class="danfe-field"><span>Valor Total Aproximado dos Tributos (vTotTrib):</span> ${vTotTrib}</div>`;
            html += `<div class="danfe-field"><span>Vl. ICMS Deson:</span> ${vICMSDeson}</div>`;
            html += `<div class="danfe-field"><span>Vl. FCP:</span> ${vFCP}</div>`;
            html += `<div class="danfe-field"><span>Vl. FCP ST:</span> ${vFCPST}</div>`;
            html += `<div class="danfe-field"><span>Vl. FCP ST Retido:</span> ${vFCPSTRet}</div>`;
            html += `<div class="danfe-field"><span>Vl. II:</span> ${vII}</div>`;
            html += `<div class="danfe-field"><span>Vl. IPI Devolvido:</span> ${vIPIDevol}</div>`;
            html += `<div class="danfe-field"><span>Vl. PIS:</span> ${vPIS}</div>`;
            html += `<div class="danfe-field"><span>Vl. COFINS:</span> ${vCOFINS}</div>`;
            html += `</div>`;

            // Informa√ß√µes Complementares
            if (infCpl !== 'N/A' && infCpl.trim() !== '') {
                html += `<div class="danfe-section-title">Informa√ß√µes Complementares</div>`;
                html += `<div class="danfe-data" style="padding: 10px; display: block;">${infCpl.replace(/\n/g, '<br>')}</div>`;
            }

            html += `</div>`; // .danfe-simples
            return html;
        }

        /**
         * Fun√ß√£o principal para exibir o modal de detalhes do XML.
         * @param {string} chaveAcesso A chave de acesso da NF-e/NFC-e.
         */
        function exibirDetalhesXML(chaveAcesso) {
            const nota = notasFiscais.find(n => n.chave === chaveAcesso);
            const arquivoXML = arquivosXML.find(a => a.chaveAcesso === chaveAcesso);

            if (!nota || !arquivoXML || !arquivoXML.content) {
                alert('Conte√∫do XML da nota fiscal n√£o encontrado ou inv√°lido.');
                return;
            }

            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(arquivoXML.content, "application/xml");
                
                const contentHTML = gerarDetalhesNotaHTML(nota, xmlDoc);
                
                document.getElementById('danfe-simples-content').innerHTML = contentHTML;
                document.getElementById('modalDetalhesXML').style.display = 'block';

                // Fechar o modal com a tecla ESC
                document.onkeydown = function(e) {
                    e = e || window.event;
                    if (e.key === 'Escape') {
                        document.getElementById('modalDetalhesXML').style.display = 'none';
                        document.onkeydown = null; // Remove o listener ap√≥s fechar
                    }
                };

            } catch (e) {
                console.error('Erro ao processar o XML:', e);
                alert('Ocorreu um erro ao tentar processar o XML para visualiza√ß√£o.');
            }
        }

        // Fechar o modal ao clicar fora dele
        window.onclick = function(event) {
            const modal = document.getElementById('modalDetalhesXML');
            if (event.target === modal) {
                modal.style.display = "none";
                document.onkeydown = null; // Remove o listener
            }
        }
        
        // --- Gera√ß√£o do Relat√≥rio HTML e Filtros (Alterado para incluir coluna A√ß√£o) ---
        
        function gerarRelatorioHTML(grupos) {
            let htmlCompleto = '';
            let totalGeral = 0;
            let temGrupoVisivel = false;
            
            // NOVO: Filtro de CNPJ √© aplicado aqui para agrupar o relat√≥rio corretamente
            const cnpjFilter = filterCNPJ.value;

            // 1. Iterar sobre os grupos (CNPJ-Mod-S√©rie)
            Object.values(grupos).forEach(grupo => {
                const info = grupo.info;
                const chaveGrupo = `${info.cnpj}-${info.mod}-${info.serie}`;
                const tipoNota = info.mod === '55' ? 'NF-e' : (info.mod === '65' ? 'NFC-e' : `Mod. ${info.mod}`);

                // NOVO: Aplica o filtro de CNPJ no agrupamento
                if (filterCNPJ.value !== 'ALL' && info.cnpj !== filterCNPJ.value) {
                    return; // Ignora o grupo se n√£o corresponder ao filtro de CNPJ
                }
                
                temGrupoVisivel = true; 

                // Adiciona o ID da chave do grupo na div de tabelas para facilitar a busca
                let htmlGrupo = `
                    <div id="table-group-${chaveGrupo}" data-mod="${info.mod}" data-cnpj="${info.cnpj}">
                        ${filterCNPJ.value === 'ALL' ? '' : `<h3>üßæ ${info.emitente} (CNPJ: ${info.cnpj}) - ${tipoNota} - S√©rie: ${info.serie}</h3>`}
                        <table id="table-${chaveGrupo}">
                            <thead>
                                <tr>
                                    <th>S√©rie</th>
                                    <th>N√∫mero</th>
                                    <th>Emiss√£o</th>
                                    <th>CFOP</th>
                                    <th>Forma Pag.</th>
                                    <th>Valor Total</th>
                                    <th>Chave de Acesso</th>
                                    <th>Status SEFAZ</th>
                                    <th>Status Sequ√™ncia</th>
                                    <th>A√ß√£o</th> </tr>
                            </thead>
                            <tbody>
                `;

                // 2. Iterar sobre as notas dentro do grupo
                grupo.notas.forEach(nota => {
                    // Aplica filtros que dependem apenas da nota (Mod e Status)
                    const modFilter = filterMod.value;
                    const statusFilter = filterStatus.value;

                    // Filtro de Modelo
                    if (modFilter !== 'ALL' && nota.mod !== modFilter) {
                        return;
                    }

                    // Filtro de Status
                    if (statusFilter === 'AUTORIZADA' && !nota.statusAutorizacao.isAutorizada) {
                         return; // Se quer S√ì autorizada e esta n√£o √©, ignora.
                    }
                    if (statusFilter === 'AUTORIZADA' && nota.statusAutorizacao.isAutorizadaForaPrazo) {
                        return; // Se quer S√ì autorizada e esta √© fora de prazo, ignora.
                    }
                    if (statusFilter === 'AUTORIZADA_FORA_PRAZO' && !nota.statusAutorizacao.isAutorizadaForaPrazo) {
                        return; // Se quer S√ì fora de prazo e esta n√£o √©, ignora.
                    }
                    if (statusFilter === 'NAO_AUTORIZADA' && nota.statusAutorizacao.isAutorizada) {
                        return; // Se quer S√ì n√£o autorizada e esta √© autorizada, ignora.
                    }

                    // Adiciona o valor total apenas de notas vis√≠veis e autorizadas (para total de confer√™ncia)
                    if (nota.statusAutorizacao.isAutorizada) {
                         totalGeral += nota.valorNumerico;
                    }

                    const statusClasse = nota.statusAutorizacao.class;
                    const sequenciaClasse = nota.statusSequencia.class;
                    const statusAutorizacao = nota.statusAutorizacao.isAutorizada ? (nota.statusAutorizacao.isAutorizadaForaPrazo ? 'AUTORIZADA_FORA_PRAZO' : 'AUTORIZADA') : 'NAO_AUTORIZADA';

                    // Linha da Tabela
                    htmlGrupo += `
                        <tr class="${statusClasse} ${sequenciaClasse}" data-cnpj="${nota.cnpj}" data-mod="${nota.mod}" data-status="${statusAutorizacao}" data-chave="${nota.chave}">
                            <td>${nota.serie}</td>
                            <td>${nota.nNF}</td>
                            <td>${nota.dhEmi ? formatarData(nota.dhEmi) : 'N/A'}</td>
                            <td>${nota.cfop}</td>
                            <td>${nota.formaPagamento}</td>
                            <td>${formatarValor(nota.valorNumerico)}</td>
                            <td>${nota.chave}</td>
                            <td class="${statusClasse}">${nota.statusAutorizacao.text}</td>
                            <td class="${sequenciaClasse}">${nota.statusSequencia.text}</td>
                            <td><button onclick="exibirDetalhesXML('${nota.chave}')">Ver XML</button></td> </tr>
                    `;
                }); // Fim do forEach de notas
                
                htmlGrupo += `</tbody></table></div>`;
                htmlCompleto += htmlGrupo;
            }); // Fim do forEach de grupos

            // 3. Montar o Relat√≥rio Final
            if (!temGrupoVisivel) {
                relatorioContainer.innerHTML = '<p>Nenhuma nota fiscal encontrada com os filtros e arquivos carregados.</p>';
            } else {
                // Adiciona o total geral (somente de notas autorizadas vis√≠veis)
                const totalHTML = `<div class="total-geral">Valor Total das Notas Fiscais AUTORIZADAS (Filtradas): <span>${formatarValor(totalGeral)}</span></div>`;

                relatorioContainer.innerHTML = totalHTML + htmlCompleto;
            }
        }

        // --- Fun√ß√µes de Filtro (SEM ALTERA√á√ïES na l√≥gica) ---
        function aplicarFiltrosRelatorio() {
            const filtroBusca = searchInput.value.toUpperCase();
            // 1. Re-gera o Relat√≥rio HTML para garantir que o agrupamento de CNPJ seja filtrado
            // Re-gera a parte visual (tabelas e total) com o novo CNPJ
            gerarRelatorioHTML(gruposGlobais); // Vai ignorar grupos que n√£o batem com o filterCNPJ.value
            
            // 2. Recalcula e exibe os resumos se o CNPJ mudar (ou outros filtros, mas o CNPJ √© o mais relevante aqui).
            gerarResumos(notasFiscais); 

            // 3. Re-executa a busca para garantir que a combina√ß√£o de filtros funcione
            filtrarTabela(filtroBusca); // Aplica a busca e os filtros
        }
        
        function filtrarTabela() {
            const filtroBusca = searchInput.value.toUpperCase();
            const tabelas = relatorioContainer.querySelectorAll('table');

            tabelas.forEach(table => {
                const rows = table.querySelectorAll('tbody tr');
                const modGrupo = table.parentElement.getAttribute('data-mod');
                const cnpjGrupo = table.parentElement.getAttribute('data-cnpj'); // CNPJ do grupo (usado para busca)
                
                rows.forEach(row => {
                    const modRow = row.getAttribute('data-mod');
                    const statusRow = row.getAttribute('data-status');
                    
                    let showRow = true;
                    
                    // 1. Filtro de Modelo (Aplica√ß√£o do filtro de busca)
                    const filtroMod = filterMod.value;
                    if (filtroMod !== 'ALL' && modRow !== filtroMod) {
                        showRow = false;
                    }
                    
                    // 2. Filtro de Status (Aplica√ß√£o do filtro de busca)
                    const filtroStatus = filterStatus.value;
                    if (filtroStatus === 'AUTORIZADA' && (statusRow !== 'AUTORIZADA')) { 
                        showRow = false; 
                    } else if (filtroStatus === 'AUTORIZADA_FORA_PRAZO' && statusRow !== 'AUTORIZADA_FORA_PRAZO') {
                         showRow = false;
                    } else if (filtroStatus === 'NAO_AUTORIZADA' && (statusRow === 'AUTORIZADA' || statusRow === 'AUTORIZADA_FORA_PRAZO')) {
                        showRow = false;
                    }

                    // 3. Aplica o filtro de busca textual/CNPJ
                    if (filtroBusca !== '') {
                        let matchesSearch = false;
                        
                        // Verifica se o CNPJ do grupo corresponde ao filtro de busca
                        if (cnpjGrupo && cnpjGrupo.toUpperCase().indexOf(filtroBusca) > -1) {
                            matchesSearch = true;
                        } else {
                            // Percorre todas as c√©lulas (td) da linha
                            for (let j = 0; j < row.cells.length; j++) {
                                const td = row.cells[j];
                                if (td) {
                                    const text = td.textContent || td.innerText;
                                    if (text.toUpperCase().indexOf(filtroBusca) > -1) {
                                        matchesSearch = true;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // A linha s√≥ deve ser mostrada se passar pelos filtros E pela busca
                        showRow = showRow && matchesSearch;
                    }

                    row.style.display = showRow ? '' : 'none';
                });
            });
            // Oculta/mostra grupos inteiros se todas as linhas estiverem ocultas (l√≥gica complexa, simplificada)
        }
        
        function limparBusca() {
            searchInput.value = '';
            filtrarTabela();
        }

        // --- Gera√ß√£o de Resumos (CFOP e Pagamento) --- 
        function gerarResumos(notas) {
            const resumoCFOP = {};
            const resumoPagamento = {};

            // NOVO: Filtrar as notas pelo CNPJ selecionado (se n√£o for 'ALL')
            const notasParaResumo = notas.filter(n => filterCNPJ.value === 'ALL' || n.cnpj === filterCNPJ.value);

            if (notasParaResumo.length === 0 && filterCNPJ.value !== 'ALL') {
                resumoContainer.innerHTML = `<p>Nenhuma nota fiscal encontrada para o CNPJ ${filterCNPJ.value} para gerar os resumos.</p>`;
                resumoContainer.style.display = 'flex';
                return;
            }

            notasParaResumo.forEach(nota => {
                // Apenas notas AUTORIZADAS (incluindo 150) para os resumos
                if (nota.statusAutorizacao.isAutorizada) {
                    // Resumo por CFOP
                    const cfopKey = nota.cfop;
                    resumoCFOP[cfopKey] = resumoCFOP[cfopKey] || { count: 0, total: 0 };
                    resumoCFOP[cfopKey].count++;
                    resumoCFOP[cfopKey].total += Math.round(nota.valorNumerico * 100) / 100; // Evita erros de ponto flutuante

                    // Resumo por Forma de Pagamento
                    const pagKey = nota.formaPagamento;
                    resumoPagamento[pagKey] = resumoPagamento[pagKey] || { count: 0, total: 0 };
                    resumoPagamento[pagKey].count++;
                    resumoPagamento[pagKey].total += Math.round(nota.valorNumerico * 100) / 100;
                }
            });

            // Gerar HTML do Resumo CFOP
            let htmlCFOP = '<h4>Resumo por CFOP (Notas Autorizadas)</h4><table><thead><tr><th>CFOP</th><th>Quantidade</th><th>Valor Total</th></tr></thead><tbody>';
            Object.entries(resumoCFOP).sort(([, a], [, b]) => b.total - a.total).forEach(([cfop, data]) => {
                htmlCFOP += `<tr><td>${cfop}</td><td>${data.count}</td><td>${formatarValor(data.total)}</td></tr>`;
            });
            htmlCFOP += '</tbody></table>';

            // Gerar HTML do Resumo Pagamento
            let htmlPagamento = '<h4>Resumo por Forma de Pagamento (Notas Autorizadas)</h4><table><thead><tr><th>Forma Pag.</th><th>Quantidade</th><th>Valor Total</th></tr></thead><tbody>';
            Object.entries(resumoPagamento).sort(([, a], [, b]) => b.total - a.total).forEach(([pag, data]) => {
                htmlPagamento += `<tr><td>${pag}</td><td>${data.count}</td><td>${formatarValor(data.total)}</td></tr>`;
            });
            htmlPagamento += '</tbody></table>';

            resumoContainer.innerHTML = `<div class="resumo-table-container">${htmlCFOP}</div><div class="resumo-table-container">${htmlPagamento}</div>`;
            resumoContainer.style.display = 'flex';
        }
        
        // --- Fun√ß√µes de Download e Exporta√ß√£o (SEM ALTERA√á√ïES na l√≥gica) ---
        // ... (As fun√ß√µes gerarRelatorioPDF, compactarEBaixarXML e auxiliares de nome de arquivo permanecem inalteradas, exceto a l√≥gica de loop de constru√ß√£o de tabela no PDF que precisa ser atualizada para corresponder ao HTML) ...
        
        // Fun√ß√µes para nome de arquivo
        /**
         * Encontra o per√≠odo de emiss√£o (m√™s/ano) das notas carregadas.
         */
        function obterPeriodoEmissaoPrincipal() {
            // Se o filtro for aplicado, s√≥ pega as datas das notas filtradas
            const notas = filterCNPJ.value === 'ALL' 
                ? notasFiscais 
                : notasFiscais.filter(n => n.cnpj === filterCNPJ.value);

            if (notas.length === 0) return 'Data-N/A';
            
            // Converte a data ISO para um n√∫mero compar√°vel (AAAAMM)
            const datas = notas
                .filter(n => n.dhEmi)
                .map(n => parseInt(n.dhEmi.substring(0, 7).replace('-', ''))); 
            
            if (datas.length === 0) return 'Data-N/A';

            const minDate = Math.min(...datas);
            const maxDate = Math.max(...datas);
            
            // Converte o n√∫mero de volta para string M√™s-Ano
            const formatPeriod = (num) => {
                const str = String(num);
                return `${str.substring(4, 6)}-${str.substring(0, 4)}`; // MM-AAAA
            };

            const minPeriod = formatPeriod(minDate);
            const maxPeriod = formatPeriod(maxDate);
            
            if (minPeriod === maxPeriod) {
                return minPeriod;
            } else {
                return `${minPeriod}_a_${maxPeriod}`;
            }
        }

        /**
         * Obt√©m o nome fantasia mais comum (ou o CNPJ se n√£o houver) para o CNPJ filtrado.
         */
        function obterNomeFantasiaPrincipal() {
            // ATUALIZA√á√ÉO: Retorna 'Empresa' se o filtro for ALL
            if (filterCNPJ.value === 'ALL') {
                return 'Empresa';
            }
            
            // Considera apenas notas do CNPJ filtrado.
            const notasFiltradas = notasFiscais.filter(n => n.cnpj === filterCNPJ.value);
            if (notasFiltradas.length === 0) return 'Empresa';

            const contagem = notasFiltradas.reduce((acc, nota) => {
                const nome = nota.nomeFantasia;
                acc[nome] = (acc[nome] || 0) + 1;
                return acc;
            }, {});

            let nomePrincipal = 'Empresa';
            let maxCount = 0;
            for (const nome in contagem) {
                if (contagem[nome] > maxCount) {
                    maxCount = contagem[nome];
                    nomePrincipal = nome;
                }
            }
            // Remove espa√ßos e substitui por underscore para o nome do arquivo
            return nomePrincipal.replace(/\s/g, '_');
        }

        /**
         * Formata a data atual para ser usada no t√≠tulo do PDF.
         */
        function formatarDataParaTitulo(data) {
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${ano} √†s ${hora}:${minuto}`;
        }
        
        /**
         * Gera o PDF com o relat√≥rio completo (incluindo resumos).
         */
        function gerarRelatorioPDF() {
            if (pdfButton.disabled) return;

            const cnpjFiltro = filterCNPJ.value;
            const grupos = gruposGlobais; 
            
            // Filtra os grupos para incluir apenas os grupos que passam pelo filtro de CNPJ
            const gruposFiltrados = Object.values(grupos).filter(grupo => {
                if (cnpjFiltro !== 'ALL' && grupo.info.cnpj !== cnpjFiltro) {
                    return false;
                }
                return true;
            });

            if (Object.keys(gruposFiltrados).length === 0) {
                alert(`Nenhuma nota fiscal encontrada para o CNPJ ${cnpjFiltro}.`);
                return;
            }
            
            const nomeFantasiaPrincipal = obterNomeFantasiaPrincipal(); // J√° considera o filtro CNPJ
            const dataAtual = new Date();
            const dataFormatada = formatarDataParaTitulo(dataAtual); 
            
            // ATUALIZA√á√ÉO: L√≥gica para o t√≠tulo do relat√≥rio
            let tituloEmpresa;
            if (cnpjFiltro === 'ALL') {
                tituloEmpresa = 'Todas as Empresas';
            } else {
                tituloEmpresa = nomeFantasiaPrincipal.replace(/_/g, ' ') + ` (CNPJ: ${cnpjFiltro})`;
            }

            const tituloRelatorio = `Relat√≥rio Fiscal da Empresa ${tituloEmpresa}, gerado em ${dataFormatada}.`;
            let htmlPDF = '<div id="relatorio-export">';
            
            // T√≠tulo no PDF
            htmlPDF += `<h1 class="pdf-report-title">${tituloRelatorio}</h1>`;

            // Incluir os resumos no PDF (Recriando a estrutura para PDF)
            // Baseia os resumos nas notas filtradas para o relat√≥rio
            const notasParaResumo = notasFiscais.filter(n => cnpjFiltro === 'ALL' || n.cnpj === cnpjFiltro);
            const resumoCFOP = {};
            const resumoPagamento = {};
            let totalGeral = 0;

            notasParaResumo.forEach(nota => {
                if (nota.statusAutorizacao.isAutorizada) {
                    // Resumo por CFOP
                    const cfopKey = nota.cfop;
                    resumoCFOP[cfopKey] = resumoCFOP[cfopKey] || { count: 0, total: 0 };
                    resumoCFOP[cfopKey].count++;
                    resumoCFOP[cfopKey].total += Math.round(nota.valorNumerico * 100) / 100;

                    // Resumo por Forma de Pagamento
                    const pagKey = nota.formaPagamento;
                    resumoPagamento[pagKey] = resumoPagamento[pagKey] || { count: 0, total: 0 };
                    resumoPagamento[pagKey].count++;
                    resumoPagamento[pagKey].total += Math.round(nota.valorNumerico * 100) / 100;
                    
                    totalGeral += Math.round(nota.valorNumerico * 100) / 100;
                }
            });
            
            // Gerar HTML do Resumo CFOP para PDF
            let htmlResumoCFOP = '<h4>Resumo por CFOP (Notas Autorizadas)</h4><table><thead><tr><th>CFOP</th><th>Quantidade</th><th>Valor Total</th></tr></thead><tbody>';
            Object.entries(resumoCFOP).sort(([, a], [, b]) => b.total - a.total).forEach(([cfop, data]) => {
                htmlResumoCFOP += `<tr><td>${cfop}</td><td>${data.count}</td><td>${formatarValor(data.total)}</td></tr>`;
            });
            htmlResumoCFOP += '</tbody></table>';

            // Gerar HTML do Resumo Pagamento para PDF
            let htmlResumoPagamento = '<h4>Resumo por Forma de Pagamento (Notas Autorizadas)</h4><table><thead><tr><th>Forma Pag.</th><th>Quantidade</th><th>Valor Total</th></tr></thead><tbody>';
            Object.entries(resumoPagamento).sort(([, a], [, b]) => b.total - a.total).forEach(([pag, data]) => {
                htmlResumoPagamento += `<tr><td>${pag}</td><td>${data.count}</td><td>${formatarValor(data.total)}</td></tr>`;
            });
            htmlResumoPagamento += '</tbody></table>';

            // Estrutura do Resumo no PDF
            htmlPDF += `<div class="resumo-section">
                <div class="resumo-table-container">${htmlResumoCFOP}</div>
                <div class="resumo-table-container">${htmlResumoPagamento}</div>
            </div>`;

            // Total Geral no PDF
            htmlPDF += `<div class="total-geral">Valor Total das Notas Fiscais AUTORIZADAS: <span>${formatarValor(totalGeral)}</span></div>`;


            // Iterar sobre os grupos filtrados (CNPJ-Mod-S√©rie)
            gruposFiltrados.forEach(grupo => {
                const info = grupo.info;
                const tipoNota = info.mod === '55' ? 'NF-e' : (info.mod === '65' ? 'NFC-e' : `Mod. ${info.mod}`);

                // T√≠tulo do Grupo no PDF
                if (cnpjFiltro === 'ALL') {
                    htmlPDF += `<div class="pdf-header">${info.emitente} | CNPJ: ${info.cnpj} | ${tipoNota} | S√©rie: ${info.serie}</div>`;
                } else {
                    htmlPDF += `<div class="pdf-header">${info.emitente} | CNPJ: ${info.cnpj} | ${tipoNota} | S√©rie: ${info.serie}</div>`;
                }

                // Tabela com colunas otimizadas para o PDF:
                // Remo√ß√£o de Chave de Acesso, Forma Pag. e Status Sequ√™ncia
                htmlPDF += `
                    <table> 
                        <thead> 
                            <tr> 
                                <th>S√©rie</th> 
                                <th>N√∫mero</th> 
                                <th>Emiss√£o</th> 
                                <th>CFOP</th> 
                                <th>Valor Total</th> 
                                <th>Status SEFAZ</th> 
                            </tr> 
                        </thead> 
                        <tbody> 
                `;
                
                // 2. Iterar sobre as notas (AGORA COM OS FILTROS DO RELAT√ìRIO APLICADOS)
                grupo.notas.forEach(nota => {
                    const modFilter = filterMod.value;
                    const statusFilter = filterStatus.value;
                    const statusAutorizacao = nota.statusAutorizacao.isAutorizada ? (nota.statusAutorizacao.isAutorizadaForaPrazo ? 'AUTORIZADA_FORA_PRAZO' : 'AUTORIZADA') : 'NAO_AUTORIZADA';

                    // Filtro de Modelo
                    if (modFilter !== 'ALL' && nota.mod !== modFilter) {
                        return;
                    }
                    
                    // Filtro de Status
                    if (statusFilter === 'AUTORIZADA' && (statusAutorizacao !== 'AUTORIZADA')) { 
                        return;
                    }
                    if (statusFilter === 'AUTORIZADA_FORA_PRAZO' && statusAutorizacao !== 'AUTORIZADA_FORA_PRAZO') {
                         return;
                    }
                    if (statusFilter === 'NAO_AUTORIZADA' && (statusAutorizacao === 'AUTORIZADA' || statusAutorizacao === 'AUTORIZADA_FORA_PRAZO')) {
                        return;
                    }

                    const statusClasse = nota.statusAutorizacao.class;
                    
                    // Linha da Tabela (Otimizada para PDF)
                    htmlPDF += `
                        <tr class="${statusClasse}">
                            <td>${nota.serie}</td>
                            <td>${nota.nNF}</td>
                            <td>${nota.dhEmi ? formatarData(nota.dhEmi) : 'N/A'}</td>
                            <td>${nota.cfop}</td>
                            <td>${formatarValor(nota.valorNumerico)}</td>
                            <td class="${statusClasse}">${nota.statusAutorizacao.text}</td>
                        </tr>
                    `;
                }); // Fim do forEach de notas
                
                htmlPDF += `</tbody></table>`;
            }); // Fim do forEach de grupos

            htmlPDF += '</div>';

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlPDF;
            document.body.appendChild(tempDiv);
            
            // --- NOVO FORMATO DO NOME DO ARQUIVO ---
            let nomeArquivo;
            if (cnpjFiltro === 'ALL') {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); 
                nomeArquivo = `Relatorio_Fiscal_Todos_CNPJs_${periodoEmissao}.pdf`;
            } else {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); // J√° considera o filtro CNPJ
                // NOVO: Adicionado CNPJ no nome do arquivo se o filtro for aplicado
                nomeArquivo = `Relatorio_Fiscal_${nomeFantasiaPrincipal}_${periodoEmissao}_${cnpjFiltro}.pdf`;
            }
            
            // Configura√ß√µes do PDF para garantir que o conte√∫do caiba
            const opt = {
                margin: 10,
                filename: nomeArquivo,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } // Mantido A4 Portrait, mas otimizado com CSS
            };

            html2pdf().set(opt).from(tempDiv).save().then(() => {
                 // Remove a div tempor√°ria ap√≥s a gera√ß√£o
                document.body.removeChild(tempDiv);
            });
        }
        
        /**
         * Compacta e baixa os arquivos XML filtrados por tipo de nota (NFE ou NFCE) e CNPJ.
         */
        function compactarEBaixarXML(tipo) {
            const modFilter = tipo === 'NFE' ? '55' : '65';
            const cnpjFilter = filterCNPJ.value;
            
            // Filtra o array global de arquivos XML
            const arquivosFiltrados = arquivosXML.filter(arq => {
                const mod = arq.chaveAcesso ? arq.chaveAcesso.substring(20, 22) : null;
                const cnpj = arq.chaveAcesso ? arq.chaveAcesso.substring(6, 20) : null; // CNPJ da chave
                
                let matchesCNPJ = true;
                if (cnpjFilter !== 'ALL' && cnpj !== cnpjFilter) {
                    matchesCNPJ = false;
                }

                // Verifica se a nota correspondente na lista de notas tem o CNPJ filtrado
                const nota = notasFiscais.find(n => n.chave === arq.chaveAcesso);
                 // Se o CNPJ da nota for diferente
                if (cnpjFilter !== 'ALL' && nota && nota.cnpj !== cnpjFilter) {
                    matchesCNPJ = false;
                }
                
                // Se n√£o encontrou a nota correspondente mas o CNPJ est√° filtrado, deve ser ignorado.
                if (cnpjFilter !== 'ALL' && !nota) { 
                    // Tenta extrair o CNPJ do XML bruto, se n√£o encontrou no cache de notasFiscais
                    const cnpjMatch = arq.content.match(/<CNPJ>(\d+)<\/CNPJ>/);
                    if (cnpjMatch && cnpjMatch[1] !== cnpjFilter) {
                        matchesCNPJ = false;
                    }
                }

                return mod === modFilter && matchesCNPJ;
            });

            if (arquivosFiltrados.length === 0) {
                const cnpjText = cnpjFilter !== 'ALL' ? ` para o CNPJ ${cnpjFilter}` : '';
                alert(`Nenhum arquivo XML do tipo ${tipo}${cnpjText} foi encontrado.`);
                return;
            }

            const zip = new JSZip();
            arquivosFiltrados.forEach(arq => {
                zip.file(arq.fileName, arq.content);
            });

            // ATUALIZA√á√ÉO: Condicional para o nome do arquivo
            let nomeArquivoZip;
            if (cnpjFilter === 'ALL') {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); 
                nomeArquivoZip = `xml-${tipo}-Todos-CNPJs-${periodoEmissao}.zip`;
            } else {
                const nomeFantasiaPrincipal = obterNomeFantasiaPrincipal(); // J√° considera o CNPJ
                const periodoEmissao = obterPeriodoEmissaoPrincipal();
                nomeArquivoZip = `xml-${tipo}-${nomeFantasiaPrincipal}-${periodoEmissao}-${cnpjFilter}.zip`;
            }

            zip.generateAsync({ type: "blob" })
                .then(function (content) {
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = nomeArquivoZip;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert(`${arquivosFiltrados.length} arquivos XML do tipo ${tipo} foram compactados e o download foi iniciado.`);
                })
                .catch(err => {
                    console.error("Erro ao gerar o ZIP:", err);
                    alert("Ocorreu um erro ao gerar o arquivo ZIP.");
                });
        }
    </script>
</body>
</html>
