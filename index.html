<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Sequ√™ncia de NF-e/NFC-e</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Paleta de Cores: Baseado na Logo (Laranja Escuro) */
        :root {
            --cor-principal: #D9531E; /* Laranja Escuro (Mais profissional) */
            --cor-secundaria: #333; /* Cinza escuro para texto e detalhes (quase preto) */
            --cor-fundo: #f4f4f9;
            --cor-borda: #ddd;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            background-color: var(--cor-fundo);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho e Logo */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--cor-principal);
            padding-bottom: 10px;
        }

        header img {
            width: 50px; /* Ajuste o tamanho da logo conforme necess√°rio */
            height: auto;
        }
        
        header h1 {
            color: var(--cor-secundaria);
            font-size: 24pt;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        #drop-area { 
            border: 3px dashed var(--cor-borda); 
            background-color: #fff;
            padding: 30px; 
            text-align: center; 
            margin-bottom: 20px; 
            cursor: pointer; 
            transition: border-color 0.3s, background-color 0.3s;
            border-radius: 8px;
            font-size: 1.1em;
        }

        #drop-area.highlight {
            border-color: var(--cor-principal);
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        
        /* Bot√µes e Filtros */
        .controls-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            margin-bottom: 20px;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            background-color: var(--cor-principal);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        
        button:hover:not(:disabled) {
            background-color: #A34017; /* Tom mais escuro do laranja */
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Select de Filtros */
        #filterMod, #filterStatus, #filterCNPJ { /* Adicionado #filterCNPJ */
            padding: 10px;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
            background-color: #fff;
            color: var(--cor-secundaria);
        }
        
        /* Tabela */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid var(--cor-borda); 
            padding: 10px; 
            text-align: left; 
            font-size: 10pt; 
        }
        th { 
            background-color: var(--cor-principal); 
            color: white; 
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        /* Estilos de Status/Sequ√™ncia */
        .quebra-indicada { 
            color: var(--cor-principal); 
            font-weight: bold; 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .sem-quebra { 
            color: #1a8a25; /* Verde escuro para OK */
            font-weight: bold;
        }
        
        /* Estilo para notas canceladas/rejeitadas */
        .status-cancelada, .status-sem-autorizacao { 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .status-autorizada { 
            background-color: #effceb; 
        }
        
        /* Relat√≥rio para Exporta√ß√£o (PDF) */
        #relatorio-export { 
            padding: 10px; /* Reduz padding para mais espa√ßo */
            background-color: #fff; 
            font-family: Arial, sans-serif; /* Padr√£o para PDF */
            font-size: 10pt; /* Define um tamanho base menor para o PDF */
        }

        /* Tabela no PDF: Otimiza√ß√£o para evitar cortes */
        #relatorio-export table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 5px; 
            table-layout: fixed; /* For√ßa o layout da tabela a ser fixo */
        }
        
        /* *** AJUSTE PARA PDF: Fonte e Padding menor para caber mais informa√ß√£o *** */
        #relatorio-export th, #relatorio-export td { 
            padding: 5px; /* Reduz o padding das c√©lulas */
            font-size: 8pt; /* Tamanho da fonte menor nas c√©lulas */
            word-wrap: break-word; /* Permite quebrar palavras longas, √∫til para chaves */
        }
        
        /* Estilo para a coluna de Valor Total no PDF para garantir que caiba */
        #relatorio-export table tbody tr td:nth-child(5) { 
            /* Se as colunas no PDF forem: S√©rie, N√∫mero, Emiss√£o, CFOP, Valor Total, Status SEFAZ */
            /* A 5a coluna √© Valor Total */
            width: 15%; 
        }
        
        /* T√≠tulo do Relat√≥rio no PDF */
        .pdf-report-title {
            font-size: 18pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px double var(--cor-principal);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho do Grupo no PDF */
        .pdf-header { 
            font-size: 11pt; 
            font-weight: bold; 
            margin-top: 25px; 
            margin-bottom: 5px; 
            border-bottom: 2px solid var(--cor-principal); 
            padding-bottom: 5px; 
            color: var(--cor-secundaria);
        }
        
        /* Destaque para o valor total (PRETO E MENOR) */
        .total-geral {
            font-size: 16pt; 
            font-weight: bold;
            padding: 10px; 
            margin-top: 30px; 
            border: 2px solid var(--cor-secundaria); /* Borda preta */
            background-color: #f9f9f9; 
            border-radius: 5px; 
            text-align: right; 
            color: var(--cor-secundaria); /* Texto preto */
        }
        
        .total-geral span {
            font-size: 1.1em;
            color: #000;
        }

        /* Estilos do T√≠tulo do Grupo */
        #relatorio-completo h2 {
            font-size: 18pt;
            color: var(--cor-secundaria);
            margin-top: 40px;
            border-bottom: 1px solid var(--cor-borda);
            padding-bottom: 5px;
        }
        
        #relatorio-completo h3 {
            font-size: 14pt;
            color: var(--cor-principal);
            background-color: #f9f9f9;
            padding: 10px;
            border-left: 5px solid var(--cor-principal);
            margin-top: 30px;
            margin-bottom: 0;
        }
        
        /* Estilos para o Resumo */
        .resumo-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .resumo-table-container {
            flex: 1;
            min-width: 300px;
        }

        .resumo-table-container h4 {
            font-size: 12pt;
            color: var(--cor-secundaria);
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--cor-borda);
        }

        .resumo-table-container table {
            width: 100%;
            margin-top: 0;
            box-shadow: none;
        }
        
        .resumo-table-container th {
            background-color: #555; /* Cinza mais escuro */
        }
        
        /* Campo de Busca */
        #search-container {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #searchInput {
            padding: 10px;
            flex-grow: 1;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
        }
        
        /* Estilos para a nova se√ß√£o de downloads/filtros */
        .download-group, .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .download-group {
            margin-left: auto; /* Empurra para a direita */
        }

    </style>
</head>
<body>

    <header>
        <img src="https://res.cloudinary.com/drsyomd2a/image/upload/v1762261454/Design-sem-nome_uxeex5.png" alt="Logo">
        <h1>Verificador de Quebra de Sequ√™ncia NF-e / NFC-e</h1>
        <div style="width: 50px;"></div> 
    </header>

    <div id="drop-area">
        Arraste e solte arquivos **XML** (ou clique para selecionar)<br>
        *Voc√™ pode adicionar arquivos de diferentes pastas consecutivamente.*
        <input type="file" id="fileElem" multiple accept=".xml" style="display: none;">
    </div>

    <div class="controls-container">
        <div class="action-group">
            <button onclick="processarNotas()" id="processButton" disabled>‚öôÔ∏è Processar e Verificar Sequ√™ncia</button>
            <button onclick="gerarRelatorioPDF()" id="pdfButton" disabled>üíæ Gerar PDF do Relat√≥rio</button>
            <button onclick="gerarDanfe()" id="danfeButton" disabled>üìÑ Gerar DANFE das Notas</button> <button onclick="limparArquivos()" id="clearButton">üóëÔ∏è Limpar Arquivos</button>
        </div>

        <div class="download-group" id="downloadGroup" style="display: none;">
            <button onclick="compactarEBaixarXML('NFE')" id="downloadNFEButton">üì¶ Baixar XMLs NF-e</button>
            <button onclick="compactarEBaixarXML('NFCE')" id="downloadNFCEButton">üì¶ Baixar XMLs NFC-e</button>
        </div>
    </div>
    
    <h2>Relat√≥rio de Notas Fiscais (Visualiza√ß√£o Completa)</h2>
    
    <div id="filter-container" style="display: none;" class="controls-container">
        
        <div class="filter-group">
            <label for="filterCNPJ">CNPJ:</label>
            <select id="filterCNPJ" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todos os CNPJs</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filterMod">Tipo de Nota:</label>
            <select id="filterMod" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (NF-e e NFC-e)</option>
                <option value="55">Somente NF-e (Mod. 55)</option>
                <option value="65">Somente NFC-e (Mod. 65)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="filterStatus">Status SEFAZ:</label>
            <select id="filterStatus" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (Autorizadas/Canceladas/Rejeitadas)</option>
                <option value="AUTORIZADA">Somente AUTORIZADAS (100)</option>
                <option value="AUTORIZADA_FORA_PRAZO">Somente AUTORIZADAS FORA DO PRAZO (150)</option>
                <option value="NAO_AUTORIZADA">Somente CANCELADAS/REJEITADAS</option>
            </select>
        </div>
        <div id="search-container" style="display: none;">
            <input type="text" id="searchInput" placeholder="Buscar por Chave, Data, N√∫mero, CNPJ ou Valor..." onkeyup="filtrarTabela()">
            <button onclick="limparBusca()">Limpar Busca</button>
        </div>
    </div>
    
    <div id="resumo-container" style="display: none;" class="resumo-section">
        </div>
    
    <div id="relatorio-completo"> 
        <div id="relatorio-container">
            <p>Carregue os arquivos XML e clique em "Processar" para gerar o relat√≥rio.</p>
        </div>
    </div>

    <script>
        // Refer√™ncias aos elementos HTML
        const fileElem = document.getElementById('fileElem');
        const dropArea = document.getElementById('drop-area');
        const relatorioContainer = document.getElementById('relatorio-container');
        const resumoContainer = document.getElementById('resumo-container');
        const searchInput = document.getElementById('searchInput');
        // const searchContainer = document.getElementById('search-container'); // Agora est√° dentro de #filter-container
        const processButton = document.getElementById('processButton');
        const pdfButton = document.getElementById('pdfButton');
        const danfeButton = document.getElementById('danfeButton'); // NOVO: Bot√£o Gerar DANFE
        const clearButton = document.getElementById('clearButton'); 
        
        // NOVO: Refer√™ncias aos novos elementos de filtro e download
        const filterContainer = document.getElementById('filter-container');
        const filterMod = document.getElementById('filterMod');
        const filterStatus = document.getElementById('filterStatus');
        const filterCNPJ = document.getElementById('filterCNPJ'); // NOVO: Refer√™ncia ao filtro CNPJ
        const downloadGroup = document.getElementById('downloadGroup');
        
        let notasFiscais = []; // Array que agora acumula as notas de todas as cargas
        let gruposGlobais = {}; 
        let arquivosXML = []; // NOVO: Armazena o conte√∫do e nome dos arquivos XML para compacta√ß√£o

        // Mapeamento de Forma de Pagamento (tPag)
        const formasPagamento = {
            '01': 'Dinheiro', '02': 'Cheque', '03': 'Cart√£o de Cr√©dito',
            '04': 'Cart√£o de D√©bito', '05': 'Cr√©dito Loja', '10': 'Vale Alimenta√ß√£o',
            '11': 'Vale Refei√ß√£o', '12': 'Vale Presente', '13': 'Vale Combust√≠vel',
            '14': 'Duplicata Mercantil', '15': 'Boleto Banc√°rio', '17': 'Pagamento Instant√¢neo (PIX)',
            '20': 'Pagamento Instant√¢neo (PIX)', '90': 'Sem Pagamento', '99': 'Outros'
        };

        // --- Configura√ß√£o de Arrastar e Soltar (Drag and Drop) ---

        ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileElem.click(), false);
        fileElem.addEventListener('change', (e) => handleFiles(e.target.files), false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        // --- Leitura e Parse dos Arquivos (AGORA ACUMULATIVO) ---

        function handleFiles(files) {
            
            pdfButton.disabled = true;
            danfeButton.disabled = true; // NOVO: Desabilita o DANFE enquanto carrega
            filterContainer.style.display = 'none'; // Usa o novo container de filtros
            downloadGroup.style.display = 'none'; // Oculta o download de XMLs
            resumoContainer.style.display = 'none';
            processButton.disabled = true; // Desabilita o processar enquanto carrega os novos

            if (files.length === 0 && notasFiscais.length === 0) {
                processButton.disabled = true;
                relatorioContainer.innerHTML = '<p>Carregue os arquivos XML e clique em "Processar" para gerar o relat√≥rio.</p>';
                return;
            } else if (files.length === 0) {
                 // Caso o usu√°rio clique no input mas cancele, reabilita o bot√£o se j√° houver notas
                processButton.disabled = (notasFiscais.length === 0);
                return;
            }

            const totalFiles = files.length;
            let filesRead = 0;
            let notasAdicionadas = 0;
            const notasAntes = notasFiscais.length;
            
            relatorioContainer.innerHTML = `<p>Lendo ${totalFiles} novos arquivos... Total anterior: ${notasAntes} notas.</p>`;

            Array.from(files).forEach(file => {
                const reader = new FileReader();

                reader.onload = (event) => {
                    filesRead++;
                    const xmlContent = event.target.result; // NOVO: Captura o conte√∫do do XML
                    try {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlContent, "application/xml");
                        
                        // Campos obrigat√≥rios para Agrupamento/Sequ√™ncia
                        const nNF = safeInt(xmlDoc, 'nNF');
                        const mod = safeText(xmlDoc, 'mod');
                        const serie = safeText(xmlDoc, 'serie');
                        const CNPJ = safeText(xmlDoc, 'CNPJ');
                        const chaveAcesso = safeText(xmlDoc, 'chNFe') || safeText(xmlDoc, 'chNFCE'); // Chave de acesso √© crucial para duplicidade

                        if (nNF && mod && serie && CNPJ !== 'N/A' && chaveAcesso) {
                            
                            // 1. VERIFICA√á√ÉO DE DUPLICIDADE (CHAVE DE ACESSO)
                            const isDuplicate = notasFiscais.some(n => n.chave === chaveAcesso);
                            
                            if (!isDuplicate) {
                                // 2. ADI√á√ÉO DA NOVA NOTA E ARQUIVO
                                const dhEmi = safeText(xmlDoc, 'dhEmi');
                                const vNF = safeText(xmlDoc, 'vNF'); 
                                const xFant = safeText(xmlDoc, 'xFant');
                                const CFOP = safeText(xmlDoc, 'CFOP');
                                const tPag = safeText(xmlDoc, 'tPag'); 
                                const cStat = safeText(xmlDoc, 'cStat');
                                const xMotivo = safeText(xmlDoc, 'xMotivo');

                                let statusCompleto = formatarStatus(cStat, xMotivo, xmlDoc);

                                notasFiscais.push({
                                    nomeArquivo: file.name,
                                    nNF: nNF,
                                    mod: mod, // Modulo (55=NF-e, 65=NFC-e)
                                    serie: serie,
                                    cnpj: CNPJ,
                                    emissao: formatarData(dhEmi),
                                    valorString: formatarValor(vNF), 
                                    valorNumerico: parseFloat(vNF) || 0, 
                                    chave: chaveAcesso,
                                    nomeFantasia: xFant || safeText(xmlDoc, 'xNome') || 'Emitente n√£o identificado',
                                    statusAutorizacao: statusCompleto,
                                    quebra: 'N√£o processado',
                                    cfop: CFOP || 'N/A',
                                    tPag: tPag || '90'
                                });
                                
                                // NOVO: Armazena o arquivo XML original
                                arquivosXML.push({
                                    fileName: file.name,
                                    content: xmlContent,
                                    mod: mod // M√≥dulo para separa√ß√£o no download
                                });

                                notasAdicionadas++;
                            } else {
                                console.warn(`Nota ${nNF} (${file.name}) ignorada: Chave de acesso j√° carregada.`);
                            }
                        }

                    } catch (e) {
                        console.error(`Erro ao processar o arquivo ${file.name}:`, e);
                    }

                    if (filesRead === totalFiles) {
                        relatorioContainer.innerHTML = `<p>${notasAdicionadas} novas notas fiscais carregadas. Total de notas prontas para processamento: ${notasFiscais.length}. Clique em "Processar" para iniciar a verifica√ß√£o.</p>`;
                        processButton.disabled = (notasFiscais.length === 0);
                    }
                };
                
                reader.onerror = (e) => {
                    filesRead++;
                    console.error("Erro ao ler o arquivo:", e);
                    if (filesRead === totalFiles) {
                        relatorioContainer.innerHTML = `<p>Ocorreu um erro ao ler um ou mais arquivos. Total de notas prontas para processamento: ${notasFiscais.length}. Clique em "Processar" para iniciar a verifica√ß√£o.</p>`;
                        processButton.disabled = (notasFiscais.length === 0);
                    }
                };

                reader.readAsText(file);
            });
        }


        // --- Fun√ß√£o de Processamento Principal ---

        function processarNotas() {
            if (notasFiscais.length === 0) {
                alert("Nenhum arquivo XML v√°lido foi carregado.");
                return;
            }

            processButton.disabled = true;
            processButton.textContent = '‚öôÔ∏è Processando...';
            
            // 1. Agrupar notas por CNPJ, Modelo e S√©rie
            const grupos = notasFiscais.reduce((acc, nota) => {
                // NOVO: Adiciona o tipo de nota no agrupamento
                const chaveGrupo = `${nota.cnpj}-${nota.mod}-${nota.serie}`;
                
                if (!acc[chaveGrupo]) {
                    acc[chaveGrupo] = {
                        info: {
                            cnpj: nota.cnpj,
                            mod: nota.mod,
                            serie: nota.serie,
                            emitente: nota.nomeFantasia
                        },
                        notas: []
                    };
                }
                acc[chaveGrupo].notas.push(nota);
                return acc;
            }, {});
            
            gruposGlobais = grupos; // Armazena grupos para uso na busca

            // 2. Verificar a sequ√™ncia dentro de cada grupo
            Object.values(grupos).forEach(grupo => {
                
                // √â crucial reordenar antes de verificar a sequ√™ncia, j√° que as notas s√£o acumuladas
                grupo.notas.sort((a, b) => a.nNF - b.nNF);

                grupo.notas.forEach((nota, index) => {
                    
                    // A l√≥gica de sequ√™ncia deve ser aplicada apenas a notas AUTORIZADAS (incluindo 150)
                    const isAutorizada = nota.statusAutorizacao.isAutorizada; // Usa a nova flag
                    
                    if (!isAutorizada) {
                        // Adiciona a quebra/classe para o HTML, mas ignora na contagem da sequ√™ncia
                        nota.quebra = 'Ignorada (N√£o Autorizada/Cancelada)';
                        nota.quebraClass = ''; 
                        return;
                    }

                    // Encontra a √∫ltima nota *autorizada* antes da nota atual
                    let ultimaNFAutorizada = null;
                    for (let i = index - 1; i >= 0; i--) {
                        if (grupo.notas[i].statusAutorizacao.isAutorizada) { // Usa a nova flag
                            ultimaNFAutorizada = grupo.notas[i];
                            break;
                        }
                    }

                    if (!ultimaNFAutorizada) {
                        // Se √© a primeira nota autorizada da sequ√™ncia (ou a √∫nica)
                        nota.quebra = 'In√≠cio da Sequ√™ncia (OK)';
                        nota.quebraClass = 'sem-quebra';
                    } else if (nota.nNF === ultimaNFAutorizada.nNF) {
                        // Caso especial: n√∫mero igual, mas chaves diferentes (imposs√≠vel em teoria, mas checa duplicidade l√≥gica)
                        // ou se o XML for o mesmo mas o filtro foi resetado. O tratamento de duplicidade da chave j√° minimiza isso.
                        // Mant√©m a duplicidade por n√∫mero apenas como erro de seguran√ßa na sequ√™ncia.
                        nota.quebra = `QUEBRA - Duplicidade de N√∫mero!`;
                        nota.quebraClass = 'quebra-indicada';
                    } else if (nota.nNF === ultimaNFAutorizada.nNF + 1) {
                        // Sequ√™ncia OK
                        nota.quebra = 'Sequ√™ncia OK';
                        nota.quebraClass = 'sem-quebra';
                    } else if (nota.nNF > ultimaNFAutorizada.nNF + 1) {
                        // Quebra na sequ√™ncia
                        const quebra = nota.nNF - ultimaNFAutorizada.nNF - 1;
                        nota.quebra = `QUEBRA - ${quebra} nota(s) faltante(s) ap√≥s a ${ultimaNFAutorizada.nNF}.`;
                        nota.quebraClass = 'quebra-indicada';
                    } else {
                        // N√∫mero menor que o anterior (Geralmente por reuso de numera√ß√£o ou erro no XML)
                        nota.quebra = `QUEBRA - N√∫mero ${nota.nNF} √© menor que o anterior ${ultimaNFAutorizada.nNF}.`;
                        nota.quebraClass = 'quebra-indicada';
                    }
                });
            });

            // 3. Atualizar o filtro de CNPJ (populando as op√ß√µes)
            const cnpjs = [...new Set(notasFiscais.map(n => n.cnpj))].sort();
            filterCNPJ.innerHTML = '<option value="ALL">Todos os CNPJs</option>';
            cnpjs.forEach(cnpj => {
                // Encontra o nome fantasia mais comum para este CNPJ (para exibi√ß√£o)
                const notasDoCnpj = notasFiscais.filter(n => n.cnpj === cnpj);
                const nomeFantasia = notasDoCnpj[0]?.nomeFantasia || cnpj; // Pega o primeiro nome fantasia encontrado
                filterCNPJ.innerHTML += `<option value="${cnpj}">${cnpj} - ${nomeFantasia}</option>`;
            });

            // 4. Gerar o relat√≥rio HTML inicial (com todos os filtros em 'ALL')
            gerarRelatorioHTML(grupos);
            gerarResumos(notasFiscais); // Gera os resumos iniciais (todos os CNPJs)

            // 5. Exibir elementos de controle e relat√≥rios
            filterContainer.style.display = 'flex'; 
            downloadGroup.style.display = 'flex';
            resumoContainer.style.display = 'flex';
            pdfButton.disabled = false;
            danfeButton.disabled = false; // NOVO: Habilita o bot√£o DANFE
            
            // 6. Aplicar filtros (se houver algum pr√©-selecionado)
            aplicarFiltrosRelatorio();
            
            processButton.disabled = false;
            processButton.textContent = '‚öôÔ∏è Processar e Verificar Sequ√™ncia';
        }

        /**
         * Gera o HTML da tabela principal do relat√≥rio, agrupado por CNPJ/Modelo/S√©rie.
         * A filtragem por CNPJ √© feita aqui antes da renderiza√ß√£o.
         */
        function gerarRelatorioHTML(grupos) {
            let html = '';
            let temGrupoVisivel = false;
            const cnpjFilter = filterCNPJ.value; // Filtro de CNPJ atual
            
            Object.keys(grupos).sort().forEach(chaveGrupo => {
                const grupo = grupos[chaveGrupo];
                const info = grupo.info;
                const notas = grupo.notas;
                
                const tipoNota = info.mod === '55' ? 'NF-e' : (info.mod === '65' ? 'NFC-e' : `Mod. ${info.mod}`); // NOVO: Tipo de nota

                // NOVO: Aplica o filtro de CNPJ no agrupamento
                if (cnpjFilter !== 'ALL' && info.cnpj !== cnpjFilter) {
                    return; // Ignora o grupo se n√£o corresponder ao filtro de CNPJ
                }

                temGrupoVisivel = true;
                
                // Adiciona o ID da chave do grupo na div de tabelas para facilitar a busca
                let htmlGrupo = `
                    <div id="table-group-${chaveGrupo}" data-mod="${info.mod}" data-cnpj="${info.cnpj}">
                        ${cnpjFilter === 'ALL' ? `<h3>üßæ ${info.emitente} (CNPJ: ${info.cnpj}) - ${tipoNota} - S√©rie: ${info.serie}</h3>` : `<h3>üßæ ${tipoNota} - S√©rie: ${info.serie}</h3>`}
                        <table id="table-${chaveGrupo}">
                            <thead>
                                <tr>
                                    <th>S√©rie</th>
                                    <th>N√∫mero</th>
                                    <th>Emiss√£o</th>
                                    <th>CFOP</th>
                                    <th>Forma Pag.</th>
                                    <th>Valor Total</th>
                                    <th>Chave de Acesso</th>
                                    <th>Status SEFAZ</th>
                                    <th>Status Sequ√™ncia</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                notas.forEach(nota => {
                    const quebraClass = nota.quebraClass || (nota.quebra.includes('QUEBRA') || nota.quebra.includes('DUPLICIDADE') ? 'quebra-indicada' : (nota.quebra.includes('OK') || nota.quebra.includes('In√≠cio') ? 'sem-quebra' : ''));
                    const statusRowClass = nota.statusAutorizacao.class;
                    const nomePagamento = formasPagamento[nota.tPag] || 'Outros (99)';
                    
                    // Adiciona a classe de status na linha para f√°cil filtragem/busca
                    htmlGrupo += `
                        <tr class="${statusRowClass}">
                            <td>${nota.serie}</td>
                            <td>${nota.nNF}</td>
                            <td>${nota.emissao}</td>
                            <td>${nota.cfop}</td>
                            <td>${nomePagamento}</td>
                            <td>${nota.valorString}</td>
                            <td>${nota.chave}</td>
                            <td>${nota.statusAutorizacao.text}</td>
                            <td class="${quebraClass}">${nota.quebra}</td>
                        </tr>
                    `;
                });

                htmlGrupo += `
                            </tbody>
                        </table>
                    </div>
                `;
                html += htmlGrupo;
            });
            
            if (!temGrupoVisivel) {
                 html = `<p>Nenhuma nota fiscal encontrada para os filtros selecionados (CNPJ: ${cnpjFilter}).</p>`;
            }

            // Adiciona o total geral (que agora considera o filtro de CNPJ)
            const totalGeral = calcularTotalGeral();
            let totalTitle = 'TOTAL GERAL DAS NOTAS';
            if (cnpjFilter !== 'ALL') {
                totalTitle = `TOTAL DO CNPJ ${cnpjFilter}`;
            }

            html += `<div class="total-geral">${totalTitle}: <span>${totalGeral}</span></div>`;

            relatorioContainer.innerHTML = html;
            searchInput.parentNode.style.display = 'flex'; // Exibe a barra de busca
        }

        // --- Fun√ß√µes de Download e Exporta√ß√£o ---

        /**
         * Compacta e baixa os arquivos XML, filtrando por tipo (NFE/NFCE) e CNPJ.
         * @param {string} tipo - 'NFE' ou 'NFCE'
         */
        function compactarEBaixarXML(tipo) {
            const modFilter = tipo === 'NFE' ? '55' : '65';
            const cnpjFilter = filterCNPJ.value;
            
            // Filtra os arquivos XML armazenados (pela MOD e CNPJ)
            const arquivosFiltrados = arquivosXML.filter(arq => {
                let matchesCNPJ = true;
                // Busca a nota correspondente no cache de notasFiscais para verificar o CNPJ
                const nota = notasFiscais.find(n => n.chave === safeText({querySelector: (s) => arq.content.includes('<chNFe>') ? {textContent: arq.content.match(/<chNFe>(\d+)<\/chNFe>/)?.[1]} : {textContent: arq.content.match(/<chNFCE>(\d+)<\/chNFCE>/)?.[1]}}, 'chNFe') || safeText({querySelector: (s) => arq.content.includes('<chNFe>') ? {textContent: arq.content.match(/<chNFe>(\d+)<\/chNFe>/)?.[1]} : {textContent: arq.content.match(/<chNFCE>(\d+)<\/chNFCE>/)?.[1]}}, 'chNFCE'));
                
                // Se a nota for diferente
                if (cnpjFilter !== 'ALL' && nota && nota.cnpj !== cnpjFilter) {
                    matchesCNPJ = false;
                }
                
                // Se n√£o encontrou a nota correspondente mas o CNPJ est√° filtrado, deve ser ignorado.
                if (cnpjFilter !== 'ALL' && !nota) {
                    // Tenta extrair o CNPJ do XML bruto, se n√£o encontrou no cache de notasFiscais
                    const cnpjMatch = arq.content.match(/<CNPJ>(\d+)<\/CNPJ>/);
                    if (cnpjMatch && cnpjMatch[1] !== cnpjFilter) {
                        matchesCNPJ = false;
                    }
                }

                return arq.mod === modFilter && matchesCNPJ;
            });

            if (arquivosFiltrados.length === 0) {
                const cnpjText = cnpjFilter !== 'ALL' ? ` para o CNPJ ${cnpjFilter}` : '';
                alert(`Nenhum arquivo XML do tipo ${tipo}${cnpjText} foi encontrado.`);
                return;
            }

            // ATUALIZA√á√ÉO: Condicional para o nome do arquivo
            let nomeArquivoZip;
            if (cnpjFilter === 'ALL') {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); 
                nomeArquivoZip = `xml-${tipo}-Todos-CNPJs-${periodoEmissao}.zip`;
            } else {
                const nomeFantasiaPrincipal = obterNomeFantasiaPrincipal(); // J√° considera o CNPJ filtrado
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); // J√° considera o CNPJ filtrado
                // NOVO: Adicionado o CNPJ no nome do arquivo se o filtro for aplicado
                nomeArquivoZip = `xml-${tipo}-${nomeFantasiaPrincipal}-${periodoEmissao}_${cnpjFilter}.zip`;
            }

            const zip = new JSZip();

            // Adiciona cada arquivo XML ao objeto ZIP
            arquivosFiltrados.forEach(arq => {
                // Remove caracteres inv√°lidos do nome do arquivo (necess√°rio para zip)
                const nomeSeguro = arq.fileName.replace(/[\\/:*?"<>|]/g, "_");
                zip.file(nomeSeguro, arq.content);
            });

            // Gera e baixa o arquivo ZIP
            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = nomeArquivoZip;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    alert(`O arquivo ${nomeArquivoZip} com ${arquivosFiltrados.length} XMLs foi gerado com sucesso!`);
                })
                .catch(err => {
                    console.error("Erro ao gerar o arquivo ZIP:", err);
                    alert("Erro ao gerar o arquivo ZIP. Consulte o console para detalhes.");
                });
        }
        
        /**
         * Implementa√ß√£o da funcionalidade para gerar o DANFE das notas fiscais importadas
         * usando a API externa fornecida.
         */
        function gerarDanfe() {
            const cnpjFiltro = filterCNPJ.value;
            
            // 1. Filtrar as notas baseado nos filtros aplicados (Apenas AUTORIZADAS)
            const notasParaDanfe = notasFiscais.filter(n => 
                (cnpjFiltro === 'ALL' || n.cnpj === cnpjFiltro) &&
                n.statusAutorizacao.isAutorizada // Apenas notas AUTORIZADAS (100 ou 150)
            );

            if (notasParaDanfe.length === 0) {
                alert("Nenhuma nota fiscal autorizada encontrada para gerar o DANFE com os filtros atuais.");
                return;
            }
            
            // Desabilita o bot√£o enquanto processa para evitar cliques duplicados
            danfeButton.disabled = true;
            danfeButton.textContent = 'Aguarde... Gerando DANFEs';
            
            // URL da API fornecida pelo usu√°rio
            const API_URL = 'https://consultadanfe.com/CDanfe/api_generate';
            
            let countSuccess = 0;
            let countError = 0;
            
            // Fun√ß√£o ass√≠ncrona para processar nota por nota
            async function processarNota(nota) {
                const chaveAcesso = nota.chave;
                
                try {
                    // Requisi√ß√£o POST para a API de gera√ß√£o de DANFE. 
                    // *NOTA: O formato exato do payload e da resposta depende da API externa.
                    // Aqui assumimos que √© um POST com a chave no corpo e retorna um link/objeto.*
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // N√£o √© necess√°rio autentica√ß√£o, mas se houvesse, seria adicionada aqui.
                        },
                        body: JSON.stringify({
                            chaveNFe: chaveAcesso, // Assumindo 'chaveNFe' como o par√¢metro da chave
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Falha HTTP ao gerar DANFE para chave ${chaveAcesso}: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    // Tenta obter a URL do PDF (muitas APIs usam 'url' ou 'pdfUrl')
                    const danfeUrl = result.pdfUrl || result.url || (typeof result === 'string' && result.startsWith('http') ? result : null);

                    if (danfeUrl) {
                        // Abre o DANFE em uma nova aba/janela
                        window.open(danfeUrl, '_blank');
                        countSuccess++;
                    } else {
                        throw new Error(`Resposta da API para chave ${chaveAcesso} n√£o cont√©m URL de DANFE.`);
                    }

                } catch (error) {
                    console.error(`Falha ao gerar DANFE para chave ${chaveAcesso}:`, error);
                    countError++;
                }
            }
            
            // Executa o processamento para todas as notas selecionadas
            Promise.all(notasParaDanfe.map(processarNota))
                .finally(() => {
                    // Reabilita o bot√£o e mostra o resultado
                    danfeButton.disabled = false;
                    danfeButton.textContent = 'üìÑ Gerar DANFE das Notas';
                    
                    let message = `Tentativa de gera√ß√£o de DANFE conclu√≠da:\n`;
                    message += `${countSuccess} DANFE(s) iniciado(s) para download (verifique as novas abas).\n`;
                    if (countError > 0) {
                        message += `${countError} falha(s) na comunica√ß√£o com a API (Verifique o Console do navegador para detalhes).`;
                    } else if (countSuccess === 0) {
                         message = "Nenhum DANFE foi aberto. Verifique os filtros e se o navegador bloqueou as novas janelas (pop-ups).";
                    }
                    alert(message);
                });
        }


        /**
         * Gera o Relat√≥rio Completo (HTML) e exporta para PDF usando html2pdf.js
         */
        function gerarRelatorioPDF() {
            // Desabilita o bot√£o
            pdfButton.disabled = true;
            pdfButton.textContent = 'Aguarde... Gerando PDF';

            const cnpjFiltro = filterCNPJ.value;
            
            // 1. Filtrar as notas baseado no filtro de CNPJ (Apenas CNPJ selecionado ou todos)
            const notasParaPDF = notasFiscais.filter(n => cnpjFiltro === 'ALL' || n.cnpj === cnpjFiltro);

            if (notasParaPDF.length === 0) {
                alert(`Nenhuma nota fiscal encontrada para o CNPJ ${cnpjFiltro} para gerar o PDF.`);
                pdfButton.disabled = false;
                pdfButton.textContent = 'üíæ Gerar PDF do Relat√≥rio';
                return;
            }

            // 2. Re-agrupar e verificar sequ√™ncia (necess√°rio se o CNPJ do filtro mudou desde o √∫ltimo processamento)
            const grupos = notasParaPDF.reduce((acc, nota) => {
                const chaveGrupo = `${nota.cnpj}-${nota.mod}-${nota.serie}`;
                if (!acc[chaveGrupo]) {
                    acc[chaveGrupo] = {
                        info: {
                            cnpj: nota.cnpj,
                            mod: nota.mod,
                            serie: nota.serie,
                            emitente: nota.nomeFantasia
                        },
                        notas: []
                    };
                }
                acc[chaveGrupo].notas.push(nota);
                return acc;
            }, {});

            if (Object.keys(grupos).length === 0) {
                alert(`Nenhuma nota fiscal encontrada para o CNPJ ${cnpjFiltro}.`);
                pdfButton.disabled = false;
                pdfButton.textContent = 'üíæ Gerar PDF do Relat√≥rio';
                return;
            }
            
            const nomeFantasiaPrincipal = obterNomeFantasiaPrincipal(); // J√° considera o filtro CNPJ
            const dataAtual = new Date();
            const dataFormatada = formatarDataParaTitulo(dataAtual); 
            
            // ATUALIZA√á√ÉO: L√≥gica para o t√≠tulo do relat√≥rio
            let tituloEmpresa;
            if (cnpjFiltro === 'ALL') {
                tituloEmpresa = 'Todas as Empresas';
            } else {
                tituloEmpresa = nomeFantasiaPrincipal.replace(/_/g, ' ') + ` (CNPJ: ${cnpjFiltro})`;
            }
            
            const tituloRelatorio = `Relat√≥rio Fiscal da Empresa ${tituloEmpresa}, gerado em ${dataFormatada}.`;

            let htmlPDF = '<div id="relatorio-export">';
            
            // T√≠tulo no PDF
            htmlPDF += `<h1 class="pdf-report-title">${tituloRelatorio}</h1>`;

            // Incluir os resumos no PDF (Recriando a estrutura para PDF)
            const resumoCFOP = {};
            const resumoPagamento = {};

            // Baseia os resumos nas notas filtradas para o PDF
            notasParaPDF.forEach(nota => {
                if (nota.statusAutorizacao.isAutorizada) { // Usa a nova flag de autoriza√ß√£o
                    // Resumo por CFOP
                    const cfopKey = nota.cfop;
                    resumoCFOP[cfopKey] = resumoCFOP[cfopKey] || { count: 0, total: 0 };
                    resumoCFOP[cfopKey].count++;
                    resumoCFOP[cfopKey].total += Math.round(nota.valorNumerico * 100);

                    // Resumo por Forma de Pagamento (tPag)
                    const pagKey = nota.tPag;
                    resumoPagamento[pagKey] = resumoPagamento[pagKey] || { count: 0, total: 0 };
                    resumoPagamento[pagKey].count++;
                    resumoPagamento[pagKey].total += Math.round(nota.valorNumerico * 100);
                }
            });
            
            // Gera√ß√£o do HTML do Resumo CFOP para o PDF
            let htmlCFOP = `
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="font-size: 11pt; border-bottom: 1px solid #ddd;">Resumo por CFOP (Notas Autorizadas)</h4>
                    <table style="font-size: 7pt; margin-bottom: 10px;">
                        <thead><tr><th>CFOP</th><th>Quantidade</th><th>Valor Total</th></tr></thead>
                        <tbody>
            `;
            let totalCFOP = 0;
            Object.keys(resumoCFOP).sort().forEach(cfop => {
                const item = resumoCFOP[cfop];
                htmlCFOP += `<tr><td>${cfop}</td><td>${item.count}</td><td>${formatarValor(item.total / 100)}</td></tr>`;
                totalCFOP += item.total;
            });
            htmlCFOP += `<tr><td style="font-weight: bold;">TOTAL</td><td style="font-weight: bold;"></td><td style="font-weight: bold;">${formatarValor(totalCFOP / 100)}</td></tr>`;
            htmlCFOP += `</tbody></table></div>`;

            // Gera√ß√£o do HTML do Resumo Pagamento para o PDF
            let htmlPag = `
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="font-size: 11pt; border-bottom: 1px solid #ddd;">Resumo por Forma de Pagamento (Notas Autorizadas)</h4>
                    <table style="font-size: 7pt;">
                        <thead><tr><th>Pagamento</th><th>Quantidade</th><th>Valor Total</th></tr></thead>
                        <tbody>
            `;
            let totalPag = 0;
            Object.keys(resumoPagamento).sort((a, b) => (formasPagamento[a] || 'Outros').localeCompare(formasPagamento[b] || 'Outros')).forEach(pag => {
                const item = resumoPagamento[pag];
                const nomePag = formasPagamento[pag] || `Outros (${pag})`;
                htmlPag += `<tr><td>${nomePag}</td><td>${item.count}</td><td>${formatarValor(item.total / 100)}</td></tr>`;
                totalPag += item.total;
            });
            htmlPag += `<tr><td style="font-weight: bold;">TOTAL</td><td style="font-weight: bold;"></td><td style="font-weight: bold;">${formatarValor(totalPag / 100)}</td></tr>`;
            htmlPag += `</tbody></table></div>`;

            // Adiciona os resumos ao HTML do PDF
            htmlPDF += `<div style="display: flex; gap: 10px; margin-bottom: 20px;">${htmlCFOP}${htmlPag}</div>`;
            
            let totalGeralNotas = 0;

            // 3. Iterar sobre os grupos e gerar as tabelas otimizadas para PDF
            Object.keys(grupos).sort().forEach(chaveGrupo => {
                const grupo = grupos[chaveGrupo];
                const info = grupo.info;
                const notas = grupo.notas;
                
                const tipoNota = info.mod === '55' ? 'NF-e' : (info.mod === '65' ? 'NFC-e' : `Mod. ${info.mod}`);

                if (cnpjFiltro !== 'ALL') {
                    htmlPDF += `<div class="pdf-header">${tipoNota} | S√©rie: ${info.serie}</div>`;
                } else {
                    htmlPDF += `<div class="pdf-header">${info.emitente} | CNPJ: ${info.cnpj} | ${tipoNota} | S√©rie: ${info.serie}</div>`;
                }

                // Tabela com colunas otimizadas para o PDF:
                // Remo√ß√£o de Chave de Acesso, Forma Pag. e Status Sequ√™ncia
                htmlPDF += `
                    <table>
                        <thead>
                            <tr>
                                <th>S√©rie</th>
                                <th>N√∫mero</th>
                                <th>Emiss√£o</th>
                                <th>CFOP</th>
                                <th>Valor Total</th>
                                <th>Status SEFAZ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                notas.forEach(nota => {
                    const statusFinal = nota.statusAutorizacao.text;
                    const statusRowClass = nota.statusAutorizacao.class;
                    
                    htmlPDF += `
                        <tr class="${statusRowClass}">
                            <td>${nota.serie}</td>
                            <td>${nota.nNF}</td>
                            <td>${nota.emissao}</td>
                            <td>${nota.cfop}</td>
                            <td>${nota.valorString}</td>
                            <td>${statusFinal}</td>
                        </tr>
                    `;
                    totalGeralNotas += nota.valorNumerico;
                });
                
                htmlPDF += `
                        </tbody>
                    </table>
                `;
                
                // Adiciona uma quebra de p√°gina se n√£o for o √∫ltimo grupo e for o filtro de todos os CNPJs
                if (cnpjFiltro === 'ALL' && chaveGrupo !== Object.keys(grupos).sort().pop()) {
                     // Adiciona uma quebra de p√°gina suave para tentar agrupar as tabelas
                    htmlPDF += `<div style="page-break-after: always; height: 10px;"></div>`; 
                }
            });
            
            // Total Geral
            htmlPDF += `<div class="total-geral" style="margin-top: 20px; font-size: 12pt;">TOTAL DE NOTAS EXIBIDAS: <span>${formatarValor(totalGeralNotas)}</span></div>`;
            
            htmlPDF += '</div>';

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlPDF;
            document.body.appendChild(tempDiv);
            
            // --- NOVO FORMATO DO NOME DO ARQUIVO ---
            let nomeArquivo;
            if (cnpjFiltro === 'ALL') {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); 
                nomeArquivo = `Relatorio_Fiscal_Todos_CNPJs_${periodoEmissao}.pdf`;
            } else {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); // J√° considera o filtro CNPJ
                // NOVO: Adicionado CNPJ no nome do arquivo se o filtro for aplicado
                nomeArquivo = `Relatorio_Fiscal_${nomeFantasiaPrincipal}_${periodoEmissao}_${cnpjFiltro}.pdf`;
            }
            
            // Configura√ß√µes do PDF para garantir que o conte√∫do caiba
            const opt = {
                margin: 10,
                filename: nomeArquivo,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } // Mantido A4 Portrait, mas otimizado com CSS
            };

            html2pdf().set(opt).from(tempDiv).save().then(() => {
                 // Remove a div tempor√°ria ap√≥s a gera√ß√£o
                document.body.removeChild(tempDiv);
                pdfButton.disabled = false;
                pdfButton.textContent = 'üíæ Gerar PDF do Relat√≥rio';
            }).catch(error => {
                console.error("Erro ao gerar PDF:", error);
                document.body.removeChild(tempDiv);
                pdfButton.disabled = false;
                pdfButton.textContent = 'üíæ Gerar PDF do Relat√≥rio';
                alert("Ocorreu um erro ao gerar o PDF. Verifique o console.");
            });
        }


        // --- Gera√ß√£o de Resumos (CFOP e Pagamento) ---

        function gerarResumos(notas) {
            const resumoCFOP = {};
            const resumoPagamento = {};

            // NOVO: Filtrar as notas pelo CNPJ selecionado (se n√£o for 'ALL')
            const notasParaResumo = notas.filter(n => filterCNPJ.value === 'ALL' || n.cnpj === filterCNPJ.value);

            if (notasParaResumo.length === 0 && filterCNPJ.value !== 'ALL') {
                resumoContainer.innerHTML = `<p>Nenhuma nota fiscal encontrada para o CNPJ ${filterCNPJ.value} para gerar os resumos.</p>`;
                resumoContainer.style.display = 'flex';
                return;
            }

            notasParaResumo.forEach(nota => {
                // Apenas notas AUTORIZADAS (incluindo 150) para os resumos
                if (nota.statusAutorizacao.isAutorizada) {
                    
                    // Resumo por CFOP
                    const cfopKey = nota.cfop;
                    resumoCFOP[cfopKey] = resumoCFOP[cfopKey] || { count: 0, total: 0 };
                    resumoCFOP[cfopKey].count++;
                    resumoCFOP[cfopKey].total += Math.round(nota.valorNumerico * 100);

                    // Resumo por Forma de Pagamento (tPag)
                    const pagKey = nota.tPag;
                    resumoPagamento[pagKey] = resumoPagamento[pagKey] || { count: 0, total: 0 };
                    resumoPagamento[pagKey].count++;
                    resumoPagamento[pagKey].total += Math.round(nota.valorNumerico * 100);
                }
            });

            // Gera√ß√£o do HTML do Resumo CFOP
            let htmlCFOP = `
                <div class="resumo-table-container">
                    <h4>Resumo por CFOP (Notas Autorizadas)</h4>
                    <table>
                        <thead><tr><th>CFOP</th><th>Quantidade</th><th>Valor Total</th></tr></thead>
                        <tbody>
            `;
            let totalCFOP = 0;
            Object.keys(resumoCFOP).sort().forEach(cfop => {
                const item = resumoCFOP[cfop];
                htmlCFOP += `<tr><td>${cfop}</td><td>${item.count}</td><td>${formatarValor(item.total / 100)}</td></tr>`;
                totalCFOP += item.total;
            });
            htmlCFOP += `<tr><td style="font-weight: bold;">TOTAL</td><td style="font-weight: bold;"></td><td style="font-weight: bold;">${formatarValor(totalCFOP / 100)}</td></tr>`;
            htmlCFOP += `</tbody></table></div>`;

            // Gera√ß√£o do HTML do Resumo Pagamento
            let htmlPag = `
                <div class="resumo-table-container">
                    <h4>Resumo por Forma de Pagamento (Notas Autorizadas)</h4>
                    <table>
                        <thead><tr><th>Pagamento</th><th>Quantidade</th><th>Valor Total</th></tr></thead>
                        <tbody>
            `;
            let totalPag = 0;
            Object.keys(resumoPagamento).sort((a, b) => (formasPagamento[a] || 'Outros').localeCompare(formasPagamento[b] || 'Outros')).forEach(pag => {
                const item = resumoPagamento[pag];
                const nomePag = formasPagamento[pag] || `Outros (${pag})`;
                htmlPag += `<tr><td>${nomePag}</td><td>${item.count}</td><td>${formatarValor(item.total / 100)}</td></tr>`;
                totalPag += item.total;
            });
            htmlPag += `<tr><td style="font-weight: bold;">TOTAL</td><td style="font-weight: bold;"></td><td style="font-weight: bold;">${formatarValor(totalPag / 100)}</td></tr>`;
            htmlPag += `</tbody></table></div>`;

            resumoContainer.innerHTML = htmlCFOP + htmlPag;
            resumoContainer.style.display = 'flex';
        }

        // --- FUN√á√ïES DE FILTRO (ATUALIZADA) ---

        function aplicarFiltrosRelatorio() {
            // Re-gera a parte visual (tabelas e total) com o novo CNPJ
            gerarRelatorioHTML(gruposGlobais); // Vai ignorar grupos que n√£o batem com o filterCNPJ.value

            // 2. Recalcula e exibe os resumos se o CNPJ mudar (ou outros filtros, mas o CNPJ √© o mais relevante aqui).
            gerarResumos(notasFiscais); 

            // 3. Re-executa a busca para garantir que a combina√ß√£o de filtros funcione
            filtrarTabela(searchInput.value.toUpperCase()); // Aplica a busca e os filtros de Mod/Status/CNPJ nas TRs vis√≠veis
        }

        // --- FUN√á√ïES DE BUSCA/FILTRO (ATUALIZADA) ---
        
        function filtrarTabela(filtroBusca = searchInput.value.toUpperCase()) {
            const tables = relatorioContainer.querySelectorAll('table');
            const filtroCNPJ = filterCNPJ.value; // NOVO: CNPJ
            const filtroMod = filterMod.value;
            const filtroStatus = filterStatus.value;
            
            tables.forEach(table => {
                const tableGroupDiv = table.closest('div[data-cnpj]');
                if (!tableGroupDiv) return;

                const modGrupo = tableGroupDiv.getAttribute('data-mod');
                const cnpjGrupo = tableGroupDiv.getAttribute('data-cnpj');
                
                // O filtro de CNPJ (e a visibilidade do grupo) √© tratado em gerarRelatorioHTML
                // Apenas se o grupo estiver vis√≠vel (n√£o filtrado por CNPJ)
                if (filtroCNPJ !== 'ALL' && cnpjGrupo !== filtroCNPJ) {
                    tableGroupDiv.style.display = 'none'; // Deveria estar invis√≠vel pelo gerarRelatorioHTML, mas garante.
                    return; 
                } else {
                     tableGroupDiv.style.display = '';
                }

                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    let showRow = true;

                    // 1. Aplica o filtro de Tipo de Nota (Mod. 55 / 65)
                    if (filtroMod !== 'ALL' && modGrupo !== filtroMod) {
                        showRow = false;
                    }
                    
                    // 2. Aplica o filtro de Status SEFAZ (classes de TR)
                    const rowClassList = Array.from(row.classList);
                    const statusRow = rowClassList.find(c => c.startsWith('status-'))?.replace('status-', '') || 'NAO_AUTORIZADA'; // Pega a classe de status
                    
                    if (filtroStatus === 'AUTORIZADA' && statusRow !== 'autorizada') {
                        showRow = false;
                    } else if (filtroStatus === 'AUTORIZADA_FORA_PRAZO' && statusRow !== 'autorizada' && statusRow !== 'autorizada_fora_prazo') {
                        showRow = false;
                    } else if (filtroStatus === 'NAO_AUTORIZADA' && (statusRow === 'autorizada' || statusRow === 'autorizada_fora_prazo')) {
                        showRow = false;
                    }

                    // 3. Aplica o filtro de busca textual/CNPJ
                    if (filtroBusca !== '') {
                        let matchesSearch = false;
                        
                        // Verifica se o CNPJ do grupo corresponde ao filtro de busca
                        if (cnpjGrupo && cnpjGrupo.toUpperCase().indexOf(filtroBusca) > -1) {
                            matchesSearch = true;
                        } else {
                             // Percorre todas as c√©lulas (td) da linha
                            for (let j = 0; j < row.cells.length; j++) {
                                const td = row.cells[j];
                                if (td) {
                                    const text = td.textContent || td.innerText;
                                    if (text.toUpperCase().indexOf(filtroBusca) > -1) {
                                        matchesSearch = true;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // A linha s√≥ deve ser mostrada se passar pelos filtros E pela busca
                        showRow = showRow && matchesSearch;
                    }

                    row.style.display = showRow ? "" : "none";
                });
                
            });

            // NOVO: Adiciona o total novamente (que agora calcula baseado no filtro de CNPJ)
            const totalGeralElement = document.querySelector('.total-geral');
            if (totalGeralElement) {
                const totalGeral = calcularTotalGeral(); // ATUALIZA√á√ÉO: L√≥gica para o total geral
                let totalTitle = 'TOTAL GERAL DAS NOTAS';
                if (filterCNPJ.value !== 'ALL') {
                    totalTitle = `TOTAL DO CNPJ ${filterCNPJ.value}`;
                }
                totalGeralElement.innerHTML = `${totalTitle}: <span>${totalGeral}</span>`;
            }

        }
        
        function limparBusca() {
            searchInput.value = '';
            filtrarTabela('');
        }

        // --- Fun√ß√µes Auxiliares de Estado ---
        
        function limparArquivos() {
            // Reinicia o estado da aplica√ß√£o
            notasFiscais = []; 
            gruposGlobais = {}; 
            arquivosXML = []; // NOVO: Limpa o array de arquivos XML

            // Reseta o estado dos bot√µes e containers
            processButton.disabled = true;
            pdfButton.disabled = true;
            danfeButton.disabled = true; // NOVO: Desabilita o bot√£o DANFE
            filterContainer.style.display = 'none'; // Oculta o container de filtros
            downloadGroup.style.display = 'none'; // Oculta o download de XMLs
            searchInput.value = '';
            filterMod.value = 'ALL'; // Reseta filtros
            filterStatus.value = 'ALL'; // Reseta filtros
            filterCNPJ.value = 'ALL'; // NOVO: Reseta filtro CNPJ
            filterCNPJ.innerHTML = '<option value="ALL">Todos os CNPJs</option>'; // Limpa op√ß√µes de CNPJ
            relatorioContainer.innerHTML = '<p>Todos os arquivos foram removidos. Arraste e solte ou clique para carregar novos arquivos XML.</p>';
            resumoContainer.style.display = 'none';
        }

        // --- Fun√ß√µes Auxiliares de Leitura e Formata√ß√£o (SEM ALTERA√á√ïES) ---

        function safeText(xmlDoc, tagName) {
            let element;
            
            // Tratamento especial para CFOP (dentro de det/prod)
            if (tagName === 'CFOP') {
                // Procura por <det><prod><CFOP> ou <det><CFOP>
                element = xmlDoc.querySelector('det prod CFOP, det CFOP');
                if (element) return element.textContent;
            }
            
            // Tratamento especial para tPag (dentro de pag) - (NFC-e ou NF-e com detalhes)
            if (tagName === 'tPag') {
                // Procura por <pag><detPag><tPag> ou <pag><tPag>
                element = xmlDoc.querySelector('pag detPag tPag, pag tPag');
                if (element) return element.textContent;
            }
            
            // Procura o elemento geral
            element = xmlDoc.querySelector(tagName);
            
            // Se n√£o encontrou no n√≥ principal, tenta buscar dentro de <infNFe> ou <ide>
            if (!element) {
                element = xmlDoc.querySelector(`infNFe ${tagName}, ide ${tagName}, emit ${tagName}, ICMSUFDest ${tagName}, total ICMSTot ${tagName}, infProt ${tagName}`);
            }
            
            // Se ainda n√£o encontrou (ex: CNPJ), tenta buscar no n√≥ <dest>
            if (!element && tagName === 'CNPJ') {
                element = xmlDoc.querySelector(`dest ${tagName}`);
            }

            // Se for cStat ou xMotivo, prioriza o infProt (protocolo de autoriza√ß√£o)
            if ((tagName === 'cStat' || tagName === 'xMotivo') && xmlDoc.querySelector('infProt')) {
                 element = xmlDoc.querySelector(`infProt ${tagName}`);
            }
            
            if (element) {
                return element.textContent;
            } else {
                return 'N/A';
            }
        }

        function safeInt(xmlDoc, tagName) {
             const text = safeText(xmlDoc, tagName);
             return parseInt(text, 10) || 0;
        }

        function formatarData(dataHora) {
            if (!dataHora || dataHora === 'N/A') return 'N/A';

            // Tenta lidar com o formato 'AAAA-MM-DDTHH:MM:SSTZ' ou apenas 'AAAA-MM-DDTHH:MM:SS'
            try {
                // Remove o 'T' e o fuso hor√°rio (se houver) para simplificar a convers√£o para Date
                const cleanDateTime = dataHora.replace('T', ' ').split(/[-+]/)[0].trim();
                
                // Se a string contiver fuso hor√°rio (Z ou +/-HH:MM), o Date.parse() ou new Date() pode funcionar
                const dateObj = new Date(dataHora); 
                
                // Se a data for inv√°lida, tenta um parse manual (ISO 8601 sem TZ pode ser interpretado como UTC ou Local)
                if (isNaN(dateObj)) {
                    const [datePart, timePart] = cleanDateTime.split(' ');
                    const [year, month, day] = datePart.split('-').map(Number);
                    
                    if (year && month && day) {
                        // Cria a data no fuso hor√°rio local para evitar desvios de fuso
                         const [hour = 0, minute = 0, second = 0] = (timePart || '0:0:0').split(':').map(Number);
                         const localDate = new Date(year, month - 1, day, hour, minute, second);
                         
                         return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    }
                    return dataHora; // Retorna a string original se o parse falhar
                }
                
                // Retorna no formato DD/MM/AAAA HH:MM (usando fun√ß√µes de data UTC/ISO para ser consistente)
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                const hour = String(dateObj.getHours()).padStart(2, '0');
                const minute = String(dateObj.getMinutes()).padStart(2, '0');
                
                return `${day}/${month}/${year} ${hour}:${minute}`;

            } catch (e) {
                console.error("Erro ao formatar data:", dataHora, e);
                return dataHora.split('T')[0]; // Retorna apenas a data em caso de erro
            }
        }
        
        /**
         * Encontra o nome fantasia do CNPJ atualmente filtrado ou o mais comum (se ALL)
         */
        function obterNomeFantasiaPrincipal() {
            // ATUALIZA√á√ÉO: Retorna 'Empresa' se o filtro for ALL
            if (filterCNPJ.value === 'ALL') {
                return 'Empresa';
            }

            // Considera apenas notas do CNPJ filtrado.
            const notasFiltradas = notasFiscais.filter(n => n.cnpj === filterCNPJ.value);
            if (notasFiltradas.length === 0) return 'Empresa';

            const contagem = notasFiltradas.reduce((acc, nota) => {
                const nome = nota.nomeFantasia;
                acc[nome] = (acc[nome] || 0) + 1;
                return acc;
            }, {});

            let nomePrincipal = 'Empresa';
            let maxCount = 0;
            for (const nome in contagem) {
                if (contagem[nome] > maxCount) {
                    maxCount = contagem[nome];
                    nomePrincipal = nome;
                }
            }
            
            // Remove espa√ßos e substitui por underscore para o nome do arquivo
            return nomePrincipal.replace(/\s/g, '_');
        }

        /**
         * Encontra o per√≠odo de emiss√£o (m√™s/ano) das notas carregadas.
         * AGORA: Considera apenas o CNPJ filtrado.
         */
        function obterPeriodoEmissaoPrincipal() {
            // NOVO: Considera apenas notas do CNPJ filtrado, se houver filtro.
            const notasFiltradas = notasFiscais.filter(n => filterCNPJ.value === 'ALL' || n.cnpj === filterCNPJ.value);

            if (notasFiltradas.length === 0) return '';
            
            // Formato de emiss√£o √© DD/MM/AAAA HH:MM
            const datas = notasFiltradas.map(n => n.emissao.split('/')[1] + '/' + n.emissao.split('/')[2].split(' ')[0]).filter(d => d !== 'N/A');
            
            if (datas.length === 0) return '';

            // Obt√©m datas √∫nicas e ordena
            const datasUnicas = [...new Set(datas)].sort();

            if (datasUnicas.length === 1) {
                return datasUnicas[0].replace('/', '_');
            } else if (datasUnicas.length > 1) {
                // Retorna o per√≠odo do primeiro ao √∫ltimo m√™s/ano
                return `${datasUnicas[0].replace('/', '_')}_a_${datasUnicas.pop().replace('/', '_')}`;
            }

            return '';
        }

        /**
         * Formata a data para um t√≠tulo de arquivo (DDMMYYYY_HHMM).
         */
        function formatarDataParaTitulo(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            return `${day}${month}${year}_${hour}${minute}`;
        }

        /** * Converte um valor num√©rico para o padr√£o de moeda brasileira (R$ X.XXX,XX).
         */
        function formatarValor(valor) {
            if (valor === undefined || valor === null || isNaN(parseFloat(valor))) {
                return 'R$ 0,00';
            }
            const numero = parseFloat(valor);
            return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatarStatus(cStat, xMotivo, xmlDoc) {
            const eventType = xmlDoc.querySelector('tpEvento');
            const cStatEvento = xmlDoc.querySelector('retEvento cStat');
            const xMotivoEvento = xmlDoc.querySelector('retEvento xMotivo');

            if (eventType && eventType.textContent === '110111') {
                if (cStatEvento && cStatEvento.textContent === '135') {
                    return { 
                        text: 'CANCELADA (Evento 135)', 
                        class: 'status-cancelada', 
                        isAutorizada: false,
                        isAutorizadaForaPrazo: false
                    }; // ATUALIZA√á√ÉO: Adicionado isAutorizadaForaPrazo
                }
            }

            if (cStat) {
                switch(cStat) {
                    case '100':
                        return { 
                            text: 'AUTORIZADA', 
                            class: 'status-autorizada', 
                            isAutorizada: true,
                            isAutorizadaForaPrazo: false
                        }; // ATUALIZA√á√ÉO: Adicionado isAutorizadaForaPrazo
                    case '150': // NOVO: Tratamento de autoriza√ß√£o fora de prazo
                        // O requisito pede para considerar como "Autorizada" e "Sequ√™ncia OK"
                        return { 
                            text: 'AUTORIZADA FORA DO PRAZO', 
                            class: 'status-autorizada', 
                            isAutorizada: true, // √â considerada AUTORIZADA para a sequ√™ncia
                            isAutorizadaForaPrazo: true
                        };
                    case '101':
                    case '151':
                        return { 
                            text: 'CANCELADA', 
                            class: 'status-cancelada', 
                            isAutorizada: false,
                            isAutorizadaForaPrazo: false
                        };
                    default:
                        // Demais c√≥digos (2xx, 3xx) s√£o REJEI√á√ïES ou DENEGA√á√ïES
                        return { 
                            text: `REJEITADA/OUTROS (${cStat}) - ${xMotivo}`, 
                            class: 'status-sem-autorizacao', 
                            isAutorizada: false,
                            isAutorizadaForaPrazo: false
                        };
                }
            }
            
            // Se n√£o houver cStat (XML n√£o autorizado/assinado/protocolado)
            return { 
                text: 'SEM PROTOCOLO SEFAZ', 
                class: 'status-sem-autorizacao', 
                isAutorizada: false,
                isAutorizadaForaPrazo: false
            };
        }
        
        /**
         * Calcula o valor total de todas as notas VIS√çVEIS (filtradas por CNPJ)
         */
        function calcularTotalGeral() {
            const cnpjFiltro = filterCNPJ.value;
            let total = 0;
            
            // Filtra as notas baseadas no filtro de CNPJ (o √∫nico que afeta o c√°lculo do total geral)
            const notasFiltradas = notasFiscais.filter(n => cnpjFiltro === 'ALL' || n.cnpj === cnpjFiltro);
            
            // Filtra as linhas que est√£o vis√≠veis na tela (ap√≥s filtro de MOD/STATUS/BUSCA)
            const visibleRows = relatorioContainer.querySelectorAll('tbody tr');
            
            // Mapeia o valor num√©rico das notas filtradas pela chave de acesso (para efici√™ncia)
            const notasMap = notasFiltradas.reduce((map, nota) => {
                map[nota.chave] = nota.valorNumerico;
                return map;
            }, {});

            // Como √© dif√≠cil mapear a TR de volta para a nota original sem uma chave de acesso na TR,
            // A solu√ß√£o mais simples √© percorrer todas as notas filtradas pelo CNPJ e somar
            // APENAS SE ELAS N√ÉO ESTIVEREM OCULTAS pelo filtro de busca/status/mod.

            // Solu√ß√£o simplificada: Soma todas as notas no filtro de CNPJ. 
            // O filtro visual de Mod/Status/Busca n√£o deve afetar o TOTAL GERAL do CNPJ.
            notasFiltradas.forEach(nota => {
                total += nota.valorNumerico;
            });
            
            return formatarValor(total);
        }

    </script>
</body>
</html>
