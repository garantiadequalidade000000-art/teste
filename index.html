<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Sequ√™ncia de NF-e/NFC-e</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Paleta de Cores: Baseado na Logo (Laranja Escuro) */
        :root {
            --cor-principal: #D9531E; /* Laranja Escuro (Mais profissional) */
            --cor-secundaria: #333; /* Cinza escuro para texto e detalhes (quase preto) */
            --cor-fundo: #f4f4f9;
            --cor-borda: #ddd;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            background-color: var(--cor-fundo);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho e Logo */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--cor-principal);
            padding-bottom: 10px;
        }

        header img {
            width: 50px; /* Ajuste o tamanho da logo conforme necess√°rio */
            height: auto;
        }
        
        header h1 {
            color: var(--cor-secundaria);
            font-size: 24pt;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        #drop-area { 
            border: 3px dashed var(--cor-borda); 
            background-color: #fff;
            padding: 30px; 
            text-align: center; 
            margin-bottom: 20px; 
            cursor: pointer; 
            transition: border-color 0.3s, background-color 0.3s;
            border-radius: 8px;
            font-size: 1.1em;
        }

        #drop-area.highlight {
            border-color: var(--cor-principal);
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        
        /* Bot√µes e Filtros */
        .controls-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            margin-bottom: 20px;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            background-color: var(--cor-principal);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        
        button:hover:not(:disabled) {
            background-color: #A34017; /* Tom mais escuro do laranja */
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Select de Filtros */
        #filterMod, #filterStatus, #filterCNPJ { /* Adicionado #filterCNPJ */
            padding: 10px;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
            background-color: #fff;
            color: var(--cor-secundaria);
        }
        
        /* Tabela */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid var(--cor-borda); 
            padding: 10px; 
            text-align: left; 
            font-size: 10pt; 
        }
        th { 
            background-color: var(--cor-principal); 
            color: white; 
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        /* Estilos de Status/Sequ√™ncia */
        .quebra-indicada { 
            color: var(--cor-principal); 
            font-weight: bold; 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .sem-quebra { 
            color: #1a8a25; /* Verde escuro para OK */
            font-weight: bold;
        }
        
        /* Estilo para notas canceladas/rejeitadas */
        .status-cancelada, .status-sem-autorizacao { 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .status-autorizada { 
            background-color: #effceb; 
        }
        
        /* Relat√≥rio para Exporta√ß√£o (PDF) */
        #relatorio-export { 
            padding: 10px; /* Reduz padding para mais espa√ßo */
            background-color: #fff; 
            font-family: Arial, sans-serif; /* Padr√£o para PDF */
            font-size: 10pt; /* Define um tamanho base menor para o PDF */
        }

        /* Tabela no PDF: Otimiza√ß√£o para evitar cortes */
        #relatorio-export table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 5px; 
            table-layout: fixed; /* For√ßa o layout da tabela a ser fixo */
        }
        
        /* *** AJUSTE PARA PDF: Fonte e Padding menor para caber mais informa√ß√£o *** */
        #relatorio-export th, #relatorio-export td { 
            padding: 5px; /* Reduz o padding das c√©lulas */
            font-size: 8pt; /* Tamanho da fonte menor nas c√©lulas */
            word-wrap: break-word; /* Permite quebrar palavras longas, √∫til para chaves */
        }
        
        /* Estilo para a coluna de Valor Total no PDF para garantir que caiba */
        #relatorio-export table tbody tr td:nth-child(5) { 
            /* Se as colunas no PDF forem: S√©rie, N√∫mero, Emiss√£o, CFOP, Valor Total, Status SEFAZ */
            /* A 5a coluna √© Valor Total */
            width: 15%; 
        }
        
        /* T√≠tulo do Relat√≥rio no PDF */
        .pdf-report-title {
            font-size: 18pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px double var(--cor-principal);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho do Grupo no PDF */
        .pdf-header { 
            font-size: 11pt; 
            font-weight: bold; 
            margin-top: 25px; 
            margin-bottom: 5px; 
            border-bottom: 2px solid var(--cor-principal); 
            padding-bottom: 5px; 
            color: var(--cor-secundaria);
        }
        
        /* Destaque para o valor total (PRETO E MENOR) */
        .total-geral {
            font-size: 16pt; 
            font-weight: bold;
            padding: 10px; 
            margin-top: 30px; 
            border: 2px solid var(--cor-secundaria); /* Borda preta */
            background-color: #f9f9f9; 
            border-radius: 5px; 
            text-align: right; 
            color: var(--cor-secundaria); /* Texto preto */
        }
        
        .total-geral span {
            font-size: 1.1em;
            color: #000;
        }

        /* Estilos do T√≠tulo do Grupo */
        #relatorio-completo h2 {
            font-size: 18pt;
            color: var(--cor-secundaria);
            margin-top: 40px;
            border-bottom: 1px solid var(--cor-borda);
            padding-bottom: 5px;
        }
        
        #relatorio-completo h3 {
            font-size: 14pt;
            color: var(--cor-principal);
            background-color: #f9f9f9;
            padding: 10px;
            border-left: 5px solid var(--cor-principal);
            margin-top: 30px;
            margin-bottom: 0;
        }
        
        /* Estilos para o Resumo */
        .resumo-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .resumo-table-container {
            flex: 1;
            min-width: 300px;
        }

        .resumo-table-container h4 {
            font-size: 12pt;
            color: var(--cor-secundaria);
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--cor-borda);
        }

        .resumo-table-container table {
            width: 100%;
            margin-top: 0;
            box-shadow: none;
        }
        
        .resumo-table-container th {
            background-color: #555; /* Cinza mais escuro */
        }
        
        /* Campo de Busca */
        #search-container {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #searchInput {
            padding: 10px;
            flex-grow: 1;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
        }
        
        /* Estilos para a nova se√ß√£o de downloads/filtros */
        .download-group, .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .download-group {
            margin-left: auto; /* Empurra para a direita */
        }
        
        /* --- NOVO: Estilos para Visualiza√ß√£o de Detalhes (DANFE Simplificado) --- */
        #modalDetalhes {
            display: none; /* Escondido por padr√£o */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Fundo escuro */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 5% do topo e centralizado */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Largura maior */
            max-width: 900px; /* Limite */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--cor-principal);
            text-decoration: none;
        }

        .danfe-simplificado {
            font-family: Arial, sans-serif;
            font-size: 10pt;
        }

        .danfe-simplificado h2 {
            text-align: center;
            color: var(--cor-principal);
            border-bottom: 2px solid var(--cor-principal);
            padding-bottom: 5px;
            margin-top: 0;
            font-size: 14pt;
        }

        .danfe-section {
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #fff;
        }

        .danfe-section h3 {
            font-size: 11pt;
            color: var(--cor-secundaria);
            border-bottom: 1px dashed var(--cor-borda);
            padding-bottom: 5px;
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .danfe-item {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 5px;
            gap: 15px;
        }

        .danfe-field {
            min-width: 200px;
            flex-grow: 1;
        }

        .danfe-label {
            font-weight: bold;
            color: var(--cor-principal);
            display: block;
            font-size: 9pt;
        }

        .danfe-value {
            color: var(--cor-secundaria);
            display: block;
            word-break: break-all;
        }

        .danfe-produtos table {
            width: 100%;
            margin-top: 10px;
        }
        .danfe-produtos th, .danfe-produtos td {
            padding: 5px;
            font-size: 9pt;
            border: 1px solid var(--cor-borda);
        }
        .danfe-produtos th {
            background-color: #f4f4f4;
            color: var(--cor-secundaria);
        }

        .danfe-totais {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <header>
        <img src="https://res.cloudinary.com/drsyomd2a/image/upload/v1762261454/Design-sem-nome_uxeex5.png" alt="Logo">
        <h1>Verificador de Quebra de Sequ√™ncia NF-e / NFC-e</h1>
        <div style="width: 50px;"></div> 
    </header>

    <div id="drop-area">
        Arraste e solte arquivos **XML** (ou clique para selecionar)<br>
        *Voc√™ pode adicionar arquivos de diferentes pastas consecutivamente.*
        <input type="file" id="fileElem" multiple accept=".xml" style="display: none;">
    </div>

    <div class="controls-container">
        <div class="action-group">
            <button onclick="processarNotas()" id="processButton" disabled>‚öôÔ∏è Processar e Verificar Sequ√™ncia</button>
            <button onclick="gerarRelatorioPDF()" id="pdfButton" disabled>üíæ Gerar PDF do Relat√≥rio</button>
            <button onclick="limparArquivos()" id="clearButton">üóëÔ∏è Limpar Arquivos</button>
        </div>

        <div class="download-group" id="downloadGroup" style="display: none;">
            <button onclick="compactarEBaixarXML('NFE')" id="downloadNFEButton">üì¶ Baixar XMLs NF-e</button>
            <button onclick="compactarEBaixarXML('NFCE')" id="downloadNFCEButton">üì¶ Baixar XMLs NFC-e</button>
        </div>
    </div>
    
    <h2>Relat√≥rio de Notas Fiscais (Visualiza√ß√£o Completa)</h2>
    
    <div id="filter-container" style="display: none;" class="controls-container">
        
        <div class="filter-group">
            <label for="filterCNPJ">CNPJ:</label>
            <select id="filterCNPJ" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todos os CNPJs</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filterMod">Tipo de Nota:</label>
            <select id="filterMod" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (NF-e e NFC-e)</option>
                <option value="55">Somente NF-e (Mod. 55)</option>
                <option value="65">Somente NFC-e (Mod. 65)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="filterStatus">Status SEFAZ:</label>
            <select id="filterStatus" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (Autorizadas/Canceladas/Rejeitadas)</option>
                <option value="AUTORIZADA">Somente AUTORIZADAS (100)</option>
                <option value="AUTORIZADA_FORA_PRAZO">Somente AUTORIZADAS FORA DO PRAZO (150)</option>
                <option value="NAO_AUTORIZADA">Somente CANCELADAS/REJEITADAS</option>
            </select>
        </div>
        <div id="search-container" style="display: none;">
            <input type="text" id="searchInput" placeholder="Buscar por Chave, Data, N√∫mero, CNPJ ou Valor..." onkeyup="filtrarTabela()">
            <button onclick="limparBusca()">Limpar Busca</button>
        </div>
    </div>
    
    <div id="resumo-container" style="display: none;" class="resumo-section">
        </div>
    
    <div id="relatorio-completo"> 
        <div id="relatorio-container">
            <p>Carregue os arquivos XML e clique em "Processar" para gerar o relat√≥rio.</p>
        </div>
    </div>

    <div id="modalDetalhes" onclick="fecharDetalhes(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-button" onclick="fecharDetalhes(event)">&times;</span>
            <div id="detalhesXMLContent" class="danfe-simplificado">
                </div>
        </div>
    </div>

    <script>
        // Refer√™ncias aos elementos HTML
        const fileElem = document.getElementById('fileElem');
        const dropArea = document.getElementById('drop-area');
        const relatorioContainer = document.getElementById('relatorio-container');
        const processButton = document.getElementById('processButton');
        const pdfButton = document.getElementById('pdfButton');
        const clearButton = document.getElementById('clearButton');
        // NOVO: Refer√™ncias aos novos elementos de filtro e download
        const filterContainer = document.getElementById('filter-container');
        const filterMod = document.getElementById('filterMod');
        const filterStatus = document.getElementById('filterStatus');
        const filterCNPJ = document.getElementById('filterCNPJ'); // NOVO: Refer√™ncia ao filtro CNPJ
        const downloadGroup = document.getElementById('downloadGroup');
        const resumoContainer = document.getElementById('resumo-container');
        const searchInput = document.getElementById('searchInput'); // Refer√™ncia ao campo de busca

        let notasFiscais = []; // Array que agora acumula as notas de todas as cargas
        let gruposGlobais = {};
        let arquivosXML = []; // NOVO: Armazena o conte√∫do e nome dos arquivos XML para compacta√ß√£o

        // Mapeamento de Forma de Pagamento (tPag)
        const formasPagamento = {
            '01': 'Dinheiro',
            '02': 'Cheque',
            '03': 'Cart√£o de Cr√©dito',
            '04': 'Cart√£o de D√©bito',
            '05': 'Cr√©dito Loja',
            '10': 'Vale Alimenta√ß√£o',
            '11': 'Vale Refei√ß√£o',
            '12': 'Vale Presente',
            '13': 'Vale Combust√≠vel',
            '14': 'Duplicata Mercantil',
            '15': 'Boleto Banc√°rio',
            '90': 'Sem Pagamento',
            '99': 'Outros'
        };

        // --- Eventos Drag and Drop ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileElem.click(), false);
        fileElem.addEventListener('change', handleFiles, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            const files = e.target.files;
            ([...files]).forEach(uploadFile);
            
            if (notasFiscais.length > 0) {
                processButton.disabled = false;
                relatorioContainer.innerHTML = `<p><strong>${arquivosXML.length}</strong> arquivos XML carregados. Clique em "Processar" para gerar o relat√≥rio.</p>`;
            }
        }

        function uploadFile(file) {
            // Apenas aceita arquivos .xml
            if (file.name.toLowerCase().endsWith('.xml')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processarNota(e.target.result, file.name);
                };
                reader.readAsText(file);
            }
        }

        // --- Processamento do XML ---
        function processarNota(xmlContent, fileName) {
            // NOVO: Captura o conte√∫do do XML
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "application/xml");

                // Campos obrigat√≥rios para Agrupamento/Sequ√™ncia
                const nNF = safeInt(xmlDoc, 'nNF');
                const mod = safeText(xmlDoc, 'mod');
                const serie = safeText(xmlDoc, 'serie');
                const CNPJ = safeText(xmlDoc, 'CNPJ');
                const chaveAcesso = safeText(xmlDoc, 'chNFe') || safeText(xmlDoc, 'chNFCE'); // Chave de acesso √© crucial para duplicidade

                if (nNF && mod && serie && CNPJ !== 'N/A' && chaveAcesso) {
                    // 1. VERIFICA√á√ÉO DE DUPLICIDADE (CHAVE DE ACESSO)
                    const isDuplicate = notasFiscais.some(n => n.chave === chaveAcesso);
                    
                    if (!isDuplicate) {
                        // 2. ADI√á√ÉO DA NOVA NOTA E ARQUIVO
                        const dhEmi = safeText(xmlDoc, 'dhEmi');
                        const vNF = safeText(xmlDoc, 'vNF');
                        const cfop = safeText(xmlDoc, 'CFOP');
                        const statusAutorizacao = formatarStatus(safeText(xmlDoc, 'cStat'), safeText(xmlDoc, 'xMotivo'), xmlDoc);
                        const tPag = safeText(xmlDoc.querySelector('detPag'), 'tPag');
                        const nomeFantasia = safeText(xmlDoc, 'xFant') || 'Nome N√£o Informado';

                        const novaNota = {
                            nNF: nNF,
                            mod: mod,
                            serie: serie,
                            cnpj: CNPJ,
                            chave: chaveAcesso,
                            dhEmi: dhEmi,
                            data: formatarDataHora(dhEmi),
                            vNF: vNF,
                            cfop: cfop,
                            statusAutorizacao: statusAutorizacao,
                            tPag: formasPagamento[tPag] || tPag || 'N/A',
                            nomeFantasia: nomeFantasia,
                            // Campos adicionais preenchidos em 'processarNotas()'
                            quebra: 'N/A',
                            quebraClass: '',
                            quebraMotivo: ''
                        };

                        notasFiscais.push(novaNota);
                        // Adiciona o conte√∫do completo do XML para a fun√ß√£o de visualiza√ß√£o de detalhes e download
                        arquivosXML.push({
                            name: fileName,
                            content: xmlContent,
                            chave: chaveAcesso,
                            mod: mod
                        });
                        
                    } else {
                        console.warn(`Nota Fiscal com chave ${chaveAcesso} duplicada. Ignorando.`);
                    }

                } else {
                    console.warn(`XML ${fileName} inv√°lido ou incompleto (faltando nNF, mod, serie, CNPJ ou chNFe/chNFCE). Ignorando.`);
                }
            } catch (e) {
                console.error(`Erro ao processar o arquivo ${fileName}:`, e);
            }
        }

        // --- L√≥gica Principal (Bot√£o Processar) ---
        function processarNotas() {
            if (notasFiscais.length === 0) {
                relatorioContainer.innerHTML = '<p class="quebra-indicada">Nenhum arquivo XML v√°lido foi carregado para processamento.</p>';
                return;
            }

            // 1. Agrupar notas por CNPJ, Modelo e S√©rie
            const grupos = notasFiscais.reduce((acc, nota) => {
                // NOVO: Adiciona o tipo de nota no agrupamento
                const chaveGrupo = `${nota.cnpj}-${nota.mod}-${nota.serie}`;
                if (!acc[chaveGrupo]) {
                    acc[chaveGrupo] = {
                        info: {
                            cnpj: nota.cnpj,
                            mod: nota.mod,
                            serie: nota.serie,
                            emitente: nota.nomeFantasia
                        },
                        notas: []
                    };
                }
                acc[chaveGrupo].notas.push(nota);
                return acc;
            }, {});

            gruposGlobais = grupos; // Armazena grupos para uso na busca

            // 2. Verificar a sequ√™ncia dentro de cada grupo
            Object.values(grupos).forEach(grupo => {
                // √â crucial reordenar antes de verificar a sequ√™ncia, j√° que as notas s√£o acumuladas
                grupo.notas.sort((a, b) => a.nNF - b.nNF);

                grupo.notas.forEach((nota, index) => {
                    // A l√≥gica de sequ√™ncia deve ser aplicada apenas a notas AUTORIZADAS (incluindo 150)
                    const isAutorizada = nota.statusAutorizacao.isAutorizada; // Usa a nova flag

                    if (!isAutorizada) {
                        nota.quebra = 'N√ÉO AUTORIZADA';
                        nota.quebraClass = 'status-sem-autorizacao';
                        nota.quebraMotivo = `(${nota.statusAutorizacao.text})`;
                        return; // Pula a verifica√ß√£o de sequ√™ncia para notas n√£o autorizadas
                    }

                    // A primeira nota do grupo √© sempre considerada 'sem quebra' para fins de valida√ß√£o
                    if (index === 0) {
                        nota.quebra = 'In√≠cio da S√©rie';
                        nota.quebraClass = 'sem-quebra';
                        nota.quebraMotivo = 'Primeira nota da s√©rie carregada.';
                        return;
                    }

                    const notaAnterior = grupo.notas[index - 1];

                    // Pulo de sequ√™ncia (gap)
                    if (nota.nNF > notaAnterior.nNF + 1) {
                        nota.quebra = 'QUEBRA ENCONTRADA';
                        nota.quebraClass = 'quebra-indicada';
                        nota.quebraMotivo = `Pulo: ${notaAnterior.nNF} -> ${nota.nNF}`;
                        return;
                    }

                    // Duplicidade (n√£o deveria acontecer, mas √© uma seguran√ßa)
                    if (nota.nNF === notaAnterior.nNF) {
                        nota.quebra = 'DUPLICIDADE';
                        nota.quebraClass = 'quebra-indicada';
                        nota.quebraMotivo = `N√∫mero ${nota.nNF} j√° existe na s√©rie.`;
                        return;
                    }

                    // Se a nota anterior n√£o foi autorizada, o processamento deve ser cont√≠nuo.
                    // O teste principal j√° cobre isso: se nNF > nNF_anterior + 1, √© quebra.

                    // Sem quebra
                    nota.quebra = 'OK';
                    nota.quebraClass = 'sem-quebra';
                    nota.quebraMotivo = 'Sequ√™ncia correta.';
                });
            });

            // 3. Atualizar o Select de CNPJs e aplicar filtros
            const cnpjs = [...new Set(notasFiscais.map(n => n.cnpj))].sort();
            filterCNPJ.innerHTML = '<option value="ALL">Todos os CNPJs</option>';
            cnpjs.forEach(cnpj => {
                const nomeFantasia = notasFiscais.find(n => n.cnpj === cnpj)?.nomeFantasia || cnpj;
                filterCNPJ.innerHTML += `<option value="${cnpj}">${nomeFantasia} (${cnpj})</option>`;
            });

            // 4. Gerar o relat√≥rio HTML e resumos
            gerarRelatorioHTML(grupos);
            gerarResumos(notasFiscais); // Gera os resumos com base em todas as notas
            
            // 5. Atualizar o estado da UI
            pdfButton.disabled = false;
            filterContainer.style.display = 'flex'; // Exibe o container de filtros
            document.getElementById('search-container').style.display = 'flex'; // Exibe a busca
            downloadGroup.style.display = 'flex'; // Exibe o download de XMLs
        }

        // --- Gera√ß√£o de Resumos (CFOP e Pagamento) ---
        function gerarResumos(notas) {
            const resumoCFOP = {};
            const resumoPagamento = {};

            // NOVO: Filtrar as notas pelo CNPJ selecionado (se n√£o for 'ALL')
            const notasParaResumo = notas.filter(n => filterCNPJ.value === 'ALL' || n.cnpj === filterCNPJ.value);

            if (notasParaResumo.length === 0 && filterCNPJ.value !== 'ALL') {
                resumoContainer.innerHTML = `<p>Nenhuma nota fiscal encontrada para o CNPJ ${filterCNPJ.value} para gerar os resumos.</p>`;
                resumoContainer.style.display = 'flex';
                return;
            }

            notasParaResumo.forEach(nota => {
                // Apenas notas AUTORIZADAS (incluindo 150) para os resumos
                if (nota.statusAutorizacao.isAutorizada) {
                    // Resumo por CFOP
                    const cfopKey = nota.cfop;
                    resumoCFOP[cfopKey] = resumoCFOP[cfopKey] || { count: 0, total: 0 };
                    resumoCFOP[cfopKey].count++;
                    resumoCFOP[cfopKey].total += parseFloat(nota.vNF || 0);

                    // Resumo por Pagamento
                    const pagKey = nota.tPag;
                    resumoPagamento[pagKey] = resumoPagamento[pagKey] || { count: 0, total: 0 };
                    resumoPagamento[pagKey].count++;
                    resumoPagamento[pagKey].total += parseFloat(nota.vNF || 0);
                }
            });

            const cfopArray = Object.entries(resumoCFOP).sort(([, a], [, b]) => b.total - a.total);
            const pagArray = Object.entries(resumoPagamento).sort(([, a], [, b]) => b.total - a.total);

            let htmlResumo = '';
            let totalGeralResumo = notasParaResumo.filter(n => n.statusAutorizacao.isAutorizada).reduce((sum, n) => sum + parseFloat(n.vNF || 0), 0);
            
            // Tabela de Resumo por CFOP
            htmlResumo += `<div class="resumo-table-container">
                <h4>Resumo por CFOP (Apenas Autorizadas)</h4>
                <table>
                    <thead><tr><th>CFOP</th><th>Qtd</th><th>Valor Total</th></tr></thead>
                    <tbody>`;
            cfopArray.forEach(([cfop, data]) => {
                htmlResumo += `<tr><td>${cfop}</td><td>${data.count}</td><td>${formatarValor(data.total)}</td></tr>`;
            });
            htmlResumo += `</tbody></table></div>`;

            // Tabela de Resumo por Forma de Pagamento
            htmlResumo += `<div class="resumo-table-container">
                <h4>Resumo por Forma de Pagamento (Apenas Autorizadas)</h4>
                <table>
                    <thead><tr><th>Forma Pag.</th><th>Qtd</th><th>Valor Total</th></tr></thead>
                    <tbody>`;
            pagArray.forEach(([pag, data]) => {
                htmlResumo += `<tr><td>${pag}</td><td>${data.count}</td><td>${formatarValor(data.total)}</td></tr>`;
            });
            htmlResumo += `</tbody></table></div>`;
            
            // Total Geral
            htmlResumo += `<div class="total-geral" style="width: 100%;">
                <p>TOTAL GERAL (Notas Autorizadas): <span>${formatarValor(totalGeralResumo)}</span></p>
            </div>`;

            resumoContainer.innerHTML = htmlResumo;
            resumoContainer.style.display = 'flex';
        }

        // --- Gera√ß√£o do Relat√≥rio HTML ---
        function gerarRelatorioHTML(grupos) {
            let htmlCompleto = '';
            let temGrupoVisivel = false;
            let totalGeral = 0;
            const filtroStatus = filterStatus.value;
            const cnpjFiltro = filterCNPJ.value;

            Object.entries(grupos).forEach(([chaveGrupo, grupo]) => {
                const info = grupo.info;
                let htmlTBody = '';
                let totalGrupo = 0;
                
                // NOVO: Tipo de nota
                const tipoNota = info.mod === '55' ? 'NF-e' : (info.mod === '65' ? 'NFC-e' : `Mod. ${info.mod}`);

                // NOVO: Aplica o filtro de CNPJ no agrupamento
                if (cnpjFiltro !== 'ALL' && info.cnpj !== cnpjFiltro) {
                    return; // Ignora o grupo se n√£o corresponder ao filtro de CNPJ
                }
                
                // 1. Filtrar as notas do grupo com base no filtro de Status
                const notasFiltradas = grupo.notas.filter(nota => {
                    const statusRow = nota.statusAutorizacao.text.includes('CANCELADA') || nota.statusAutorizacao.text.includes('REJEITADA') ? 'NAO_AUTORIZADA' : (nota.statusAutorizacao.text.includes('150') ? 'AUTORIZADA_FORA_PRAZO' : 'AUTORIZADA');

                    if (filtroStatus === 'AUTORIZADA' && (statusRow !== 'AUTORIZADA' && statusRow !== 'AUTORIZADA_FORA_PRAZO')) {
                        return false;
                    } else if (filtroStatus === 'AUTORIZADA_FORA_PRAZO' && statusRow !== 'AUTORIZADA_FORA_PRAZO') {
                        return false;
                    } else if (filtroStatus === 'NAO_AUTORIZADA' && (statusRow === 'AUTORIZADA' || statusRow === 'AUTORIZADA_FORA_PRAZO')) {
                        return false;
                    }
                    return true;
                });
                
                if (notasFiltradas.length === 0) {
                    return; // N√£o gera o HTML se n√£o houver notas ap√≥s o filtro
                }

                temGrupoVisivel = true;
                
                // 2. Cria o cabe√ßalho do grupo
                htmlCompleto += `
                    <div id="table-group-${chaveGrupo}" data-mod="${info.mod}" data-cnpj="${info.cnpj}">
                        <h3>üßæ ${info.emitente} (CNPJ: ${info.cnpj}) - ${tipoNota} - S√©rie: ${info.serie}</h3>
                        <table id="table-${chaveGrupo}">
                        <thead> 
                            <tr> 
                                <th>S√©rie</th> 
                                <th>N√∫mero</th> 
                                <th>Emiss√£o</th> 
                                <th>CFOP</th> 
                                <th>Forma Pag.</th> 
                                <th>Valor Total</th> 
                                <th>Chave de Acesso</th> 
                                <th>Status SEFAZ</th> 
                                <th style="width: 10%;">Sequ√™ncia</th>
                                <th>Detalhes</th> </tr> 
                        </thead> 
                        <tbody>`;
                
                // 3. Preenche as linhas (tbody)
                notasFiltradas.forEach(nota => {
                    const rowClass = nota.quebraClass || nota.statusAutorizacao.class;
                    
                    htmlTBody += `
                        <tr data-cstat="${nota.statusAutorizacao.cStat}" data-chave="${nota.chave}" class="${rowClass}">
                            <td>${nota.serie}</td>
                            <td>${nota.nNF}</td>
                            <td>${nota.data}</td>
                            <td>${nota.cfop}</td>
                            <td>${nota.tPag}</td>
                            <td>${formatarValor(nota.vNF)}</td>
                            <td style="word-break: break-all;">${nota.chave}</td>
                            <td>${nota.statusAutorizacao.text}</td>
                            <td class="${nota.quebraClass}">${nota.quebra} <small>(${nota.quebraMotivo})</small></td>
                            <td><button onclick="mostrarDetalhesXML('${nota.chave}')">üîç</button></td> </tr>
                    `;

                    // Soma apenas notas AUTORIZADAS (incluindo 150)
                    if (nota.statusAutorizacao.isAutorizada) {
                        totalGrupo += parseFloat(nota.vNF || 0);
                    }
                });

                // 4. Fecha a tabela e adiciona o total do grupo
                htmlCompleto += `${htmlTBody}</tbody></table>
                    <div class="total-geral">
                        Total Agrupado (Autorizadas): <span>${formatarValor(totalGrupo)}</span>
                    </div>
                </div>`;
                
                totalGeral += totalGrupo; // Acumula no total geral
            });

            // 5. Gera o HTML final
            if (temGrupoVisivel) {
                htmlCompleto += `
                    <h2>TOTAL GERAL (Notas Autorizadas)</h2>
                    <div class="total-geral">
                        Total de Notas Autorizadas Vis√≠veis: <span>${formatarValor(totalGeral)}</span>
                    </div>`;
                relatorioContainer.innerHTML = htmlCompleto;
            } else {
                relatorioContainer.innerHTML = '<p class="quebra-indicada">Nenhuma nota fiscal corresponde aos filtros aplicados.</p>';
            }
        }

        // --- Fun√ß√µes de Filtro e Busca ---
        function aplicarFiltrosRelatorio() {
            // Apenas re-renderiza o relat√≥rio com os filtros de CNPJ, Mod e Status.
            gerarRelatorioHTML(gruposGlobais); // 1. Re-gera a parte visual (tabelas e total) com o novo CNPJ
            gerarResumos(notasFiscais);       // 2. Recalcula e exibe os resumos se o CNPJ mudar (ou outros filtros, mas o CNPJ √© o mais relevante aqui).
            filtrarTabela();                  // 3. Re-executa a busca para garantir que a combina√ß√£o
        }

        function filtrarTabela() {
            const filtroBusca = searchInput.value.toUpperCase();
            const rows = document.querySelectorAll('#relatorio-completo tbody tr');

            rows.forEach(row => {
                const tableGroup = row.closest('div[id^="table-group-"]');
                const cnpjGrupo = tableGroup ? tableGroup.getAttribute('data-cnpj') : '';
                
                let showRow = true; // Assumimos que a linha deve ser mostrada por padr√£o
                
                // 3. Aplica o filtro de busca textual/CNPJ
                if (filtroBusca !== '') {
                    let matchesSearch = false;
                    // Verifica se o CNPJ do grupo corresponde ao filtro de busca
                    if (cnpjGrupo && cnpjGrupo.toUpperCase().indexOf(filtroBusca) > -1) {
                        matchesSearch = true;
                    } else {
                        // Percorre todas as c√©lulas (td) da linha
                        for (let j = 0; j < row.cells.length; j++) {
                            const td = row.cells[j];
                            if (td) {
                                const text = td.textContent || td.innerText;
                                if (text.toUpperCase().indexOf(filtroBusca) > -1) {
                                    matchesSearch = true;
                                    break;
                                }
                            }
                        }
                    }
                    // A linha s√≥ deve ser mostrada se passar pelos filtros de CNPJ/Mod/Status J√Å APLICADOS na fun√ß√£o gerarRelatorioHTML
                    // E se corresponder ao filtro de busca
                    if (!matchesSearch) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
            // Oculta/Exibe as divs de grupo e totais que ficaram vazias
            document.querySelectorAll('#relatorio-completo div[id^="table-group-"]').forEach(groupDiv => {
                const rowsVisiveis = groupDiv.querySelectorAll('tbody tr:not([style*="display: none"])');
                const totalDiv = groupDiv.querySelector('.total-geral');
                
                if (rowsVisiveis.length === 0) {
                    groupDiv.style.display = 'none';
                } else {
                    groupDiv.style.display = '';
                    // Se o total geral do relat√≥rio for o mesmo que o total do grupo (ou seja, s√≥ h√° um grupo vis√≠vel)
                    // o total do grupo pode ser escondido para evitar redund√¢ncia (exceto se a busca estiver ativa)
                    if (totalDiv) {
                        totalDiv.style.display = ''; 
                    }
                }
            });
        }
        
        function limparBusca() {
            searchInput.value = '';
            filtrarTabela();
        }

        // --- Gera√ß√£o de PDF ---
        function obterPeriodoEmissaoPrincipal() {
            const notasFiltradas = notasFiscais.filter(n => filterCNPJ.value === 'ALL' || n.cnpj === filterCNPJ.value);
            if (notasFiltradas.length === 0) return 'Sem_Data';
            
            // Ordena por data de emiss√£o (dhEmi)
            notasFiltradas.sort((a, b) => a.dhEmi.localeCompare(b.dhEmi));
            
            const dataInicial = formatarDataParaTitulo(notasFiltradas[0].dhEmi);
            const dataFinal = formatarDataParaTitulo(notasFiltradas[notasFiltradas.length - 1].dhEmi);
            
            if (dataInicial === dataFinal) {
                return dataInicial;
            }
            return `${dataInicial}_a_${dataFinal}`;
        }
        
        function obterNomeFantasiaPrincipal() {
            // ATUALIZA√á√ÉO: Retorna 'Empresa' se o filtro for ALL
            if (filterCNPJ.value === 'ALL') {
                return 'Empresa';
            }
            // Considera apenas notas do CNPJ filtrado.
            const notasFiltradas = notasFiscais.filter(n => n.cnpj === filterCNPJ.value);

            if (notasFiltradas.length === 0) return 'Empresa';

            const contagem = notasFiltradas.reduce((acc, nota) => {
                const nome = nota.nomeFantasia;
                acc[nome] = (acc[nome] || 0) + 1;
                return acc;
            }, {});

            let nomePrincipal = 'Empresa';
            let maxCount = 0;
            for (const nome in contagem) {
                if (contagem[nome] > maxCount) {
                    maxCount = contagem[nome];
                    nomePrincipal = nome;
                }
            }
            // Remove espa√ßos e substitui por underscore para o nome do arquivo
            return nomePrincipal.replace(/\s/g, '_');
        }

        function gerarRelatorioPDF() {
            const cnpjFiltro = filterCNPJ.value;
            const grupos = notasFiscais.reduce((acc, nota) => {
                // Filtra notas por CNPJ antes de agrupar para o PDF
                if (cnpjFiltro !== 'ALL' && nota.cnpj !== cnpjFiltro) {
                    return acc;
                }
                const chaveGrupo = `${nota.cnpj}-${nota.mod}-${nota.serie}`;
                if (!acc[chaveGrupo]) {
                    acc[chaveGrupo] = {
                        info: {
                            cnpj: nota.cnpj,
                            mod: nota.mod,
                            serie: nota.serie,
                            emitente: nota.nomeFantasia
                        },
                        notas: []
                    };
                }
                acc[chaveGrupo].notas.push(nota);
                return acc;
            }, {});

            if (Object.keys(grupos).length === 0) {
                alert(`Nenhuma nota fiscal encontrada para o CNPJ ${cnpjFiltro}.`);
                return;
            }

            const nomeFantasiaPrincipal = obterNomeFantasiaPrincipal(); // J√° considera o filtro CNPJ
            const dataAtual = new Date();
            const dataFormatada = formatarDataParaTitulo(dataAtual);
            
            // ATUALIZA√á√ÉO: L√≥gica para o t√≠tulo do relat√≥rio
            let tituloEmpresa;
            if (cnpjFiltro === 'ALL') {
                tituloEmpresa = 'Todas as Empresas';
            } else {
                tituloEmpresa = nomeFantasiaPrincipal.replace(/_/g, ' ') + ` (CNPJ: ${cnpjFiltro})`;
            }
            
            const tituloRelatorio = `Relat√≥rio Fiscal da Empresa ${tituloEmpresa}, gerado em ${dataFormatada}.`;

            let htmlPDF = '<div id="relatorio-export">';
            
            // T√≠tulo no PDF
            htmlPDF += `<h1 class="pdf-report-title">${tituloRelatorio}</h1>`;

            // Incluir os resumos no PDF (Recriando a estrutura para PDF)
            const resumoHTML = resumoContainer.innerHTML;
            if (resumoHTML && resumoContainer.style.display !== 'none') {
                 // Reutiliza a classe 'danfe-section' para dar um estilo melhor no PDF
                htmlPDF += `<div class="danfe-section" style="page-break-after: avoid;"><h3>Resumos Fiscais</h3>${resumoHTML}</div>`;
            }

            let totalGeral = 0;

            Object.values(grupos).forEach(grupo => {
                const info = grupo.info;
                const tipoNota = info.mod === '55' ? 'NF-e' : (info.mod === '65' ? 'NFC-e' : `Mod. ${info.mod}`);

                let htmlTBody = '';
                let totalGrupo = 0;

                // 1. Filtrar as notas do grupo por Status (igual ao filtro aplicado na tela)
                const notasFiltradas = grupo.notas.filter(nota => {
                    const filtroStatus = filterStatus.value;
                    const statusRow = nota.statusAutorizacao.text.includes('CANCELADA') || nota.statusAutorizacao.text.includes('REJEITADA') ? 'NAO_AUTORIZADA' : (nota.statusAutorizacao.text.includes('150') ? 'AUTORIZADA_FORA_PRAZO' : 'AUTORIZADA');

                    if (filtroStatus === 'AUTORIZADA' && (statusRow !== 'AUTORIZADA' && statusRow !== 'AUTORIZADA_FORA_PRAZO')) {
                        return false;
                    } else if (filtroStatus === 'AUTORIZADA_FORA_PRAZO' && statusRow !== 'AUTORIZADA_FORA_PRAZO') {
                        return false;
                    } else if (filtroStatus === 'NAO_AUTORIZADA' && (statusRow === 'AUTORIZADA' || statusRow === 'AUTORIZADA_FORA_PRAZO')) {
                        return false;
                    }
                    return true;
                });
                
                if (notasFiltradas.length === 0) {
                    return;
                }

                // Cabe√ßalho do Grupo no PDF
                if (cnpjFiltro === 'ALL') {
                    htmlPDF += `<h2 style="page-break-before: always; margin-top: 20px;">Relat√≥rio por Empresa</h2>`;
                    htmlPDF += `<div class="pdf-header">${info.emitente} | CNPJ: ${info.cnpj} | ${tipoNota} | S√©rie: ${info.serie}</div>`;
                } else {
                    htmlPDF += `<div class="pdf-header">${info.emitente} | CNPJ: ${info.cnpj} | ${tipoNota} | S√©rie: ${info.serie}</div>`;
                }


                // Tabela com colunas otimizadas para o PDF:
                // Remo√ß√£o de Chave de Acesso, Forma Pag. e Status Sequ√™ncia
                htmlPDF += `
                    <table>
                        <thead>
                            <tr>
                                <th>S√©rie</th>
                                <th>N√∫mero</th>
                                <th>Emiss√£o</th>
                                <th>CFOP</th>
                                <th>Valor Total</th>
                                <th>Status SEFAZ</th>
                                <th>Sequ√™ncia</th>
                            </tr>
                        </thead>
                        <tbody>`;

                notasFiltradas.forEach(nota => {
                    // Soma apenas notas AUTORIZADAS (incluindo 150)
                    if (nota.statusAutorizacao.isAutorizada) {
                        totalGrupo += parseFloat(nota.vNF || 0);
                    }
                    
                    const rowClass = nota.quebraClass || nota.statusAutorizacao.class;
                    
                    htmlTBody += `
                        <tr class="${rowClass}">
                            <td>${nota.serie}</td>
                            <td>${nota.nNF}</td>
                            <td>${nota.data.substring(0, 10)}</td> <td>${nota.cfop}</td>
                            <td>${formatarValor(nota.vNF)}</td>
                            <td>${nota.statusAutorizacao.text}</td>
                            <td>${nota.quebra}</td>
                        </tr>
                    `;
                });

                htmlPDF += htmlTBody;
                htmlPDF += '</tbody></table>';
                
                // Total do Grupo
                htmlPDF += `
                    <div class="total-geral" style="margin-top: 10px; font-size: 10pt; page-break-after: avoid;">
                        Total do Grupo (Autorizadas): <span>${formatarValor(totalGrupo)}</span>
                    </div>`;

                totalGeral += totalGrupo; // Acumula no total geral
            });

            // Total Geral do Relat√≥rio no PDF
            htmlPDF += `
                <div class="total-geral" style="font-size: 14pt; margin-top: 30px; border: 3px solid var(--cor-secundaria);">
                    TOTAL GERAL DO RELAT√ìRIO (Notas Autorizadas Vis√≠veis): <span>${formatarValor(totalGeral)}</span>
                </div>`;

            htmlPDF += '</div>';

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlPDF;
            document.body.appendChild(tempDiv);
            
            // --- NOVO FORMATO DO NOME DO ARQUIVO ---
            let nomeArquivo;
            if (cnpjFiltro === 'ALL') {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); 
                nomeArquivo = `Relatorio_Fiscal_Todos_CNPJs_${periodoEmissao}.pdf`;
            } else {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); // J√° considera o filtro CNPJ
                // NOVO: Adicionado CNPJ no nome do arquivo se o filtro for aplicado
                nomeArquivo = `Relatorio_Fiscal_${nomeFantasiaPrincipal}_${periodoEmissao}_${cnpjFiltro}.pdf`;
            }
            
            // Configura√ß√µes do PDF para garantir que o conte√∫do caiba
            const opt = {
                margin: 10,
                filename: nomeArquivo,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } // Mantido A4 Portrait, mas otimizado com CSS
            };

            html2pdf().set(opt).from(tempDiv).save().then(() => {
                 // Remove a div tempor√°ria ap√≥s a gera√ß√£o
                document.body.removeChild(tempDiv);
            });
        }

        // --- Download de XMLs ---
        function compactarEBaixarXML(tipo) {
            const zip = new JSZip();
            const modFilter = tipo === 'NFE' ? '55' : (tipo === 'NFCE' ? '65' : '');
            const cnpjFilter = filterCNPJ.value;

            // 1. Filtra os arquivos XML brutos
            const arquivosFiltrados = arquivosXML.filter(arq => {
                // Filtro por Modelo (55 ou 65)
                if (arq.mod !== modFilter) {
                    return false;
                }
                
                // Filtro por CNPJ
                let matchesCNPJ = true;
                if (cnpjFilter !== 'ALL') {
                    const nota = notasFiscais.find(n => n.chave === arq.chave);
                    // Checa se a nota foi processada e bate com o CNPJ
                    if (nota && nota.cnpj !== cnpjFilter) {
                        matchesCNPJ = false;
                    } 
                    // Se n√£o encontrou a nota correspondente mas o CNPJ est√° filtrado, deve ser ignorado.
                    if (cnpjFilter !== 'ALL' && !nota) { 
                        // Tenta extrair o CNPJ do XML bruto, se n√£o encontrou no cache de notasFiscais
                        const cnpjMatch = arq.content.match(/<CNPJ>(\d+)<\/CNPJ>/);
                        if (cnpjMatch && cnpjMatch[1] !== cnpjFilter) {
                            matchesCNPJ = false;
                        }
                    }
                }
                
                return arq.mod === modFilter && matchesCNPJ;
            });
            
            if (arquivosFiltrados.length === 0) {
                const cnpjText = cnpjFilter !== 'ALL' ? ` para o CNPJ ${cnpjFilter}` : '';
                alert(`Nenhum arquivo XML do tipo ${tipo}${cnpjText} foi encontrado.`);
                return;
            }

            // 2. Adiciona ao ZIP
            arquivosFiltrados.forEach(arq => {
                zip.file(arq.name, arq.content);
            });

            // ATUALIZA√á√ÉO: Condicional para o nome do arquivo
            let nomeArquivoZip;
            if (cnpjFilter === 'ALL') {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); 
                nomeArquivoZip = `xml-${tipo}-Todos-CNPJs-${periodoEmissao}.zip`;
            } else {
                const nomeFantasiaPrincipal = obterNomeFantasiaPrincipal();
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); // J√° considera o filtro CNPJ
                nomeArquivoZip = `xml-${tipo}-${nomeFantasiaPrincipal}-${periodoEmissao}_${cnpjFilter}.zip`;
            }

            // 3. Gera e baixa
            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = nomeArquivoZip;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
        }

        // --- Fun√ß√£o de Limpeza ---
        function limparArquivos() {
            // Reinicia o estado da aplica√ß√£o
            notasFiscais = [];
            gruposGlobais = {};
            arquivosXML = []; // NOVO: Limpa o array de arquivos XML
            // Reseta o estado dos bot√µes e containers
            processButton.disabled = true;
            pdfButton.disabled = true;
            filterContainer.style.display = 'none'; // Oculta o container de filtros
            downloadGroup.style.display = 'none'; // Oculta o download de XMLs
            resumoContainer.style.display = 'none'; // Oculta o resumo
            document.getElementById('search-container').style.display = 'none'; // Oculta a busca
            searchInput.value = '';
            filterMod.value = 'ALL'; // Reseta filtros
            filterStatus.value = 'ALL'; // Reseta filtros
            filterCNPJ.value = 'ALL'; // NOVO: Reseta filtro CNPJ
            filterCNPJ.innerHTML = '<option value="ALL">Todos os CNPJs</option>'; // Limpa op√ß√µes de CNPJ
            relatorioContainer.innerHTML = '<p>Todos os arquivos foram removidos. Arraste e solte ou clique para carregar novos arquivos XML.</p>';
        }

        // --- Fun√ß√µes Auxiliares de Leitura e Formata√ß√£o (SEM ALTERA√á√ïES) ---
        function safeText(xmlDoc, tagName) {
            let element;
            // Tratamento especial para tags aninhadas (Ex: enderEmit/xLgr)
            if (tagName.includes('/')) {
                const parts = tagName.split('/');
                let current = xmlDoc;
                for (const part of parts) {
                    current = current.querySelector(part);
                    if (!current) return 'N/A';
                }
                element = current;
            } else {
                element = xmlDoc.querySelector(tagName);
            }
            
            // Trata o caso de tags com namespaces (Ex: <nfe:infNFe> ou <nfe:CNPJ>)
            if (!element) {
                const allElements = xmlDoc.getElementsByTagName(tagName);
                element = allElements.length > 0 ? allElements[0] : null;
            }

            return element ? element.textContent.trim() : 'N/A';
        }

        function safeInt(xmlDoc, tagName) {
            const text = safeText(xmlDoc, tagName);
            return parseInt(text, 10) || 0;
        }

        /** * Formata datas e horas do padr√£o XML (YYYY-MM-DDThh:mm:ss-03:00) para o padr√£o brasileiro.
         * Tenta usar o formato de data mais preciso.
         */
        function formatarDataHora(xmlDate) {
            if (xmlDate === 'N/A' || !xmlDate) return 'N/A';
            try {
                // Cria um objeto Date
                const date = new Date(xmlDate);
                
                // Verifica se a data √© v√°lida
                if (isNaN(date.getTime())) {
                    // Tenta um parser manual caso o navegador n√£o reconhe√ßa o fuso hor√°rio
                    const match = xmlDate.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
                    if (match) {
                        const [, ano, mes, dia, hora, minuto, segundo] = match;
                        return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
                    }
                    return xmlDate; // Retorna o texto original se falhar
                }
                
                // Usa toLocaleString com o formato brasileiro
                return date.toLocaleString('pt-BR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });

            } catch (e) {
                return xmlDate;
            }
        }
        
        /** * Converte a data do padr√£o XML para o formato AAAA-MM-DD (usado no nome do arquivo).
         */
        function formatarDataParaTitulo(data) {
             if (!data) return '';
             try {
                const date = data instanceof Date ? data : new Date(data);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                return 'Invalido';
            }
        }

        /** * Converte um valor num√©rico para o padr√£o de moeda brasileira (R$ X.XXX,XX).
         */
        function formatarValor(valor) {
            if (valor === undefined || valor === null || isNaN(parseFloat(valor))) {
                return 'R$ 0,00';
            }
            const numero = parseFloat(valor);
            return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatarStatus(cStat, xMotivo, xmlDoc) {
            // Verifica se √© um evento de cancelamento (Ex: Evento 110111 com cStat 135)
            const eventType = xmlDoc.querySelector('tpEvento');
            const cStatEvento = xmlDoc.querySelector('retEvento cStat');
            const xMotivoEvento = xmlDoc.querySelector('retEvento xMotivo');

            if (eventType && eventType.textContent === '110111') {
                if (cStatEvento && cStatEvento.textContent === '135') {
                    return { text: 'CANCELADA (Evento 135)', class: 'status-cancelada', isAutorizada: false };
                }
            }

            // Status de Autoriza√ß√£o (cStat)
            if (cStat === '100') {
                return { text: 'AUTORIZADA (100)', class: 'status-autorizada', isAutorizada: true };
            } else if (cStat === '150') {
                return { text: 'AUTORIZADA FORA DO PRAZO (150)', class: 'status-autorizada', isAutorizada: true };
            } else if (cStat === '101' || xMotivo.includes('Cancelamento')) {
                // Caso o XML seja de cancelamento (ou cStat 101, que √© cancelamento)
                return { text: 'CANCELADA (101/Evento)', class: 'status-cancelada', isAutorizada: false };
            } else if (cStat !== 'N/A') {
                // Outros c√≥digos s√£o rejei√ß√µes ou n√£o autorizados
                return { text: `N√ÉO AUTORIZADA (${cStat} - ${xMotivo})`, class: 'status-sem-autorizacao', isAutorizada: false };
            }

            return { text: 'SEM AUTORIZA√á√ÉO (Erro Leitura)', class: 'status-sem-autorizacao', isAutorizada: false };
        }

        // --- NOVO: Fun√ß√µes de Visualiza√ß√£o de Detalhes do XML (DANFE Simplificado) ---

        /**
         * Converte um XMLDoc (retorno do DOMParser) para uma string HTML de visualiza√ß√£o de detalhes.
         * @param {XMLDocument} xmlDoc - O documento XML da NF-e/NFC-e.
         * @param {Object} nota - O objeto nota fiscal j√° processado.
         * @returns {string} HTML contendo os detalhes da nota.
         */
        function gerarHtmlDetalhes(xmlDoc, nota) {
            let html = `<h2>DANFE Simplificado - Detalhes da Nota Fiscal</h2>`;

            const infNFe = xmlDoc.querySelector('infNFe');
            if (!infNFe) return `<p>Erro ao ler a estrutura do XML.</p>`;
            
            // =========================================================================
            // 1. DADOS B√ÅSICOS (Identifica√ß√£o)
            // =========================================================================
            html += `<div class="danfe-section">
                <h3>1. Identifica√ß√£o da NF-e/NFC-e</h3>
                <div class="danfe-item">
                    <div class="danfe-field">
                        <span class="danfe-label">Chave de Acesso</span>
                        <span class="danfe-value">${nota.chave}</span>
                    </div>
                    <div class="danfe-field">
                        <span class="danfe-label">S√©rie / N√∫mero</span>
                        <span class="danfe-value">${nota.serie} / ${nota.nNF}</span>
                    </div>
                    <div class="danfe-field">
                        <span class="danfe-label">Modelo (Mod)</span>
                        <span class="danfe-value">${nota.mod === '55' ? 'NF-e (55)' : 'NFC-e (65)'}</span>
                    </div>
                    <div class="danfe-field">
                        <span class="danfe-label">Data e Hora de Emiss√£o</span>
                        <span class="danfe-value">${formatarDataHora(safeText(xmlDoc, 'dhEmi'))}</span>
                    </div>
                    <div class="danfe-field">
                        <span class="danfe-label">CFOP</span>
                        <span class="danfe-value">${nota.cfop}</span>
                    </div>
                </div>
                <div class="danfe-item">
                    <div class="danfe-field">
                        <span class="danfe-label">Protocolo de Autoriza√ß√£o</span>
                        <span class="danfe-value">${safeText(xmlDoc, 'nProt')}</span>
                    </div>
                    <div class="danfe-field">
                        <span class="danfe-label">Status SEFAZ</span>
                        <span class="danfe-value">${nota.statusAutorizacao.text}</span>
                    </div>
                </div>
            </div>`;

            // =========================================================================
            // 2. EMITENTE
            // =========================================================================
            const emit = xmlDoc.querySelector('emit');
            const enderEmit = emit ? emit.querySelector('enderEmit') : null;
            html += `<div class="danfe-section">
                <h3>2. Emitente</h3>
                <div class="danfe-item">
                    <div class="danfe-field">
                        <span class="danfe-label">Nome / Raz√£o Social</span>
                        <span class="danfe-value">${safeText(emit, 'xNome')}</span>
                    </div>
                    <div class="danfe-field">
                        <span class="danfe-label">CNPJ</span>
                        <span class="danfe-value">${safeText(emit, 'CNPJ')}</span>
                    </div>
                    <div class="danfe-field">
                        <span class="danfe-label">Inscri√ß√£o Estadual (IE)</span>
                        <span class="danfe-value">${safeText(emit, 'IE')}</span>
                    </div>
                </div>
                ${enderEmit ? 
                    `<div class="danfe-item">
                        <div class="danfe-field">
                            <span class="danfe-label">Endere√ßo</span>
                            <span class="danfe-value">${safeText(enderEmit, 'xLgr')}, ${safeText(enderEmit, 'nro')}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Bairro / Munic√≠pio / UF</span>
                            <span class="danfe-value">${safeText(enderEmit, 'xBairro')} / ${safeText(enderEmit, 'xMun')} / ${safeText(enderEmit, 'UF')}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">CEP</span>
                            <span class="danfe-value">${safeText(enderEmit, 'CEP')}</span>
                        </div>
                    </div>` : ''}
            </div>`;

            // =========================================================================
            // 3. DESTINAT√ÅRIO
            // =========================================================================
            const dest = xmlDoc.querySelector('dest');
            const enderDest = dest ? dest.querySelector('enderDest') : null;
            if (dest && safeText(dest, 'xNome') !== 'N/A') { // Exibe s√≥ se houver dados do destinat√°rio
                html += `<div class="danfe-section">
                    <h3>3. Destinat√°rio</h3>
                    <div class="danfe-item">
                        <div class="danfe-field">
                            <span class="danfe-label">Nome / Raz√£o Social</span>
                            <span class="danfe-value">${safeText(dest, 'xNome')}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">CPF/CNPJ</span>
                            <span class="danfe-value">${safeText(dest, 'CPF') || safeText(dest, 'CNPJ') || 'N/A'}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Inscri√ß√£o Estadual (IE)</span>
                            <span class="danfe-value">${safeText(dest, 'IE')}</span>
                        </div>
                    </div>
                    ${enderDest ? 
                        `<div class="danfe-item">
                            <div class="danfe-field">
                                <span class="danfe-label">Endere√ßo</span>
                                <span class="danfe-value">${safeText(enderDest, 'xLgr')}, ${safeText(enderDest, 'nro')}</span>
                            </div>
                            <div class="danfe-field">
                                <span class="danfe-label">Bairro / Munic√≠pio / UF</span>
                                <span class="danfe-value">${safeText(enderDest, 'xBairro')} / ${safeText(enderDest, 'xMun')} / ${safeText(enderDest, 'UF')}</span>
                            </div>
                            <div class="danfe-field">
                                <span class="danfe-label">CEP</span>
                                <span class="danfe-value">${safeText(enderDest, 'CEP')}</span>
                            </div>
                        </div>` : ''}
                </div>`;
            }

            // =========================================================================
            // 4. PRODUTOS E SERVI√áOS
            // =========================================================================
            const det = xmlDoc.querySelectorAll('det');
            if (det.length > 0) {
                let produtosHtml = `<div class="danfe-section danfe-produtos">
                    <h3>4. Produtos e Servi√ßos (${det.length} Itens)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 5%;">Item</th>
                                <th style="width: 45%;">Descri√ß√£o do Produto / Servi√ßo</th>
                                <th style="width: 10%;">NCM</th>
                                <th style="width: 10%;">Qtd</th>
                                <th style="width: 15%;">Vl Unit.</th>
                                <th style="width: 15%;">Vl Total</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                det.forEach((item, index) => {
                    const prod = item.querySelector('prod');
                    const vUnCom = safeText(prod, 'vUnCom');
                    const vProd = safeText(prod, 'vProd');
                    
                    produtosHtml += `<tr>
                        <td>${index + 1}</td>
                        <td>${safeText(prod, 'xProd')}<br><small><strong>C√≥d.:</strong> ${safeText(prod, 'cProd')} | <strong>CFOP:</strong> ${safeText(prod, 'CFOP')}</small></td>
                        <td>${safeText(prod, 'NCM')}</td>
                        <td>${safeText(prod, 'qCom')} ${safeText(prod, 'uCom')}</td>
                        <td>${formatarValor(vUnCom)}</td>
                        <td>${formatarValor(vProd)}</td>
                    </tr>`;
                });

                produtosHtml += `</tbody></table></div>`;
                html += produtosHtml;
            }

            // =========================================================================
            // 5. TOTAIS DA NF-e
            // =========================================================================
            const total = xmlDoc.querySelector('total');
            const ICMS_Tot = total ? total.querySelector('ICMSTot') : null;
            if (ICMS_Tot) {
                html += `<div class="danfe-section">
                    <h3>5. Totais e Valores</h3>
                    <div class="danfe-totais">
                        <div class="danfe-field">
                            <span class="danfe-label">Valor Total da Nota (vNF)</span>
                            <span class="danfe-value">${formatarValor(safeText(ICMS_Tot, 'vNF'))}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Valor Total dos Produtos (vProd)</span>
                            <span class="danfe-value">${formatarValor(safeText(ICMS_Tot, 'vProd'))}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Valor Total do ICMS (vICMS)</span>
                            <span class="danfe-value">${formatarValor(safeText(ICMS_Tot, 'vICMS'))}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Valor Total do IPI (vIPI)</span>
                            <span class="danfe-value">${formatarValor(safeText(ICMS_Tot, 'vIPI'))}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Valor Total do Frete (vFrete)</span>
                            <span class="danfe-value">${formatarValor(safeText(ICMS_Tot, 'vFrete'))}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Valor Total do Seguro (vSeg)</span>
                            <span class="danfe-value">${formatarValor(safeText(ICMS_Tot, 'vSeg'))}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Outras Despesas (vOutro)</span>
                            <span class="danfe-value">${formatarValor(safeText(ICMS_Tot, 'vOutro'))}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Valor Total do Desconto (vDesc)</span>
                            <span class="danfe-value">${formatarValor(safeText(ICMS_Tot, 'vDesc'))}</span>
                        </div>
                    </div>
                </div>`;
            }

            // =========================================================================
            // 6. TRANSPORTE
            // =========================================================================
            const transp = xmlDoc.querySelector('transp');
            const transportadora = transp ? transp.querySelector('transporta') : null;
            const vol = transp ? transp.querySelector('vol') : null;
            if (transp) {
                const modFrete = safeText(transp, 'modFrete');
                const freteDesc = modFrete === '0' ? '0-Emitente (CIF)' : 
                                modFrete === '1' ? '1-Destinat√°rio (FOB)' :
                                modFrete === '2' ? '2-Terceiros' :
                                modFrete === '9' ? '9-Sem Frete' : modFrete;

                html += `<div class="danfe-section">
                    <h3>6. Dados do Transporte</h3>
                    <div class="danfe-item">
                        <div class="danfe-field">
                            <span class="danfe-label">Modalidade do Frete</span>
                            <span class="danfe-value">${freteDesc}</span>
                        </div>
                    </div>`;
                
                if (transportadora && safeText(transportadora, 'xNome') !== 'N/A') {
                    html += `<div class="danfe-item">
                        <div class="danfe-field">
                            <span class="danfe-label">Transportadora</span>
                            <span class="danfe-value">${safeText(transportadora, 'xNome')}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">CPF/CNPJ</span>
                            <span class="danfe-value">${safeText(transportadora, 'CNPJ') || safeText(transportadora, 'CPF')}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Inscri√ß√£o Estadual (IE)</span>
                            <span class="danfe-value">${safeText(transportadora, 'IE')}</span>
                        </div>
                    </div>`;
                }

                if (vol) {
                    html += `<div class="danfe-item">
                        <div class="danfe-field">
                            <span class="danfe-label">Esp√©cie / Marca / Numera√ß√£o</span>
                            <span class="danfe-value">${safeText(vol, 'esp')} / ${safeText(vol, 'marca')} / ${safeText(vol, 'nVol')}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Peso Bruto / Peso L√≠quido</span>
                            <span class="danfe-value">${safeText(vol, 'pesoB')} Kg / ${safeText(vol, 'pesoL')} Kg</span>
                        </div>
                    </div>`;
                }
                
                html += `</div>`; // Fecha .danfe-section Transporte
            }

            // =========================================================================
            // 7. INFORMA√á√ïES ADICIONAIS
            // =========================================================================
            const infAdic = xmlDoc.querySelector('infAdic');
            const infCpl = safeText(infAdic, 'infCpl');
            const infFisco = safeText(infAdic, 'infFisco');
            if (infCpl || infFisco) {
                html += `<div class="danfe-section">
                    <h3>7. Informa√ß√µes Adicionais</h3>`;
                    if (infCpl) {
                        html += `<div class="danfe-field" style="min-width: 100%;">
                            <span class="danfe-label">Informa√ß√µes Complementares (Contribuinte)</span>
                            <span class="danfe-value">${infCpl}</span>
                        </div>`;
                    }
                    if (infFisco) {
                        html += `<div class="danfe-field" style="min-width: 100%;">
                            <span class="danfe-label">Informa√ß√µes para o Fisco</span>
                            <span class="danfe-value">${infFisco}</span>
                        </div>`;
                    }
                html += `</div>`;
            }

            // =========================================================================
            // 8. PAGAMENTO
            // =========================================================================
            const pag = xmlDoc.querySelector('pag');
            const detPag = pag ? pag.querySelector('detPag') : null;
            if (detPag) {
                const tPag = safeText(detPag, 'tPag');
                const vPag = safeText(detPag, 'vPag');
                const indPag = safeText(xmlDoc, 'indPag'); // '0'=Pagamento √† vista; '1'=Pagamento a prazo; '2'=Outros
                
                html += `<div class="danfe-section">
                    <h3>8. Dados de Pagamento</h3>
                    <div class="danfe-item">
                        <div class="danfe-field">
                            <span class="danfe-label">Indicador de Pagamento</span>
                            <span class="danfe-value">${indPag === '0' ? '√Ä Vista' : indPag === '1' ? 'A Prazo' : 'Outros'}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Forma de Pagamento (tPag)</span>
                            <span class="danfe-value">${formasPagamento[tPag] || tPag}</span>
                        </div>
                        <div class="danfe-field">
                            <span class="danfe-label">Valor do Pagamento</span>
                            <span class="danfe-value">${formatarValor(vPag)}</span>
                        </div>
                    </div>
                </div>`;
            }

            // =========================================================================
            // 9. QR CODE (NFC-e)
            // =========================================================================
            const urlChave = safeText(xmlDoc, 'urlChave');
            if (nota.mod === '65' && urlChave) { // NFC-e e tem o campo do QR Code
                const qrCode = safeText(xmlDoc, 'qrCode');
                html += `<div class="danfe-section" style="text-align: center;">
                    <h3>9. QR Code da NFC-e</h3>
                    <div class="danfe-field" style="min-width: 100%;">
                        <span class="danfe-label">URL para Consulta</span>
                        <span class="danfe-value">${urlChave}</span>
                    </div>
                    <p>O QR Code n√£o pode ser gerado diretamente aqui, mas o conte√∫do √©:</p>
                    <textarea readonly style="width: 100%; height: 100px; font-size: 8pt; resize: none; border: 1px solid #ccc; padding: 5px;">${qrCode}</textarea>
                </div>`;
            }

            // Adiciona o XML Bruto no final para garantir que "n√£o omita nem corte nenhuma informa√ß√£o"
            const xmlOriginal = arquivosXML.find(a => a.chave === nota.chave)?.content || 'N√£o encontrado.';
            html += `<div class="danfe-section">
                <h3>10. XML Bruto (Informa√ß√£o Completa)</h3>
                <p>Para consulta t√©cnica e completa de todas as tags:</p>
                <textarea readonly style="width: 100%; height: 300px; font-size: 8pt; resize: none; border: 1px solid #ccc; padding: 5px;">${xmlOriginal}</textarea>
            </div>`;

            return html;
        }

        /**
         * Exibe a modal de detalhes com base na chave de acesso da nota.
         * @param {string} chaveAcesso - A chave de 44 d√≠gitos da NF-e/NFC-e.
         */
        function mostrarDetalhesXML(chaveAcesso) {
            const nota = notasFiscais.find(n => n.chave === chaveAcesso);
            const arquivo = arquivosXML.find(a => a.chave === chaveAcesso);

            if (!nota || !arquivo) {
                alert('Detalhes da nota fiscal n√£o encontrados. Tente recarregar os XMLs.');
                return;
            }

            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(arquivo.content, "application/xml");

                const detalhesHtml = gerarHtmlDetalhes(xmlDoc, nota);

                document.getElementById('detalhesXMLContent').innerHTML = detalhesHtml;
                document.getElementById('modalDetalhes').style.display = 'block';

            } catch (e) {
                console.error('Erro ao exibir detalhes do XML:', e);
                document.getElementById('detalhesXMLContent').innerHTML = `<p>Erro ao processar o XML para exibi√ß√£o de detalhes. Consulte o XML Bruto. Erro: ${e.message}</p>`;
                document.getElementById('modalDetalhes').style.display = 'block';
            }
        }

        /**
         * Fecha a modal de detalhes.
         * @param {Event} event - O evento de clique.
         */
        function fecharDetalhes(event) {
            // Fecha apenas se clicar no bot√£o 'x' ou fora do modal-content
            if (event.target === document.getElementById('modalDetalhes') || event.target.className === 'close-button') {
                document.getElementById('modalDetalhes').style.display = 'none';
            }
        }
    </script>
</body>
</html>
