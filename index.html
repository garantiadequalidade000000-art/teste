<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Sequ√™ncia de NF-e/NFC-e</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Paleta de Cores: Baseado na Logo (Laranja Escuro) */
        :root {
            --cor-principal: #D9531E; /* Laranja Escuro (Mais profissional) */
            --cor-secundaria: #333; /* Cinza escuro para texto e detalhes (quase preto) */
            --cor-fundo: #f4f4f9;
            --cor-borda: #ddd;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            background-color: var(--cor-fundo);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho e Logo */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--cor-principal);
            padding-bottom: 10px;
        }

        header img {
            width: 50px; /* Ajuste o tamanho da logo conforme necess√°rio */
            height: auto;
        }
        
        header h1 {
            color: var(--cor-secundaria);
            font-size: 24pt;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        #drop-area { 
            border: 3px dashed var(--cor-borda); 
            background-color: #fff;
            padding: 30px; 
            text-align: center; 
            margin-bottom: 20px; 
            cursor: pointer; 
            transition: border-color 0.3s, background-color 0.3s;
            border-radius: 8px;
            font-size: 1.1em;
        }

        #drop-area.highlight {
            border-color: var(--cor-principal);
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        
        /* Bot√µes e Filtros */
        .controls-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            margin-bottom: 20px;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            background-color: var(--cor-principal);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        
        button:hover:not(:disabled) {
            background-color: #A34017; /* Tom mais escuro do laranja */
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Select de Filtros */
        #filterMod, #filterStatus, #filterCNPJ { /* Adicionado #filterCNPJ */
            padding: 10px;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
            background-color: #fff;
            color: var(--cor-secundaria);
        }
        
        /* Tabela */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid var(--cor-borda); 
            padding: 10px; 
            text-align: left; 
            font-size: 10pt; 
        }
        th { 
            background-color: var(--cor-principal); 
            color: white; 
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        /* Estilos de Status/Sequ√™ncia */
        .quebra-indicada { 
            color: var(--cor-principal); 
            font-weight: bold; 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .sem-quebra { 
            color: #1a8a25; /* Verde escuro para OK */
            font-weight: bold;
        }
        
        /* Estilo para notas canceladas/rejeitadas */
        .status-cancelada, .status-sem-autorizacao { 
            background-color: #fcf4f2; /* Fundo mais claro para laranja */
        }
        .status-autorizada { 
            background-color: #effceb; 
        }
        
        /* Relat√≥rio para Exporta√ß√£o (PDF) */
        #relatorio-export { 
            padding: 10px; /* Reduz padding para mais espa√ßo */
            background-color: #fff; 
            font-family: Arial, sans-serif; /* Padr√£o para PDF */
            font-size: 10pt; /* Define um tamanho base menor para o PDF */
        }

        /* Tabela no PDF: Otimiza√ß√£o para evitar cortes */
        #relatorio-export table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 5px; 
            table-layout: fixed; /* For√ßa o layout da tabela a ser fixo */
        }
        
        /* *** AJUSTE PARA PDF: Fonte e Padding menor para caber mais informa√ß√£o *** */
        #relatorio-export th, #relatorio-export td { 
            padding: 5px; /* Reduz o padding das c√©lulas */
            font-size: 8pt; /* Tamanho da fonte menor nas c√©lulas */
            word-wrap: break-word; /* Permite quebrar palavras longas, √∫til para chaves */
        }
        
        /* Estilo para a coluna de Valor Total no PDF para garantir que caiba */
        #relatorio-export table tbody tr td:nth-child(5) { 
            /* Se as colunas no PDF forem: S√©rie, N√∫mero, Emiss√£o, CFOP, Valor Total, Status SEFAZ */
            /* A 5a coluna √© Valor Total */
            width: 15%; 
        }
        
        /* T√≠tulo do Relat√≥rio no PDF */
        .pdf-report-title {
            font-size: 18pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px double var(--cor-principal);
            color: var(--cor-secundaria);
        }
        
        /* Cabe√ßalho do Grupo no PDF */
        .pdf-header { 
            font-size: 11pt; 
            font-weight: bold; 
            margin-top: 25px; 
            margin-bottom: 5px; 
            border-bottom: 2px solid var(--cor-principal); 
            padding-bottom: 5px; 
            color: var(--cor-secundaria);
        }
        
        /* Destaque para o valor total (PRETO E MENOR) */
        .total-geral {
            font-size: 16pt; 
            font-weight: bold;
            padding: 10px; 
            margin-top: 30px; 
            border: 2px solid var(--cor-secundaria); /* Borda preta */
            background-color: #f9f9f9; 
            border-radius: 5px; 
            text-align: right; 
            color: var(--cor-secundaria); /* Texto preto */
        }
        
        .total-geral span {
            font-size: 1.1em;
            color: #000;
        }

        /* Estilos do T√≠tulo do Grupo */
        #relatorio-completo h2 {
            font-size: 18pt;
            color: var(--cor-secundaria);
            margin-top: 40px;
            border-bottom: 1px solid var(--cor-borda);
            padding-bottom: 5px;
        }
        
        #relatorio-completo h3 {
            font-size: 14pt;
            color: var(--cor-principal);
            background-color: #f9f9f9;
            padding: 10px;
            border-left: 5px solid var(--cor-principal);
            margin-top: 30px;
            margin-bottom: 0;
        }
        
        /* Estilos para o Resumo */
        .resumo-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .resumo-table-container {
            flex: 1;
            min-width: 300px;
        }

        .resumo-table-container h4 {
            font-size: 12pt;
            color: var(--cor-secundaria);
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--cor-borda);
        }

        .resumo-table-container table {
            width: 100%;
            margin-top: 0;
            box-shadow: none;
        }
        
        .resumo-table-container th {
            background-color: #555; /* Cinza mais escuro */
        }
        
        /* Campo de Busca */
        #search-container {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #searchInput {
            padding: 10px;
            flex-grow: 1;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            font-size: 1em;
        }
        
        /* Estilos para a nova se√ß√£o de downloads/filtros */
        .download-group, .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .download-group {
            margin-left: auto; /* Empurra para a direita */
        }
        
        /* --- ESTILOS DO MODAL DANFE SIMPLIFICADO --- */
        .modal {
            display: none; /* Oculto por padr√£o */
            position: fixed; /* Fica por cima de tudo */
            z-index: 1000; /* Alto z-index */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita scroll se necess√°rio */
            background-color: rgba(0,0,0,0.7); /* Fundo semi-transparente */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto; /* 5% do topo e centralizado */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* 90% de largura */
            max-width: 800px; /* Limite de largura */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Layout Simplificado DANFE */
        .danfe-header, .danfe-section {
            border: 1px solid var(--cor-borda);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .danfe-header h4 {
            color: var(--cor-principal);
            margin: 0 0 10px 0;
            border-bottom: 2px solid var(--cor-borda);
            padding-bottom: 5px;
        }
        
        .danfe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }
        
        .danfe-grid div {
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
        }

        .danfe-grid span {
            font-weight: bold;
            color: var(--cor-secundaria);
        }

        .danfe-products table, .danfe-taxes table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .danfe-products th, .danfe-taxes th {
            background-color: #555;
            color: white;
            padding: 8px;
            font-size: 0.8em;
        }
        
        .danfe-products td, .danfe-taxes td {
            padding: 5px 8px;
            border: 1px solid var(--cor-borda);
            font-size: 0.8em;
        }

    </style>
</head>
<body>

    <header>
        <img src="https://res.cloudinary.com/drsyomd2a/image/upload/v1762261454/Design-sem-nome_uxeex5.png" alt="Logo">
        <h1>Verificador de Quebra de Sequ√™ncia NF-e / NFC-e</h1>
        <div style="width: 50px;"></div> 
    </header>

    <div id="drop-area">
        Arraste e solte arquivos **XML** (ou clique para selecionar)<br>
        *Voc√™ pode adicionar arquivos de diferentes pastas consecutivamente.*
        <input type="file" id="fileElem" multiple accept=".xml" style="display: none;">
    </div>

    <div class="controls-container">
        <div class="action-group">
            <button onclick="processarNotas()" id="processButton" disabled>‚öôÔ∏è Processar e Verificar Sequ√™ncia</button>
            <button onclick="gerarRelatorioPDF()" id="pdfButton" disabled>üíæ Gerar PDF do Relat√≥rio</button>
            <button onclick="limparArquivos()" id="clearButton">üóëÔ∏è Limpar Arquivos</button>
        </div>

        <div class="download-group" id="downloadGroup" style="display: none;">
            <button onclick="compactarEBaixarXML('NFE')" id="downloadNFEButton">üì¶ Baixar XMLs NF-e</button>
            <button onclick="compactarEBaixarXML('NFCE')" id="downloadNFCEButton">üì¶ Baixar XMLs NFC-e</button>
        </div>
    </div>
    
    <h2>Relat√≥rio de Notas Fiscais (Visualiza√ß√£o Completa)</h2>
    
    <div id="filter-container" style="display: none;" class="controls-container">
        
        <div class="filter-group">
            <label for="filterCNPJ">CNPJ:</label>
            <select id="filterCNPJ" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todos os CNPJs</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filterMod">Tipo de Nota:</label>
            <select id="filterMod" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (NF-e e NFC-e)</option>
                <option value="55">Somente NF-e (Mod. 55)</option>
                <option value="65">Somente NFC-e (Mod. 65)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="filterStatus">Status SEFAZ:</label>
            <select id="filterStatus" onchange="aplicarFiltrosRelatorio()">
                <option value="ALL">Todas (Autorizadas/Canceladas/Rejeitadas)</option>
                <option value="AUTORIZADA">Somente AUTORIZADAS (100)</option>
                <option value="AUTORIZADA_FORA_PRAZO">Somente AUTORIZADAS FORA DO PRAZO (150)</option>
                <option value="NAO_AUTORIZADA">Somente CANCELADAS/REJEITADAS</option>
            </select>
        </div>
        <div id="search-container" style="display: none;">
            <input type="text" id="searchInput" placeholder="Buscar por Chave, Data, N√∫mero, CNPJ ou Valor..." onkeyup="filtrarTabela()">
            <button onclick="limparBusca()">Limpar Busca</button>
        </div>
    </div>
    
    <div id="resumo-container" style="display: none;" class="resumo-section">
        </div>
    
    <div id="relatorio-completo">
        <p>Arraste e solte arquivos XML para iniciar a verifica√ß√£o.</p>
    </div>

    <div id="xml-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharDetalhesXML()">&times;</span>
            <div id="danfe-simplified-content">
                </div>
            <div style="text-align: right; margin-top: 20px;">
                 <button onclick="imprimirDanfeSimplificado()">üñ®Ô∏è Imprimir/PDF</button>
            </div>
        </div>
    </div>

    <div id="relatorio-export" style="display: none;">
        </div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileElem = document.getElementById('fileElem');
        const relatorioContainer = document.getElementById('relatorio-completo');
        const processButton = document.getElementById('processButton');
        const pdfButton = document.getElementById('pdfButton');
        const clearButton = document.getElementById('clearButton');
        // NOVO: Refer√™ncias aos novos elementos de filtro e download
        const filterContainer = document.getElementById('filter-container');
        const filterMod = document.getElementById('filterMod');
        const filterStatus = document.getElementById('filterStatus');
        const filterCNPJ = document.getElementById('filterCNPJ'); // NOVO: Refer√™ncia ao filtro CNPJ
        const downloadGroup = document.getElementById('downloadGroup');

        let notasFiscais = []; // Array que agora acumula as notas de todas as cargas
        let gruposGlobais = {};
        let arquivosXML = []; // NOVO: Armazena o conte√∫do e nome dos arquivos XML para compacta√ß√£o

        // Mapeamento de Forma de Pagamento (tPag)
        const formasPagamento = {
            '01': 'Dinheiro',
            '02': 'Cheque',
            '03': 'Cart√£o de Cr√©dito',
            '04': 'Cart√£o de D√©bito',
            '05': 'Cr√©dito Loja',
            '10': 'Vale Alimenta√ß√£o',
            '11': 'Vale Refei√ß√£o',
            '12': 'Vale Presente',
            '13': 'Vale Combust√≠vel',
            '14': 'Duplicata Mercantil',
            '15': 'Boleto Banc√°rio',
            '16': 'Dep√≥sito Banc√°rio',
            '17': 'Pagamento Instant√¢neo (PIX)',
            '18': 'Transfer√™ncia Banc√°ria',
            '19': 'Programa de Fidelidade',
            '90': 'Sem Pagamento',
            '99': 'Outros'
        };

        // --- Eventos Drag and Drop ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileElem.click(), false);
        fileElem.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            const files = [...e.target.files];
            if (files.length === 0) return;

            // Filtrar apenas XMLs
            const xmlFiles = files.filter(file => file.name.toLowerCase().endsWith('.xml'));

            if (xmlFiles.length === 0) {
                alert('Por favor, selecione arquivos no formato XML (.xml).');
                return;
            }

            // Iniciar leitura dos arquivos
            processarArquivosXML(xmlFiles);

            // Reabilita o bot√£o de processamento se houver arquivos
            processButton.disabled = notasFiscais.length === 0 && xmlFiles.length === 0;
            processButton.textContent = `‚öôÔ∏è Processar e Verificar Sequ√™ncia (${notasFiscais.length + xmlFiles.length} arquivos)`;
            
            // Exibe a mensagem de carregamento inicial no relat√≥rio se for o primeiro lote
            if (notasFiscais.length === 0) {
                relatorioContainer.innerHTML = '<p>Arquivos carregados. Clique em "Processar e Verificar Sequ√™ncia" para gerar o relat√≥rio.</p>';
            } else {
                relatorioContainer.innerHTML = `<p>${xmlFiles.length} novos arquivos adicionados. Clique em "Processar e Verificar Sequ√™ncia" para re-processar o relat√≥rio completo.</p>`;
            }
        }

        /**
         * Lida com a leitura e extra√ß√£o de dados brutos dos XMLs.
         */
        function processarArquivosXML(files) {
            const fileReaders = files.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const xmlContent = e.target.result;
                        
                        // NOVO: Captura o conte√∫do do XML
                        try {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(xmlContent, "application/xml");

                            // Campos obrigat√≥rios para Agrupamento/Sequ√™ncia
                            const nNF = safeInt(xmlDoc, 'nNF');
                            const mod = safeText(xmlDoc, 'mod');
                            const serie = safeText(xmlDoc, 'serie');
                            const CNPJ = safeText(xmlDoc, 'CNPJ');
                            const chaveAcesso = safeText(xmlDoc, 'chNFe') || safeText(xmlDoc, 'chNFCE'); // Chave de acesso √© crucial para duplicidade

                            if (nNF && mod && serie && CNPJ !== 'N/A' && chaveAcesso) {
                                
                                // 1. VERIFICA√á√ÉO DE DUPLICIDADE (CHAVE DE ACESSO)
                                const isDuplicate = notasFiscais.some(n => n.chave === chaveAcesso);
                                if (!isDuplicate) {

                                    // 2. ADI√á√ÉO DA NOVA NOTA E ARQUIVO
                                    const dhEmi = safeText(xmlDoc, 'dhEmi');
                                    const vNF = safeText(xmlDoc, 'vNF');
                                    const cStat = safeText(xmlDoc, 'cStat');
                                    const xMotivo = safeText(xmlDoc, 'xMotivo');
                                    const cfop = safeText(xmlDoc, 'CFOP');
                                    const tPag = safeText(xmlDoc, 'tPag');
                                    const nomeFantasia = safeText(xmlDoc, 'xFant');
                                    const statusAutorizacao = formatarStatus(cStat, xMotivo, xmlDoc);

                                    // Adiciona a nota aos dados principais
                                    notasFiscais.push({
                                        chave: chaveAcesso,
                                        nNF: nNF,
                                        mod: mod,
                                        serie: serie,
                                        cnpj: CNPJ,
                                        nomeFantasia: nomeFantasia !== 'N/A' ? nomeFantasia : 'CNPJ: ' + CNPJ,
                                        dhEmi: new Date(formatarDataIso(dhEmi)),
                                        vNF: parseFloat(vNF),
                                        cStat: cStat,
                                        xMotivo: xMotivo,
                                        cfop: cfop,
                                        tPag: tPag,
                                        statusAutorizacao: statusAutorizacao,
                                        sequenciaStatus: 'PENDENTE' // Ser√° preenchido na fun√ß√£o processarNotas()
                                    });
                                    
                                    // Adiciona o XML bruto para futuras opera√ß√µes (e.g., compacta√ß√£o e detalhes DANFE)
                                    arquivosXML.push({
                                        chave: chaveAcesso,
                                        content: xmlContent,
                                        mod: mod,
                                        cnpj: CNPJ,
                                        fileName: file.name
                                    });

                                } else {
                                    console.warn(`Nota Duplicada ignorada: ${chaveAcesso}`);
                                }

                            } else {
                                console.warn(`Arquivo ignorado (dados fiscais incompletos): ${file.name}`);
                            }
                            
                        } catch (e) {
                            console.error(`Erro ao processar o arquivo ${file.name}:`, e);
                        }

                        resolve(); // Resolve, mesmo em caso de erro no processamento de um arquivo
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            });

            Promise.all(fileReaders).then(() => {
                // Habilita o bot√£o para processar agora que todos os arquivos foram lidos
                processButton.disabled = false;
                processButton.textContent = `‚öôÔ∏è Processar e Verificar Sequ√™ncia (${notasFiscais.length} arquivos)`;
            }).catch(error => {
                console.error('Erro geral na leitura de arquivos:', error);
                alert('Ocorreu um erro ao ler os arquivos.');
            });
        }


        /**
         * Fun√ß√£o principal: Verifica a sequ√™ncia e gera o relat√≥rio na tela.
         */
        function processarNotas() {
            if (notasFiscais.length === 0) {
                alert('Nenhum arquivo XML v√°lido foi carregado.');
                return;
            }

            // 1. Agrupamento
            const grupos = notasFiscais.reduce((acc, nota) => {
                // NOVO: Adiciona o tipo de nota no agrupamento
                const chaveGrupo = `${nota.cnpj}-${nota.mod}-${nota.serie}`;
                if (!acc[chaveGrupo]) {
                    acc[chaveGrupo] = {
                        info: {
                            cnpj: nota.cnpj,
                            mod: nota.mod,
                            serie: nota.serie,
                            emitente: nota.nomeFantasia
                        },
                        notas: []
                    };
                }
                acc[chaveGrupo].notas.push(nota);
                return acc;
            }, {});
            gruposGlobais = grupos; // Armazena grupos para uso na busca

            // 2. Verificar a sequ√™ncia dentro de cada grupo
            Object.values(grupos).forEach(grupo => {
                // √â crucial reordenar antes de verificar a sequ√™ncia, j√° que as notas s√£o acumuladas
                grupo.notas.sort((a, b) => a.nNF - b.nNF);
                let ultimoNumeroAutorizado = 0;

                grupo.notas.forEach((nota, index) => {
                    // A l√≥gica de sequ√™ncia deve ser aplicada apenas a notas AUTORIZADAS (incluindo 150)
                    const isAutorizada = nota.statusAutorizacao.isAutorizada;

                    if (isAutorizada) {
                        // Verifica se a nota √© a pr√≥xima na sequ√™ncia esperada
                        const esperado = ultimoNumeroAutorizado + 1;

                        if (nota.nNF === esperado) {
                            nota.sequenciaStatus = `OK (Seq. ${esperado})`;
                            ultimoNumeroAutorizado = nota.nNF;
                        } else if (nota.nNF > esperado) {
                            // Quebra detectada
                            const faltantes = [];
                            for (let i = esperado; i < nota.nNF; i++) {
                                faltantes.push(i);
                            }
                            nota.sequenciaStatus = `QUEBRA DETECTADA. Faltam: ${faltantes.join(', ')}`;
                            // Atualiza o √∫ltimo n√∫mero autorizado para continuar a sequ√™ncia
                            ultimoNumeroAutorizado = nota.nNF;
                        } else {
                            // N√∫mero menor que o √∫ltimo autorizado: Duplicidade (embora j√° tratada pela chave) ou reordena√ß√£o
                            nota.sequenciaStatus = `N√∫mero Menor que o Anterior Autorizado (${ultimoNumeroAutorizado})`;
                        }
                    } else {
                        // Notas CANCELADAS/REJEITADAS
                        nota.sequenciaStatus = `N√£o conta para sequ√™ncia (Status: ${nota.statusAutorizacao.text})`;
                        // O √∫ltimo n√∫mero autorizado N√ÉO √â ATUALIZADO para notas n√£o autorizadas
                    }
                });
            });

            // 3. Gerar o Relat√≥rio
            aplicarFiltrosRelatorio(); // Chama a fun√ß√£o que re-renderiza o HTML e aplica filtros

            // Habilita bot√µes de download e PDF
            pdfButton.disabled = false;
            downloadGroup.style.display = 'flex';
        }

        function limparArquivos() {
            // Reinicia o estado da aplica√ß√£o
            notasFiscais = [];
            gruposGlobais = {};
            arquivosXML = []; // NOVO: Limpa o array de arquivos XML
            fileElem.value = ''; // Limpa o input file

            // Reseta o estado dos bot√µes e containers
            processButton.disabled = true;
            pdfButton.disabled = true;
            processButton.textContent = `‚öôÔ∏è Processar e Verificar Sequ√™ncia`;
            filterContainer.style.display = 'none'; // Oculta o container de filtros
            downloadGroup.style.display = 'none'; // Oculta o download de XMLs
            searchInput.value = '';
            filterMod.value = 'ALL'; // Reseta filtros
            filterStatus.value = 'ALL'; // Reseta filtros
            filterCNPJ.value = 'ALL'; // NOVO: Reseta filtro CNPJ
            filterCNPJ.innerHTML = '<option value="ALL">Todos os CNPJs</option>'; // Limpa op√ß√µes de CNPJ
            relatorioContainer.innerHTML = '<p>Todos os arquivos foram removidos. Arraste e solte ou clique para carregar novos arquivos XML.</p>';
            document.getElementById('resumo-container').style.display = 'none';
        }

        // --- FUN√á√ïES DE VISUALIZA√á√ÉO DE DETALHES DO XML (DANFE SIMPLIFICADO) ---

        /**
         * Helper para extrair texto de um elemento filho usando querySelector.
         * @param {Element} parentElement - O elemento pai (emit, dest, ide, etc.).
         * @param {string} tagName - O nome da tag filha.
         * @returns {string} O texto da tag filha ou 'N/A'.
         */
        function nestedSafeText(parentElement, tagName) {
            if (!parentElement) return 'N/A';
            const element = parentElement.querySelector(tagName);
            return element ? (element.textContent || element.innerText).trim() : 'N/A';
        }

        /**
         * Abre o modal de detalhes do XML para a nota fiscal especificada.
         * @param {string} chaveAcesso - Chave de acesso da nota fiscal.
         */
        function abrirDetalhesXML(chaveAcesso) {
            const modal = document.getElementById('xml-detail-modal');
            const danfeContent = document.getElementById('danfe-simplified-content');
            danfeContent.innerHTML = 'Carregando detalhes...';
            modal.style.display = 'block';

            const xmlData = arquivosXML.find(arq => arq.chave === chaveAcesso);
            const notaData = notasFiscais.find(n => n.chave === chaveAcesso);

            if (!xmlData) {
                danfeContent.innerHTML = '<p style="color:red;">Erro: Conte√∫do XML n√£o encontrado para esta chave.</p>';
                return;
            }

            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlData.content, "application/xml");
                const detalhes = extrairDetalhesDanfe(xmlDoc, notaData);
                renderizarDetalhesDanfe(detalhes);
            } catch (e) {
                console.error("Erro ao processar o XML para detalhes:", e);
                danfeContent.innerHTML = '<p style="color:red;">Erro ao processar o conte√∫do do XML. Verifique a estrutura do arquivo.</p>';
            }
        }

        /**
         * Fecha o modal de detalhes do XML.
         */
        function fecharDetalhesXML() {
            document.getElementById('xml-detail-modal').style.display = 'none';
        }

        // Fecha o modal se o usu√°rio clicar fora dele
        window.onclick = function(event) {
            const modal = document.getElementById('xml-detail-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        /**
         * Extrai os dados complexos (produtos, impostos, etc.) do XML para o DANFE simplificado.
         * @param {XMLDocument} xmlDoc - O documento XML.
         * @param {object} notaData - Dados resumidos da nota (para pegar informa√ß√µes de status/sequ√™ncia).
         * @returns {object} Detalhes da nota fiscal.
         */
        function extrairDetalhesDanfe(xmlDoc, notaData) {
            const infNFe = xmlDoc.querySelector('infNFe') || xmlDoc.querySelector('infNFCE');
            const ide = infNFe.querySelector('ide');
            const emit = infNFe.querySelector('emit');
            const dest = infNFe.querySelector('dest');
            const total = infNFe.querySelector('total');
            
            // Dados Principais
            const detalhes = {
                chave: notaData.chave,
                status: notaData.statusAutorizacao.text,
                sequencia: notaData.sequenciaStatus,
                modelo: nestedSafeText(ide, 'mod') === '55' ? 'NF-e' : 'NFC-e',
                nNF: nestedSafeText(ide, 'nNF'),
                serie: nestedSafeText(ide, 'serie'),
                dataEmissao: formatarDataHora(nestedSafeText(ide, 'dhEmi')),
                CFOP: nestedSafeText(infNFe.querySelector('det:first-child prod'), 'CFOP') || 'N/A', // Pega o CFOP do primeiro item
                natOp: nestedSafeText(ide, 'natOp')
            };

            // Emitente
            detalhes.emitente = {
                nome: nestedSafeText(emit, 'xNome'),
                CNPJ: nestedSafeText(emit, 'CNPJ'),
                fantasia: nestedSafeText(emit, 'xFant'),
                IE: nestedSafeText(emit, 'IE'),
                fone: nestedSafeText(emit.querySelector('enderEmit'), 'fone')
            };
            
            // Destinat√°rio
            detalhes.destinatario = {
                nome: nestedSafeText(dest, 'xNome'),
                CNPJ_CPF: nestedSafeText(dest, 'CNPJ') || nestedSafeText(dest, 'CPF') || nestedSafeText(dest, 'idEstrangeiro') || 'N√£o Identificado',
                IE: nestedSafeText(dest, 'IE') || 'ISENTO',
                UF: nestedSafeText(dest.querySelector('enderDest'), 'UF') || 'EX'
            };
            
            // Totais (ICMS, IPI, PIS, COFINS e Total)
            const ICMS_Total = total.querySelector('ICMSTot');
            detalhes.totais = {
                vProd: formatarValor(nestedSafeText(ICMS_Total, 'vProd')),
                vICMS: formatarValor(nestedSafeText(ICMS_Total, 'vICMS')),
                vIPI: formatarValor(nestedSafeText(ICMS_Total, 'vIPI')),
                vPIS: formatarValor(nestedSafeText(ICMS_Total, 'vPIS') || '0.00'),
                vCOFINS: formatarValor(nestedSafeText(ICMS_Total, 'vCOFINS') || '0.00'),
                vNF: formatarValor(nestedSafeText(ICMS_Total, 'vNF'))
            };

            // Produtos
            detalhes.produtos = [];
            const itens = infNFe.querySelectorAll('det');
            itens.forEach(item => {
                const prod = item.querySelector('prod');
                const imposto = item.querySelector('imposto');
                
                let vICMS = '0.00';
                const ICMSNode = imposto.querySelector('ICMS');
                if (ICMSNode) {
                    vICMS = nestedSafeText(ICMSNode, 'vICMS') || nestedSafeText(ICMSNode, 'vICMSST') || '0.00';
                }

                detalhes.produtos.push({
                    cProd: nestedSafeText(prod, 'cProd'),
                    xProd: nestedSafeText(prod, 'xProd'),
                    qCom: nestedSafeText(prod, 'qCom'),
                    vUnCom: formatarValor(nestedSafeText(prod, 'vUnCom')),
                    vProd: formatarValor(nestedSafeText(prod, 'vProd')),
                    vICMS: formatarValor(vICMS)
                });
            });

            return detalhes;
        }

        /**
         * Renderiza o HTML do DANFE simplificado dentro do modal.
         * @param {object} detalhes - Detalhes da nota fiscal extra√≠dos do XML.
         */
        function renderizarDetalhesDanfe(detalhes) {
            const danfeContent = document.getElementById('danfe-simplified-content');
            
            let html = '';
            
            // Cabe√ßalho da Nota
            html += `<div class="danfe-header">
                <h4>${detalhes.modelo} - Resumo Simplificado</h4>
                <div class="danfe-grid">
                    <div><span>N√∫mero:</span> ${detalhes.nNF} | S√©rie: ${detalhes.serie}</div>
                    <div><span>Emiss√£o:</span> ${detalhes.dataEmissao}</div>
                    <div><span>Chave de Acesso:</span> ${detalhes.chave}</div>
                    <div><span>Natureza da Opera√ß√£o:</span> ${detalhes.natOp}</div>
                    <div><span>Status SEFAZ:</span> <span class="${detalhes.sequencia.includes('QUEBRA') ? 'quebra-indicada' : 'sem-quebra'}">${detalhes.status}</span></div>
                    <div><span>Sequ√™ncia:</span> ${detalhes.sequencia}</div>
                </div>
            </div>`;

            // Emitente
            html += `<div class="danfe-section">
                <h4>Dados do Emitente</h4>
                <div class="danfe-grid">
                    <div><span>Nome/Raz√£o Social:</span> ${detalhes.emitente.nome}</div>
                    <div><span>CNPJ:</span> ${detalhes.emitente.CNPJ}</div>
                    <div><span>Nome Fantasia:</span> ${detalhes.emitente.fantasia || 'N/A'}</div>
                    <div><span>Inscri√ß√£o Estadual:</span> ${detalhes.emitente.IE}</div>
                    <div><span>Telefone:</span> ${detalhes.emitente.fone || 'N/A'}</div>
                </div>
            </div>`;
            
            // Destinat√°rio
            html += `<div class="danfe-section">
                <h4>Dados do Destinat√°rio</h4>
                <div class="danfe-grid">
                    <div><span>Nome/Raz√£o Social:</span> ${detalhes.destinatario.nome}</div>
                    <div><span>CNPJ/CPF:</span> ${detalhes.destinatario.CNPJ_CPF}</div>
                    <div><span>Inscri√ß√£o Estadual:</span> ${detalhes.destinatario.IE}</div>
                    <div><span>UF:</span> ${detalhes.destinatario.UF}</div>
                </div>
            </div>`;

            // Totais
            html += `<div class="danfe-section danfe-taxes">
                <h4>Totais da Nota Fiscal</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Valor dos Produtos</th>
                            <th>Valor Total da NF</th>
                            <th>ICMS</th>
                            <th>IPI</th>
                            <th>PIS</th>
                            <th>COFINS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${detalhes.totais.vProd}</td>
                            <td><span style="font-weight: bold;">${detalhes.totais.vNF}</span></td>
                            <td>${detalhes.totais.vICMS}</td>
                            <td>${detalhes.totais.vIPI}</td>
                            <td>${detalhes.totais.vPIS}</td>
                            <td>${detalhes.totais.vCOFINS}</td>
                        </tr>
                    </tbody>
                </table>
            </div>`;
            
            // Produtos
            html += `<div class="danfe-section danfe-products">
                <h4>Itens da Nota Fiscal (${detalhes.produtos.length} produtos)</h4>
                <table>
                    <thead>
                        <tr>
                            <th>C√≥d. Produto</th>
                            <th>Descri√ß√£o do Produto</th>
                            <th>CFOP</th>
                            <th>Qtd.</th>
                            <th>Vlr. Unit√°rio</th>
                            <th>Vlr. Total</th>
                            <th>Vlr. ICMS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${detalhes.produtos.map(p => `
                            <tr>
                                <td>${p.cProd}</td>
                                <td>${p.xProd}</td>
                                <td>${detalhes.CFOP}</td>
                                <td>${p.qCom}</td>
                                <td>${p.vUnCom}</td>
                                <td>${p.vProd}</td>
                                <td>${p.vICMS}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;

            danfeContent.innerHTML = html;
        }

        /**
         * Imprime o conte√∫do do DANFE Simplificado dentro do modal.
         */
        function imprimirDanfeSimplificado() {
            const modalContent = document.querySelector('.modal-content');
            const closeButton = modalContent.querySelector('.close-button');
            const printButton = modalContent.querySelector('button');

            // Oculta elementos que n√£o devem aparecer na impress√£o
            closeButton.style.display = 'none';
            printButton.style.display = 'none';

            // Cria um elemento tempor√°rio para a impress√£o
            const printDiv = document.createElement('div');
            printDiv.style.padding = '20px'; // Adiciona padding para o PDF
            printDiv.innerHTML = document.getElementById('danfe-simplified-content').innerHTML;
            
            // Re-adiciona ao body para o html2pdf capturar
            document.body.appendChild(printDiv);

            // Cria e configura o PDF
            const opt = {
                margin: 10,
                filename: 'DANFE_Simplificado.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(printDiv).save().then(() => {
                // Restaura a visualiza√ß√£o no modal ap√≥s a gera√ß√£o
                closeButton.style.display = 'block';
                printButton.style.display = 'block';
                 // Remove o elemento tempor√°rio
                document.body.removeChild(printDiv);
            });
        }


        // --- Fun√ß√µes Auxiliares de Leitura e Formata√ß√£o (SEM ALTERA√á√ïES na sintaxe original) ---
        function safeText(xmlDoc, tagName) {
            let element = xmlDoc.getElementsByTagName(tagName)[0];
            return element ? (element.textContent || element.innerText).trim() : 'N/A';
        }

        function safeInt(xmlDoc, tagName) {
            const text = safeText(xmlDoc, tagName);
            const num = parseInt(text);
            return isNaN(num) ? 0 : num;
        }
        
        /* Converte a data e hora ISO para um formato brasileiro leg√≠vel. */
        function formatarDataHora(dataHoraIso) {
            if (dataHoraIso === 'N/A') return 'N/A';
            const date = new Date(dataHoraIso);
            if (isNaN(date)) return 'Data Inv√°lida';
            
            const data = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const hora = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            return `${data} ${hora}`;
        }
        
        /* Converte o formato ISO para o formato aceito pelo new Date(). */
        function formatarDataIso(dataHoraIso) {
            if (dataHoraIso.includes('T')) {
                 // Formato: AAAA-MM-DDTHH:MM:SS-03:00 (ajusta para compatibilidade)
                return dataHoraIso.substring(0, 19);
            }
            return dataHoraIso; // Se for s√≥ a data, deixa passar
        }

        /* Formata um valor num√©rico para o padr√£o de moeda brasileira (R$ X.XXX,XX). */
        function formatarValor(valor) {
            if (valor === undefined || valor === null || isNaN(parseFloat(valor))) {
                return 'R$ 0,00';
            }
            const numero = parseFloat(valor);
            return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function formatarStatus(cStat, xMotivo, xmlDoc) {
            const eventType = xmlDoc.querySelector('tpEvento');
            const cStatEvento = xmlDoc.querySelector('retEvento cStat');
            const xMotivoEvento = xmlDoc.querySelector('retEvento xMotivo');
            
            if (eventType && eventType.textContent === '110111') { // Evento de Cancelamento
                if (cStatEvento && cStatEvento.textContent === '135') {
                    return { text: 'CANCELADA (Evento 135)', class: 'status-cancelada', isAutorizada: false, isAutorizadaForaPrazo: false }; // ATUALIZA√á√ÉO: Adicionado isAutorizadaFora...
                }
            }

            switch (cStat) {
                case '100':
                    return { text: 'AUTORIZADA', class: 'status-autorizada', isAutorizada: true, isAutorizadaForaPrazo: false };
                case '101': // Cancelada
                case '150':
                    return { text: 'AUTORIZADA FORA DO PRAZO', class: 'status-autorizada', isAutorizada: true, isAutorizadaForaPrazo: true };
                case '102':
                    return { text: 'INUTILIZADA', class: 'status-cancelada', isAutorizada: false, isAutorizadaForaPrazo: false };
                case '110':
                    return { text: 'DENIED (Cancelamento)', class: 'status-cancelada', isAutorizada: false, isAutorizadaForaPrazo: false };
                case '999': // Erro n√£o catalogado
                case '204': // Rejei√ß√£o: Duplicidade
                case '215': // Rejei√ß√£o: NF-e n√£o √© NFC-e e vice-versa
                case '301': // Uso Denegado (C√°uculo indevido)
                case '302': // Uso Denegado (Irregularidade)
                case '303': // Uso Denegado (Lote)
                case '998': // Erro Geral
                    return { text: `REJEITADA (${cStat}) - ${xMotivo}`, class: 'status-sem-autorizacao', isAutorizada: false, isAutorizadaForaPrazo: false };
                default:
                    // Outras rejei√ß√µes
                    if (parseInt(cStat) >= 200 && parseInt(cStat) < 700) {
                        return { text: `REJEITADA (${cStat}) - ${xMotivo}`, class: 'status-sem-autorizacao', isAutorizada: false, isAutorizadaForaPrazo: false };
                    }
                    return { text: `Status Desconhecido (${cStat})`, class: 'status-sem-autorizacao', isAutorizada: false, isAutorizadaForaPrazo: false };
            }
        }
        
        /* Fun√ß√£o para formatar a data para o t√≠tulo do PDF (M√™s/Ano). */
        function formatarDataParaTitulo(date) {
            return date.toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' }).replace('/', '_');
        }

        /* Obt√©m o per√≠odo de emiss√£o (m√™s/ano min e max) das notas filtradas. */
        function obterPeriodoEmissaoPrincipal() {
            // ATUALIZA√á√ÉO: Filtra as notas pelo CNPJ selecionado (se n√£o for 'ALL')
            const notasFiltradas = notasFiscais.filter(n => filterCNPJ.value === 'ALL' || n.cnpj === filterCNPJ.value);

            if (notasFiltradas.length === 0) return 'ND';

            const datas = notasFiltradas.map(n => n.dhEmi.getTime());
            const minDate = new Date(Math.min(...datas));
            const maxDate = new Date(Math.max(...datas));

            const formatar = (d) => d.toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' });
            
            const periodoMin = formatar(minDate);
            const periodoMax = formatar(maxDate);

            if (periodoMin === periodoMax) {
                return periodoMin.replace('/', '_');
            } else {
                return `${periodoMin.replace('/', '_')}_a_${periodoMax.replace('/', '_')}`;
            }
        }
        
        /* Obt√©m o nome fantasia mais comum para ser usado no t√≠tulo. */
        function obterNomeFantasiaPrincipal() {
            // ATUALIZA√á√ÉO: Retorna 'Empresa' se o filtro for ALL
            if (filterCNPJ.value === 'ALL') {
                return 'Empresa';
            }
            // Considera apenas notas do CNPJ filtrado.
            const notasFiltradas = notasFiscais.filter(n => n.cnpj === filterCNPJ.value);
            if (notasFiltradas.length === 0) return 'Empresa';

            const contagem = notasFiltradas.reduce((acc, nota) => {
                const nome = nota.nomeFantasia;
                acc[nome] = (acc[nome] || 0) + 1;
                return acc;
            }, {});

            let nomePrincipal = 'Empresa';
            let maxCount = 0;
            for (const nome in contagem) {
                if (contagem[nome] > maxCount) {
                    maxCount = contagem[nome];
                    nomePrincipal = nome;
                }
            }
            // Remove espa√ßos e substitui por underscore para o nome do arquivo
            return nomePrincipal.replace(/\s/g, '_');
        }

        // --- Gera√ß√£o de Relat√≥rio na Tela ---

        function gerarRelatorioHTML(grupos) {
            if (Object.keys(grupos).length === 0) {
                relatorioContainer.innerHTML = '<p>Nenhuma nota fiscal encontrada para os filtros aplicados.</p>';
                document.getElementById('resumo-container').style.display = 'none';
                return;
            }

            // Popula o filtro de CNPJ (NOVO)
            const cnpsUnicos = ['ALL', ...new Set(notasFiscais.map(n => n.cnpj))];
            filterCNPJ.innerHTML = cnpsUnicos.map(cnpj => {
                const isSelected = cnpj === filterCNPJ.value;
                const nomeFantasia = cnpj !== 'ALL' ? notasFiscais.find(n => n.cnpj === cnpj).nomeFantasia : 'Todos os CNPJs';
                return `<option value="${cnpj}" ${isSelected ? 'selected' : ''}>${cnpj} (${nomeFantasia})</option>`;
            }).join('');
            
            // Exibe o container de filtros se houver dados
            filterContainer.style.display = 'flex';
            document.getElementById('search-container').style.display = 'flex';

            let html = '';
            let totalGeral = 0;
            let temGrupoVisivel = false;

            // Ordena as chaves do grupo para exibir NF-e antes de NFC-e
            const chavesOrdenadas = Object.keys(grupos).sort((a, b) => {
                const modA = grupos[a].info.mod;
                const modB = grupos[b].info.mod;
                if (modA === modB) return 0;
                if (modA === '55') return -1; // NF-e (55) primeiro
                if (modB === '55') return 1;
                return 0;
            });
            
            chavesOrdenadas.forEach(chaveGrupo => {
                const grupo = grupos[chaveGrupo];
                const info = grupo.info;
                const notas = grupo.notas;
                let subtotalGrupo = 0;

                const tipoNota = info.mod === '55' ? 'NF-e' : (info.mod === '65' ? 'NFC-e' : `Mod. ${info.mod}`); // NOVO: Tipo de nota

                // NOVO: Aplica o filtro de CNPJ no agrupamento
                if (filterCNPJ.value !== 'ALL' && info.cnpj !== filterCNPJ.value) {
                    return; // Ignora o grupo se n√£o corresponder ao filtro de CNPJ
                }
                
                temGrupoVisivel = true;

                // Adiciona o ID da chave do grupo na div de tabelas para facilitar a busca
                let htmlGrupo = `
                    <div id="table-group-${chaveGrupo}" data-mod="${info.mod}" data-cnpj="${info.cnpj}">
                        ${filterCNPJ.value === 'ALL' ? '' : `<h3>üßæ ${info.emitente} (CNPJ: ${info.cnpj}) - ${tipoNota} - S√©rie: ${info.serie}</h3>`}
                        <table id="table-${chaveGrupo}">
                            <thead>
                                <tr>
                                    <th>S√©rie</th>
                                    <th>N√∫mero</th>
                                    <th>Emiss√£o</th>
                                    <th>CFOP</th>
                                    <th>Forma Pag.</th>
                                    <th>Valor Total</th>
                                    <th>Status Sequ√™ncia</th>
                                    <th>Status SEFAZ</th>
                                    <th>A√ß√µes</th> </tr>
                            </thead>
                            <tbody>
                                ${notas.map(nota => {
                                    // Filtros de Mod e Status ser√£o aplicados via CSS/JS em aplicarFiltrosRelatorio()
                                    // Aqui apenas constru√≠mos o HTML completo
                                    
                                    // Acumula apenas notas AUTORIZADAS para o subtotal
                                    if (nota.statusAutorizacao.isAutorizada) {
                                        subtotalGrupo += nota.vNF;
                                    }
                                    
                                    const sequenciaClass = nota.sequenciaStatus.includes('QUEBRA') ? 'quebra-indicada' : 'sem-quebra';
                                    
                                    return `
                                        <tr data-mod="${nota.mod}" 
                                            data-status="${nota.statusAutorizacao.isAutorizadaForaPrazo ? 'AUTORIZADA_FORA_PRAZO' : (nota.statusAutorizacao.isAutorizada ? 'AUTORIZADA' : 'NAO_AUTORIZADA')}"
                                            class="${nota.statusAutorizacao.class}"
                                        >
                                            <td>${nota.serie}</td>
                                            <td>${nota.nNF}</td>
                                            <td>${formatarDataHora(nota.dhEmi.toISOString())}</td>
                                            <td>${nota.cfop}</td>
                                            <td>${formasPagamento[nota.tPag] || 'Outro'}</td>
                                            <td>${formatarValor(nota.vNF)}</td>
                                            <td class="${sequenciaClass}">${nota.sequenciaStatus}</td>
                                            <td class="${nota.statusAutorizacao.class}">${nota.statusAutorizacao.text}</td>
                                            <td><button onclick="abrirDetalhesXML('${nota.chave}')" class="detail-button">Ver Detalhes</button></td> </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                html += htmlGrupo;
                totalGeral += subtotalGrupo;
            });

            if (!temGrupoVisivel) {
                relatorioContainer.innerHTML = '<p>Nenhuma nota fiscal encontrada para os filtros aplicados.</p>';
                document.getElementById('resumo-container').style.display = 'none';
                return;
            }
            
            // Adiciona o total geral (apenas AUTORIZADAS)
            html += `<div class="total-geral">Total Geral de Notas Autorizadas (R$): <span>${formatarValor(totalGeral)}</span></div>`;
            
            relatorioContainer.innerHTML = html;
            
            // Gera√ß√£o e exibi√ß√£o dos resumos e aplica√ß√£o dos filtros (que geram a busca por CNPJ tamb√©m)
            gerarResumos(notasFiscais);
            aplicarFiltrosTabela(); // Aplica os filtros Mod e Status iniciais na tabela rec√©m-gerada
        }

        // --- Gera√ß√£o de Resumos (CFOP e Pagamento) ---
        
        function gerarResumos(notas) {
            const resumoCFOP = {};
            const resumoPagamento = {};

            // NOVO: Filtrar as notas pelo CNPJ selecionado (se n√£o for 'ALL')
            const notasParaResumo = notas.filter(n => filterCNPJ.value === 'ALL' || n.cnpj === filterCNPJ.value);

            if (notasParaResumo.length === 0 && filterCNPJ.value !== 'ALL') {
                document.getElementById('resumo-container').innerHTML = `<p>Nenhuma nota fiscal encontrada para o CNPJ ${filterCNPJ.value} para gerar os resumos.</p>`;
                document.getElementById('resumo-container').style.display = 'flex';
                return;
            }

            notasParaResumo.forEach(nota => {
                // Apenas notas AUTORIZADAS (incluindo 150) para os resumos
                if (nota.statusAutorizacao.isAutorizada) {
                    // Resumo por CFOP
                    const cfopKey = nota.cfop;
                    resumoCFOP[cfopKey] = resumoCFOP[cfopKey] || { count: 0, total: 0 };
                    resumoCFOP[cfopKey].count++;
                    resumoCFOP[cfopKey].total += nota.vNF;

                    // Resumo por Forma de Pagamento
                    const pagKey = formasPagamento[nota.tPag] || 'Outros';
                    resumoPagamento[pagKey] = resumoPagamento[pagKey] || { count: 0, total: 0 };
                    resumoPagamento[pagKey].count++;
                    resumoPagamento[pagKey].total += nota.vNF;
                }
            });

            // Constr√≥i o HTML dos resumos
            let htmlCFOP = '';
            htmlCFOP += `<div class="resumo-table-container"><h4>Resumo por CFOP (Apenas Autorizadas)</h4><table><thead><tr><th>CFOP</th><th>Qtd.</th><th>Valor Total</th></tr></thead><tbody>`;
            Object.keys(resumoCFOP).sort().forEach(cfop => {
                htmlCFOP += `<tr><td>${cfop}</td><td>${resumoCFOP[cfop].count}</td><td>${formatarValor(resumoCFOP[cfop].total)}</td></tr>`;
            });
            htmlCFOP += `</tbody></table></div>`;

            let htmlPagamento = '';
            htmlPagamento += `<div class="resumo-table-container"><h4>Resumo por Forma de Pagamento (Apenas Autorizadas)</h4><table><thead><tr><th>Forma Pag.</th><th>Qtd.</th><th>Valor Total</th></tr></thead><tbody>`;
            Object.keys(resumoPagamento).sort().forEach(pag => {
                htmlPagamento += `<tr><td>${pag}</td><td>${resumoPagamento[pag].count}</td><td>${formatarValor(resumoPagamento[pag].total)}</td></tr>`;
            });
            htmlPagamento += `</tbody></table></div>`;

            document.getElementById('resumo-container').innerHTML = htmlCFOP + htmlPagamento;
            document.getElementById('resumo-container').style.display = 'flex';
        }

        // --- Fun√ß√µes de Filtragem e Busca ---

        function aplicarFiltrosRelatorio() {
            // A mudan√ßa no CNPJ/Mod/Status deve primeiro re-renderizar o HTML para garantir que o agrupamento/resumo esteja correto
            // Se o CNPJ mudar, o agrupamento de tabelas deve mudar.
            // Se o Mod/Status mudar, apenas as linhas da tabela devem ser filtradas.

            // 1. Re-gera o Relat√≥rio HTML para garantir que o agrupamento de CNPJ seja filtrado
            // Nota: Se a lista de notas globais n√£o mudou, pode-se passar gruposGlobais.
            // Para garantir a precis√£o total, chama processarNotas() se o CNPJ mudar.
            // Se as notas n√£o foram alteradas, apenas chamar gerarRelatorioHTML com os grupos globais e a nova filtragem no HTML deve ser suficiente e mais r√°pido.
            // Re-gera a parte visual (tabelas e total) com o novo CNPJ
            gerarRelatorioHTML(gruposGlobais); // Vai ignorar grupos que n√£o batem com o filterCNPJ.value

            // 2. Recalcula e exibe os resumos se o CNPJ mudar (ou outros filtros, mas o CNPJ √© o mais relevante aqui).
            gerarResumos(notasFiscais);
            
            // 3. Re-executa a filtragem da tabela (que usa o Mod e Status)
            aplicarFiltrosTabela();
        }

        function aplicarFiltrosTabela() {
            const filtroMod = filterMod.value;
            const filtroStatus = filterStatus.value;
            
            // Percorre todas as linhas de todas as tabelas (grupos)
            document.querySelectorAll('#relatorio-completo table tbody tr').forEach(row => {
                const modRow = row.getAttribute('data-mod');
                const statusRow = row.getAttribute('data-status');
                
                let showRow = true;

                // 1. Filtro de Modelo (Mod)
                if (filtroMod !== 'ALL' && modRow !== filtroMod) {
                    showRow = false;
                }
                
                // 2. Filtro de Status
                if (showRow && filtroStatus !== 'ALL') {
                    if (filtroStatus === 'AUTORIZADA' && statusRow !== 'AUTORIZADA') {
                        showRow = false;
                    } else if (filtroStatus === 'AUTORIZADA_FORA_PRAZO' && statusRow !== 'AUTORIZADA_FORA_PRAZO') {
                        showRow = false;
                    } else if (filtroStatus === 'NAO_AUTORIZADA' && (statusRow === 'AUTORIZADA' || statusRow === 'AUTORIZADA_FORA_PRAZO')) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
            
            // Oculta/Exibe a div do grupo se n√£o tiver nenhuma linha vis√≠vel
            document.querySelectorAll('#relatorio-completo > div').forEach(divGroup => {
                const table = divGroup.querySelector('table');
                if (table) {
                    const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
                    // Exibe o cabe√ßalho do grupo se o filtro de CNPJ for 'ALL'
                    // Ou se for um grupo espec√≠fico e tiver linhas vis√≠veis
                    if (filterCNPJ.value === 'ALL' || visibleRows.length > 0) {
                        divGroup.style.display = '';
                    } else {
                         divGroup.style.display = 'none';
                    }
                }
            });

            // Re-aplica a busca textual para garantir que o filtro de busca persista
            filtrarTabela();
        }

        function filtrarTabela() {
            const filtroBusca = searchInput.value.toUpperCase();
            
            // Percorre todas as linhas de todas as tabelas
            document.querySelectorAll('#relatorio-completo table tbody tr').forEach(row => {
                // Linhas j√° ocultadas pelo filtro de Mod/Status devem permanecer ocultas
                if (row.style.display === 'none') return;
                
                // Obt√©m o CNPJ do grupo (armazenado na div pai) para a busca
                const divGroup = row.closest('[id^="table-group-"]');
                const cnpjGrupo = divGroup ? divGroup.getAttribute('data-cnpj') : null;
                
                let showRow = true;

                // 3. Aplica o filtro de busca textual/CNPJ
                if (filtroBusca !== '') {
                    let matchesSearch = false;
                    // Verifica se o CNPJ do grupo corresponde ao filtro de busca
                    if (cnpjGrupo && cnpjGrupo.toUpperCase().indexOf(filtroBusca) > -1) {
                        matchesSearch = true;
                    } else {
                        // Percorre todas as c√©lulas (td) da linha
                        for (let j = 0; j < row.cells.length; j++) {
                            const td = row.cells[j];
                            if (td) {
                                const text = td.textContent || td.innerText;
                                if (text.toUpperCase().indexOf(filtroBusca) > -1) {
                                    matchesSearch = true;
                                    break;
                                }
                            }
                        }
                    }
                    // A linha s√≥ deve ser vis√≠vel se j√° estava vis√≠vel pelos filtros de Mod/Status
                    // E agora corresponde ao filtro de busca
                    showRow = matchesSearch;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
            
             // Oculta/Exibe a div do grupo se n√£o tiver nenhuma linha vis√≠vel
            document.querySelectorAll('#relatorio-completo > div').forEach(divGroup => {
                const table = divGroup.querySelector('table');
                if (table) {
                    const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
                    // Exibe o cabe√ßalho do grupo se o filtro de CNPJ for 'ALL'
                    // Ou se for um grupo espec√≠fico e tiver linhas vis√≠veis
                    if (filterCNPJ.value === 'ALL' || visibleRows.length > 0) {
                        divGroup.style.display = '';
                    } else {
                         divGroup.style.display = 'none';
                    }
                }
            });
        }
        
        function limparBusca() {
            searchInput.value = '';
            filtrarTabela(); // Re-aplica a filtragem, removendo o filtro de busca
        }

        // --- Gera√ß√£o de PDF ---

        function gerarRelatorioPDF() {
            const cnpjFiltro = filterCNPJ.value;
            const nomeFantasiaPrincipal = obterNomeFantasiaPrincipal(); // J√° considera o filtro CNPJ
            const dataAtual = new Date();
            const dataFormatada = formatarDataParaTitulo(dataAtual);
            
            // 1. Filtrar os grupos (apenas notas autorizadas entram no c√°lculo do total)
            const gruposFiltrados = Object.values(gruposGlobais).reduce((acc, grupo) => {
                // Aplica o filtro de CNPJ
                if (cnpjFiltro !== 'ALL' && grupo.info.cnpj !== cnpjFiltro) {
                    return acc;
                }
                
                // Aplica os filtros de Mod e Status na lista de notas, removendo-as
                const notasFiltradas = grupo.notas.filter(nota => {
                    const filtroMod = filterMod.value;
                    const filtroStatus = filterStatus.value;
                    const modRow = nota.mod;
                    const statusRow = nota.statusAutorizacao.isAutorizadaForaPrazo ? 'AUTORIZADA_FORA_PRAZO' : (nota.statusAutorizacao.isAutorizada ? 'AUTORIZADA' : 'NAO_AUTORIZADA');
                    
                    let keep = true;
                    
                    // Filtro de Modelo
                    if (filtroMod !== 'ALL' && modRow !== filtroMod) {
                        keep = false;
                    }
                    
                    // Filtro de Status
                    if (keep && filtroStatus !== 'ALL') {
                        if (filtroStatus === 'AUTORIZADA' && statusRow !== 'AUTORIZADA') {
                            keep = false;
                        } else if (filtroStatus === 'AUTORIZADA_FORA_PRAZO' && statusRow !== 'AUTORIZADA_FORA_PRAZO') {
                            keep = false;
                        } else if (filtroStatus === 'NAO_AUTORIZADA' && (statusRow === 'AUTORIZADA' || statusRow === 'AUTORIZADA_FORA_PRAZO')) {
                            keep = false;
                        }
                    }
                    
                    return keep;
                });
                
                if (notasFiltradas.length > 0) {
                    acc.push({ ...grupo, notas: notasFiltradas });
                }
                return acc;
            }, []);

            if (gruposFiltrados.length === 0) {
                alert(`Nenhuma nota fiscal encontrada para o CNPJ e filtros selecionados.`);
                return;
            }

            // ATUALIZA√á√ÉO: L√≥gica para o t√≠tulo do relat√≥rio
            let tituloEmpresa;
            if (cnpjFiltro === 'ALL') {
                tituloEmpresa = 'Todas as Empresas';
            } else {
                tituloEmpresa = nomeFantasiaPrincipal.replace(/_/g, ' ') + ` (CNPJ: ${cnpjFiltro})`;
            }

            const tituloRelatorio = `Relat√≥rio Fiscal da Empresa ${tituloEmpresa}, gerado em ${dataFormatada}.`;
            let htmlPDF = '<div id="relatorio-export">';
            
            // T√≠tulo no PDF
            htmlPDF += `<h1 class="pdf-report-title">${tituloRelatorio}</h1>`;
            
            // Incluir os resumos no PDF (Recalcular com base nas notas filtradas)
            let totalGeralPDF = 0;
            const resumoCFOPPDF = {};
            const resumoPagamentoPDF = {};

            gruposFiltrados.forEach(grupo => {
                grupo.notas.forEach(nota => {
                    if (nota.statusAutorizacao.isAutorizada) {
                        totalGeralPDF += nota.vNF;
                        
                        // Resumo CFOP
                        const cfopKey = nota.cfop;
                        resumoCFOPPDF[cfopKey] = resumoCFOPPDF[cfopKey] || { count: 0, total: 0 };
                        resumoCFOPPDF[cfopKey].count++;
                        resumoCFOPPDF[cfopKey].total += nota.vNF;
                        
                        // Resumo Pagamento
                        const pagKey = formasPagamento[nota.tPag] || 'Outros';
                        resumoPagamentoPDF[pagKey] = resumoPagamentoPDF[pagKey] || { count: 0, total: 0 };
                        resumoPagamentoPDF[pagKey].count++;
                        resumoPagamentoPDF[pagKey].total += nota.vNF;
                    }
                });
            });
            
            // HTML para os resumos no PDF
            let htmlResumos = '<div style="display: flex; gap: 10px; margin-bottom: 20px;">';
            
            // Tabela CFOP
            htmlResumos += '<div style="flex: 1;"><h4 style="font-size: 10pt; border-bottom: 1px solid #ccc; padding-bottom: 3px;">Resumo por CFOP (Autorizadas)</h4><table style="font-size: 8pt;"><thead><tr><th>CFOP</th><th>Qtd.</th><th>Valor Total</th></tr></thead><tbody>';
            Object.keys(resumoCFOPPDF).sort().forEach(cfop => {
                htmlResumos += `<tr><td>${cfop}</td><td>${resumoCFOPPDF[cfop].count}</td><td>${formatarValor(resumoCFOPPDF[cfop].total)}</td></tr>`;
            });
            htmlResumos += '</tbody></table></div>';
            
            // Tabela Pagamento
            htmlResumos += '<div style="flex: 1;"><h4 style="font-size: 10pt; border-bottom: 1px solid #ccc; padding-bottom: 3px;">Resumo por Forma de Pagamento (Autorizadas)</h4><table style="font-size: 8pt;"><thead><tr><th>Forma Pag.</th><th>Qtd.</th><th>Valor Total</th></tr></thead><tbody>';
            Object.keys(resumoPagamentoPDF).sort().forEach(pag => {
                htmlResumos += `<tr><td>${pag}</td><td>${resumoPagamentoPDF[pag].count}</td><td>${formatarValor(resumoPagamentoPDF[pag].total)}</td></tr>`;
            });
            htmlResumos += '</tbody></table></div>';
            
            htmlResumos += '</div>';
            htmlPDF += htmlResumos;
            
            // Adiciona o total geral do PDF
            htmlPDF += `<div class="total-geral">Total Geral de Notas Autorizadas (R$): <span>${formatarValor(totalGeralPDF)}</span></div>`;
            
            gruposFiltrados.forEach(grupo => {
                const info = grupo.info;
                const notas = grupo.notas;
                const tipoNota = info.mod === '55' ? 'NF-e' : 'NFC-e';

                // Cabe√ßalho do Grupo no PDF
                if (cnpjFiltro === 'ALL') {
                    htmlPDF += `<div class="pdf-header" style="page-break-after: avoid;">${info.emitente} | CNPJ: ${info.cnpj} | ${tipoNota} | S√©rie: ${info.serie}</div>`;
                } else {
                    htmlPDF += `<div class="pdf-header" style="page-break-after: avoid;">${info.emitente} | CNPJ: ${info.cnpj} | ${tipoNota} | S√©rie: ${info.serie}</div>`;
                }

                // Tabela com colunas otimizadas para o PDF:
                // Remo√ß√£o de Chave de Acesso, Forma Pag. e Status Sequ√™ncia
                htmlPDF += `
                    <table style="page-break-inside: avoid;">
                        <thead>
                            <tr>
                                <th>S√©rie</th>
                                <th>N√∫mero</th>
                                <th>Emiss√£o</th>
                                <th>CFOP</th>
                                <th>Valor Total</th>
                                <th>Status SEFAZ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${notas.map(nota => `
                                <tr class="${nota.statusAutorizacao.class}">
                                    <td>${nota.serie}</td>
                                    <td>${nota.nNF}</td>
                                    <td>${formatarDataHora(nota.dhEmi.toISOString())}</td>
                                    <td>${nota.cfop}</td>
                                    <td>${formatarValor(nota.vNF)}</td>
                                    <td>${nota.statusAutorizacao.text}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            });
            
            htmlPDF += '</div>';

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlPDF;
            document.body.appendChild(tempDiv);
            
            // --- NOVO FORMATO DO NOME DO ARQUIVO ---
            let nomeArquivo;
            if (cnpjFiltro === 'ALL') {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); 
                nomeArquivo = `Relatorio_Fiscal_Todos_CNPJs_${periodoEmissao}.pdf`;
            } else {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); // J√° considera o filtro CNPJ
                // NOVO: Adicionado CNPJ no nome do arquivo se o filtro for aplicado
                nomeArquivo = `Relatorio_Fiscal_${nomeFantasiaPrincipal}_${periodoEmissao}_${cnpjFiltro}.pdf`;
            }
            
            // Configura√ß√µes do PDF para garantir que o conte√∫do caiba
            const opt = {
                margin: 10,
                filename: nomeArquivo,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } // Mantido A4 Portrait, mas otimizado com CSS
            };

            html2pdf().set(opt).from(tempDiv).save().then(() => {
                 // Remove a div tempor√°ria ap√≥s a gera√ß√£o
                document.body.removeChild(tempDiv);
            });
        }
        
        // --- Fun√ß√µes de Download de XML (ZIP) ---
        
        function compactarEBaixarXML(tipo) {
            const modFilter = tipo === 'NFE' ? '55' : '65';
            const cnpjFilter = filterCNPJ.value;
            
            // 1. Filtra os arquivos XML brutos
            const arquivosFiltrados = arquivosXML.filter(arq => {
                const nota = notasFiscais.find(n => n.chave === arq.chave);
                let matchesCNPJ = true;
                
                // Se a nota for diferente
                if (cnpjFilter !== 'ALL' && nota && nota.cnpj !== cnpjFilter) {
                    matchesCNPJ = false;
                }
                
                // Se n√£o encontrou a nota correspondente mas o CNPJ est√° filtrado, deve ser ignorado.
                if (cnpjFilter !== 'ALL' && !nota) {
                    // Tenta extrair o CNPJ do XML bruto, se n√£o encontrou no cache de notasFiscais
                    const cnpjMatch = arq.content.match(/<CNPJ>(\d+)<\/CNPJ>/);
                    if (cnpjMatch && cnpjMatch[1] !== cnpjFilter) {
                        matchesCNPJ = false;
                    }
                }

                return arq.mod === modFilter && matchesCNPJ;
            });

            if (arquivosFiltrados.length === 0) {
                const cnpjText = cnpjFilter !== 'ALL' ? ` para o CNPJ ${cnpjFilter}` : '';
                alert(`Nenhum arquivo XML do tipo ${tipo}${cnpjText} foi encontrado.`);
                return;
            }

            // 2. Cria o ZIP
            const zip = new JSZip();
            const pasta = zip.folder(tipo); // Cria pasta com o tipo da nota

            arquivosFiltrados.forEach(arq => {
                // Usa o nome original do arquivo ou a chave + .xml
                const nomeArquivo = arq.fileName || `${arq.chave}.xml`;
                pasta.file(nomeArquivo, arq.content);
            });

            // ATUALIZA√á√ÉO: Condicional para o nome do arquivo
            let nomeArquivoZip;
            if (cnpjFilter === 'ALL') {
                const periodoEmissao = obterPeriodoEmissaoPrincipal();
                nomeArquivoZip = `xml-${tipo}-Todos-CNPJs-${periodoEmissao}.zip`;
            } else {
                const periodoEmissao = obterPeriodoEmissaoPrincipal(); // J√° considera o filtro CNPJ
                const nomeFantasiaPrincipal = obterNomeFantasiaPrincipal();
                // NOVO: Adicionado CNPJ no nome do arquivo se o filtro for aplicado
                nomeArquivoZip = `xml-${tipo}-${nomeFantasiaPrincipal}-${periodoEmissao}-${cnpjFilter}.zip`;
            }

            // 3. Gera e Baixa
            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(content);
                    a.download = nomeArquivoZip;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                });
        }
        
        
    </script>
</body>
</html>
